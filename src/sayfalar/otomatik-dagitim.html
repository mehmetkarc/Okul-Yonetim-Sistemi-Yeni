<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Otomatik Ders Daƒüƒ±tƒ±mƒ± - AI Powered v4.0</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #0a0e27;
        color: #e0e0e0;
        overflow-x: hidden;
      }

      /* ============================================ */
      /* HEADER */
      /* ============================================ */
      .header {
        background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%);
        border-bottom: 2px solid #00d9ff;
        padding: 20px 30px;
        box-shadow: 0 4px 20px rgba(0, 217, 255, 0.2);
      }
      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .header-logo {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #00d9ff 0%, #7b2fff 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(0, 217, 255, 0.4);
      }
      .header-title h1 {
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(90deg, #00d9ff 0%, #7b2fff 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .header-title p {
        font-size: 12px;
        color: #888;
        margin-top: 4px;
      }
      .header-actions {
        display: flex;
        gap: 12px;
      }

      /* ============================================ */
      /* STATS CARDS */
      /* ============================================ */
      .header-stats {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(0, 217, 255, 0.2);
        margin-bottom: 16px;
      }
      .stat-item {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .stat-icon {
        width: 40px;
        height: 40px;
        background: rgba(0, 217, 255, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      .stat-content {
        flex: 1;
      }
      .stat-label {
        font-size: 11px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: #00d9ff;
        margin-top: 2px;
      }
      .stat-subtext {
        font-size: 10px;
        color: #666;
        margin-top: 2px;
      }

      /* ============================================ */
      /* QUICK ACTIONS BAR */
      /* ============================================ */
      .header-quick-actions {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: rgba(0, 217, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(0, 217, 255, 0.2);
      }

      /* ============================================ */
      /* BUTTONS */
      /* ============================================ */
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn-primary {
        background: linear-gradient(135deg, #00f5a0 0%, #00d9ff 100%);
        color: #0a0e27;
        box-shadow: 0 4px 12px rgba(0, 245, 160, 0.3);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 245, 160, 0.5);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .btn-large {
        padding: 14px 32px;
        font-size: 16px;
        flex: 1;
        justify-content: center;
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
      }
      .btn-danger {
        background: rgba(244, 67, 54, 0.2);
        color: #ff6b6b;
        border: 2px solid rgba(244, 67, 54, 0.3);
      }
      .btn-danger:hover {
        background: rgba(244, 67, 54, 0.3);
        border-color: rgba(244, 67, 54, 0.5);
      }
      .btn-small {
        padding: 6px 12px;
        font-size: 11px;
      }

      /* ============================================ */
      /* CONTAINER */
      /* ============================================ */
      .container {
        display: grid;
        grid-template-columns: 320px 1fr 380px;
        gap: 20px;
        padding: 20px;
        max-width: 1800px;
        margin: 0 auto;
        min-height: calc(100vh - 280px);
      }

      /* ============================================ */
      /* PANEL */
      /* ============================================ */
      .panel {
        background: rgba(26, 31, 58, 0.8);
        border: 1px solid rgba(0, 217, 255, 0.2);
        border-radius: 16px;
        padding: 24px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid rgba(0, 217, 255, 0.2);
      }
      .panel-title {
        font-size: 18px;
        font-weight: 700;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .panel-icon {
        font-size: 24px;
      }

      /* ============================================ */
      /* CONTROL SECTION */
      /* ============================================ */
      .control-section {
        margin-bottom: 24px;
      }
      .control-section-title {
        font-size: 13px;
        font-weight: 700;
        color: #00d9ff;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Modal Tab Sistemi */
      .modal-tabs-container {
        margin: 0;
        padding: 0;
      }

      .modal-tabs {
        display: flex;
        gap: 0;
        margin: 0;
        padding: 0;
      }

      .modal-tab {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        color: #888;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .modal-tab:hover {
        color: #00d9ff;
        background: rgba(0, 217, 255, 0.05);
      }

      .modal-tab.active {
        color: #00d9ff;
        border-bottom-color: #00d9ff;
        background: rgba(0, 217, 255, 0.1);
      }

      .modal-tab-content {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* √ñƒüretmen Checkbox Listesi */
      .teacher-checkbox-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
      }

      .teacher-checkbox-list::-webkit-scrollbar {
        width: 8px;
      }

      .teacher-checkbox-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }

      .teacher-checkbox-list::-webkit-scrollbar-thumb {
        background: rgba(0, 217, 255, 0.3);
        border-radius: 4px;
      }

      .teacher-checkbox-list::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 217, 255, 0.5);
      }

      .teacher-checkbox-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        transition: all 0.2s;
        cursor: pointer;
        border: 1px solid transparent;
      }

      .teacher-checkbox-item:hover {
        background: rgba(0, 217, 255, 0.1);
        border-color: rgba(0, 217, 255, 0.3);
        transform: translateX(5px);
      }

      .teacher-checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #00d9ff;
        flex-shrink: 0;
      }

      .teacher-checkbox-item label {
        flex: 1;
        cursor: pointer;
        color: #fff;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .teacher-checkbox-item .teacher-branch {
        color: #888;
        font-size: 11px;
        padding: 2px 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }

      .teacher-checkbox-item input[type="checkbox"]:checked + label {
        color: #00f5a0;
        font-weight: 500;
      }

      .teacher-checkbox-item
        input[type="checkbox"]:checked
        + label
        .teacher-branch {
        color: #00f5a0;
        background: rgba(0, 245, 160, 0.2);
      }

      /* ============================================ */
      /* KISIT TABLOSU */
      /* ============================================ */
      .constraint-table-container {
        overflow-x: auto;
        margin-top: 20px;
      }

      .constraint-schedule-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        overflow: hidden;
      }

      .constraint-schedule-table th {
        background: linear-gradient(135deg, #00d9ff, #7b2fff);
        color: #fff;
        padding: 12px 8px;
        text-align: center;
        font-size: 13px;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .constraint-schedule-table td {
        padding: 0;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        height: 50px;
      }

      .constraint-schedule-table td.hour-label {
        background: rgba(0, 217, 255, 0.2);
        color: #00d9ff;
        font-weight: 600;
        font-size: 12px;
        width: 60px;
      }

      .constraint-cell {
        width: 100%;
        height: 100%;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        background: rgba(255, 255, 255, 0.03);
        position: relative;
      }

      .constraint-cell:hover {
        background: rgba(0, 217, 255, 0.1);
        transform: scale(1.05);
      }

      .constraint-cell.blocked {
        background: linear-gradient(
          135deg,
          rgba(255, 107, 107, 0.3),
          rgba(255, 107, 107, 0.5)
        );
        border: 2px solid #ff6b6b;
      }

      .constraint-cell.blocked::before {
        content: "üö´";
        font-size: 24px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .constraint-cell.blocked:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 107, 107, 0.5),
          rgba(255, 107, 107, 0.7)
        );
        transform: scale(1.08);
      }

      .constraint-info-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: rgba(0, 217, 255, 0.1);
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid rgba(0, 217, 255, 0.3);
      }

      .constraint-info-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .constraint-info-label {
        font-size: 12px;
        color: #888;
      }

      .constraint-info-value {
        font-size: 16px;
        font-weight: 600;
        color: #00d9ff;
      }

      .constraint-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .teacher-item-constraints {
        padding: 12px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .teacher-item-constraints:hover {
        background: rgba(0, 217, 255, 0.1);
        border-color: rgba(0, 217, 255, 0.5);
        transform: translateX(5px);
      }

      .teacher-item-constraints.active {
        background: linear-gradient(
          135deg,
          rgba(0, 217, 255, 0.2),
          rgba(123, 47, 255, 0.2)
        );
        border-color: #00d9ff;
      }

      .teacher-item-constraints .teacher-name {
        font-size: 13px;
        color: #fff;
        font-weight: 500;
      }

      .teacher-item-constraints .teacher-branch {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
      }

      .teacher-item-constraints .constraint-count {
        background: #ff6b6b;
        color: #fff;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      .teacher-item-preferences {
        padding: 12px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .teacher-item-preferences:hover {
        background: rgba(0, 245, 160, 0.1);
        border-color: rgba(0, 245, 160, 0.5);
        transform: translateX(5px);
      }

      .teacher-item-preferences.active {
        background: linear-gradient(
          135deg,
          rgba(0, 245, 160, 0.2),
          rgba(0, 217, 255, 0.2)
        );
        border-color: #00f5a0;
      }

      .preference-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
      }

      /* ============================================ */
      /* TOGGLE SWITCH */
      /* ============================================ */
      .toggle-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .toggle-label {
        font-size: 13px;
        color: #e0e0e0;
        font-weight: 600;
      }
      .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .toggle-switch.active {
        background: linear-gradient(135deg, #00f5a0 0%, #00d9ff 100%);
      }
      .toggle-knob {
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .toggle-switch.active .toggle-knob {
        left: 26px;
      }

      /* ============================================ */
      /* ALGORITHM GRID */
      /* ============================================ */
      .algoritma-grid {
        display: grid;
        gap: 8px;
      }
      .algoritma-item {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(123, 47, 255, 0.3);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .algoritma-item:hover {
        background: rgba(123, 47, 255, 0.1);
        border-color: #7b2fff;
      }

      /* ============================================ */
      /* SLIDER */
      /* ============================================ */
      .slider-container {
        margin-top: 16px;
      }
      .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 12px;
        color: #888;
      }
      .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        outline: none;
        cursor: pointer;
      }
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #00d9ff 0%, #7b2fff 100%);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 217, 255, 0.5);
      }
      .slider-value {
        text-align: center;
        margin-top: 8px;
        font-size: 13px;
        font-weight: 600;
        color: #00d9ff;
      }

      /* ============================================ */
      /* LIVE CONTAINER */
      /* ============================================ */
      .live-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* ============================================ */
      /* FITNESS DISPLAY */
      /* ============================================ */
      .fitness-display {
        background: linear-gradient(
          135deg,
          rgba(0, 217, 255, 0.1) 0%,
          rgba(123, 47, 255, 0.1) 100%
        );
        border: 2px solid rgba(0, 217, 255, 0.3);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
      }
      .fitness-label {
        font-size: 14px;
        color: #888;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .fitness-value {
        font-size: 64px;
        font-weight: 900;
        line-height: 1;
      }
      .fitness-value.low {
        background: linear-gradient(90deg, #ff4444 0%, #ff6666 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .fitness-value.medium {
        background: linear-gradient(90deg, #ffbb33 0%, #ffd666 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .fitness-value.high {
        background: linear-gradient(90deg, #00f5a0 0%, #00d9ff 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .fitness-max {
        font-size: 18px;
        color: #666;
        margin-top: 8px;
      }

      /* ============================================ */
      /* ALGORITHM CARDS */
      /* ============================================ */
      .algorithm-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .algorithm-card {
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(0, 217, 255, 0.2);
        border-radius: 12px;
        padding: 16px;
        transition: all 0.3s;
      }
      .algorithm-card.active {
        background: rgba(0, 217, 255, 0.1);
        border-color: #00d9ff;
        box-shadow: 0 4px 16px rgba(0, 217, 255, 0.3);
      }
      .algorithm-card.completed {
        background: rgba(0, 245, 160, 0.1);
        border-color: #00f5a0;
      }
      .algorithm-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .algorithm-name {
        font-size: 13px;
        font-weight: 700;
        color: #e0e0e0;
      }
      .algorithm-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #666;
      }
      .algorithm-card.active .algorithm-status {
        background: #00d9ff;
        box-shadow: 0 0 12px #00d9ff;
        animation: pulse 1.5s infinite;
      }
      .algorithm-card.completed .algorithm-status {
        background: #00f5a0;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .algorithm-progress {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 8px;
      }
      .algorithm-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #00d9ff 0%, #7b2fff 100%);
        transition: width 0.3s;
        width: 0%;
      }
      .algorithm-score {
        font-size: 12px;
        color: #888;
      }
      .algorithm-score span {
        color: #00d9ff;
        font-weight: 700;
      }

      /* ============================================ */
      /* CONFLICT MAP */
      /* ============================================ */
      .conflict-map {
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(244, 67, 54, 0.3);
        border-radius: 12px;
        padding: 16px;
      }
      .conflict-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .conflict-item:last-child {
        border-bottom: none;
      }
      .conflict-label {
        font-size: 13px;
        color: #e0e0e0;
      }
      .conflict-count {
        font-size: 14px;
        font-weight: 700;
        color: #ff6b6b;
      }
      .conflict-count.zero {
        color: #00f5a0;
      }

      /* ============================================ */
      /* SOLUTION CARD */
      /* ============================================ */
      .solution-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(0, 217, 255, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .solution-card:hover {
        background: rgba(0, 217, 255, 0.1);
        border-color: #00d9ff;
        transform: translateX(4px);
      }
      .solution-card.best {
        border-color: #00f5a0;
        background: rgba(0, 245, 160, 0.1);
      }
      .solution-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .solution-rank {
        font-size: 12px;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
      }
      .solution-card.best .solution-rank {
        background: linear-gradient(135deg, #00f5a0 0%, #00d9ff 100%);
        color: #0a0e27;
      }
      .solution-score {
        font-size: 24px;
        font-weight: 900;
        color: #00d9ff;
      }
      .solution-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 12px;
      }
      .metric-item {
        font-size: 11px;
        color: #888;
        background: rgba(255, 255, 255, 0.03);
        padding: 6px 8px;
        border-radius: 6px;
      }
      .metric-item span {
        color: #e0e0e0;
        font-weight: 600;
        display: block;
        margin-top: 2px;
        font-size: 13px;
      }
      .solution-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      /* ============================================ */
      /* SAVED PROGRAMS */
      /* ============================================ */
      .saved-program-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(0, 217, 255, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
      }
      .saved-program-card:hover {
        background: rgba(0, 217, 255, 0.1);
        border-color: #00d9ff;
        transform: translateX(4px);
      }
      .saved-program-card.active {
        border-color: #00f5a0;
        background: rgba(0, 245, 160, 0.15);
        box-shadow: 0 0 20px rgba(0, 245, 160, 0.3);
      }
      .saved-program-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .saved-program-name {
        font-size: 14px;
        font-weight: 700;
        color: #00d9ff;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .saved-program-name .active-badge {
        font-size: 18px;
      }
      .saved-program-date {
        font-size: 11px;
        color: #888;
      }
      .saved-program-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 12px;
      }
      .saved-program-stat {
        font-size: 11px;
        color: #888;
        background: rgba(255, 255, 255, 0.03);
        padding: 6px 8px;
        border-radius: 6px;
      }
      .saved-program-stat span {
        color: #e0e0e0;
        font-weight: 600;
        display: block;
        margin-top: 2px;
        font-size: 13px;
      }
      .saved-program-actions {
        display: flex;
        gap: 8px;
      }

      /* ============================================ */
      /* EMPTY STATE */
      /* ============================================ */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
      }
      .empty-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      .empty-title {
        font-size: 18px;
        font-weight: 700;
        color: #e0e0e0;
        margin-bottom: 8px;
      }
      .empty-text {
        font-size: 14px;
        color: #888;
      }

      /* ============================================ */
      /* MODAL */
      /* ============================================ */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        backdrop-filter: blur(12px);
      }
      .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background: #1a1f3a;
        border: 2px solid #00d9ff;
        border-radius: 16px;
        max-width: 90%;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 0 50px rgba(0, 217, 255, 0.5);
        position: relative;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        padding: 20px 30px;
        border-bottom: 2px solid rgba(0, 217, 255, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-title {
        font-size: 24px;
        color: #00d9ff;
        font-weight: 700;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 36px;
        color: #ff6b6b;
        cursor: pointer;
        transition: all 0.3s;
      }
      .modal-close:hover {
        transform: scale(1.1);
      }
      .modal-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
      }

      /* ============================================ */
      /* PROGRAM MODAL */
      /* ============================================ */
      .program-layout {
        display: flex;
        gap: 20px;
        height: calc(95vh - 100px);
      }
      .program-sidebar {
        width: 280px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        flex-shrink: 0;
      }
      .sidebar-section {
        margin-bottom: 20px;
      }
      .sidebar-title {
        font-size: 14px;
        font-weight: bold;
        color: #00d9ff;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid rgba(0, 217, 255, 0.3);
      }
      .sidebar-item {
        padding: 10px;
        background: rgba(0, 217, 255, 0.1);
        border-radius: 8px;
        margin-bottom: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 13px;
        border: 1px solid transparent;
      }
      .sidebar-item:hover {
        background: rgba(0, 217, 255, 0.2);
        border-color: #00d9ff;
        transform: translateX(3px);
      }
      .sidebar-item.active {
        background: #00d9ff;
        color: #0a0e27;
        font-weight: bold;
      }
      .program-main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .program-title {
        font-size: 20px;
        color: #00d9ff;
        margin-bottom: 15px;
        text-align: center;
        font-weight: 700;
      }
      .program-table-container {
        overflow: auto;
        border: 2px solid #00d9ff;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.3);
        flex: 1;
      }
      .program-table {
        width: 100%;
        border-collapse: collapse;
      }
      .program-table th,
      .program-table td {
        border: 1px solid #00d9ff;
        padding: 12px;
        text-align: center;
        font-size: 13px;
        min-width: 120px;
      }
      .program-table th {
        background: linear-gradient(135deg, #00d9ff, #7b2fff);
        color: white;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .program-table .hour-header {
        background: #1a1f3a;
        color: #00d9ff;
        font-weight: bold;
        position: sticky;
        left: 0;
        z-index: 5;
      }
      .lesson-cell {
        background: rgba(0, 217, 255, 0.12);
        vertical-align: top;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
      }
      .lesson-cell:hover {
        background: rgba(0, 217, 255, 0.3);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 217, 255, 0.4);
        z-index: 100;
      }
      .lesson-cell.locked {
        border: 3px solid #00f5a0 !important;
        box-shadow: 0 0 12px rgba(0, 245, 160, 0.5) !important;
      }
      .lesson-name {
        font-weight: 700;
        color: #0a0e27;
        font-size: 14px;
        margin-bottom: 4px;
      }
      .lesson-teacher {
        font-size: 12px;
        color: #333;
      }
      .lesson-block {
        font-size: 10px;
        color: #e91e63;
        margin-top: 4px;
        font-weight: 600;
      }
      .empty-cell {
        background: rgba(255, 255, 255, 0.02);
        color: #555;
      }
      .lock-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.3s;
        z-index: 10;
      }
      .lock-btn:hover {
        background: rgba(0, 0, 0, 0.5);
        transform: scale(1.15);
      }
      .lock-btn.locked {
        background: #00f5a0;
        color: #0a0e27;
        font-weight: bold;
      }
      .swap-btn {
        position: absolute;
        top: 4px;
        left: 4px;
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        background: rgba(123, 47, 255, 0.5);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.3s;
        z-index: 10;
      }
      .swap-btn:hover {
        background: rgba(123, 47, 255, 0.8);
        transform: scale(1.15);
      }

      /* ============================================ */
      /* SUCCESS MODAL */
      /* ============================================ */
      .success-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }
      .success-modal {
        background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%);
        border: 3px solid #00f5a0;
        border-radius: 20px;
        padding: 50px;
        box-shadow: 0 0 100px rgba(0, 245, 160, 0.5);
        text-align: center;
        min-width: 550px;
        animation: successPop 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes successPop {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .success-icon {
        font-size: 100px;
        margin-bottom: 30px;
        animation: successBounce 1s infinite;
      }
      @keyframes successBounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
        }
      }
      .success-title {
        font-size: 36px;
        font-weight: 900;
        background: linear-gradient(90deg, #00f5a0, #00d9ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
      }
      .success-text {
        font-size: 18px;
        color: #888;
        margin-bottom: 40px;
        line-height: 1.6;
      }
      .success-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 40px;
      }
      .success-stat {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(0, 217, 255, 0.3);
      }
      .success-stat-label {
        font-size: 12px;
        color: #888;
        margin-bottom: 8px;
      }
      .success-stat-value {
        font-size: 32px;
        font-weight: 900;
        color: #00d9ff;
      }

      /* ============================================ */
      /* CHANGES MODAL */
      /* ============================================ */
      .changes-list {
        max-height: 450px;
        overflow-y: auto;
        margin: 20px 0;
      }
      .change-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 217, 255, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
      }
      .change-teacher {
        font-size: 18px;
        font-weight: 700;
        color: #00d9ff;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .change-details {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 15px;
        align-items: center;
      }
      .change-before,
      .change-after {
        background: rgba(255, 255, 255, 0.03);
        padding: 15px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.6;
      }
      .change-before strong,
      .change-after strong {
        color: #00d9ff;
        display: block;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .change-arrow {
        font-size: 32px;
        color: #00f5a0;
      }

      /* ============================================ */
      /* BACKGROUND EFFECTS */
      /* ============================================ */
      .bg-grid {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            rgba(0, 217, 255, 0.05) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 217, 255, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
        pointer-events: none;
        z-index: -1;
      }
      .bg-orbs {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -2;
        overflow: hidden;
      }
      .orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(60px);
        opacity: 0.3;
      }
      .orb-1 {
        width: 400px;
        height: 400px;
        background: #00d9ff;
        top: -200px;
        right: -200px;
        animation: float 20s infinite;
      }
      .orb-2 {
        width: 300px;
        height: 300px;
        background: #7b2fff;
        bottom: -150px;
        left: -150px;
        animation: float 15s infinite reverse;
      }
      .orb-3 {
        width: 250px;
        height: 250px;
        background: #00f5a0;
        top: 50%;
        left: 50%;
        animation: float 25s infinite;
      }
      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0);
        }
        25% {
          transform: translate(50px, -50px);
        }
        50% {
          transform: translate(-30px, 30px);
        }
        75% {
          transform: translate(30px, 50px);
        }
      }

      /* ============================================ */
      /* FADE IN ANIMATION */
      /* ============================================ */
      .fade-in {
        animation: fadeIn 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div class="bg-grid"></div>
    <div class="bg-orbs">
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
      <div class="orb orb-3"></div>
    </div>

    <!-- ============================================ -->
    <!-- HEADER -->
    <!-- ============================================ -->
    <header class="header">
      <div class="header-top">
        <div class="header-left">
          <div class="header-logo">ü§ñ</div>
          <div class="header-title">
            <h1>üáπüá∑ T√ºrkiye'nin ƒ∞lk Yapay Zeka Destekli Ders Daƒüƒ±tƒ±m Sistemi</h1>
            <p>
              AI-Powered Schedule Optimization - 45+ Algorithm Hybrid System
              v4.0
            </p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-danger" id="btnIptal" style="display: none">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Durdur
          </button>
          <button class="btn btn-secondary" id="btnGeriDon">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Program Olu≈ütur'a D√∂n
          </button>
          <button
            class="btn btn-secondary"
            onclick="window.location.href='anasayfa.html'"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Anasayfa
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="header-stats">
        <div class="stat-item">
          <div class="stat-icon">üìã</div>
          <div class="stat-content">
            <div class="stat-label">Program Adƒ±</div>
            <div class="stat-value" id="programAdi">Y√ºkleniyor...</div>
            <div class="stat-subtext" id="programDurum">
              Veriler Hazƒ±rlanƒ±yor
            </div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">üè´</div>
          <div class="stat-content">
            <div class="stat-label">Toplam Sƒ±nƒ±f</div>
            <div class="stat-value" id="toplamSinif">0</div>
            <div class="stat-subtext">sƒ±nƒ±f tespit edildi</div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">üë®‚Äçüè´</div>
          <div class="stat-content">
            <div class="stat-label">Toplam √ñƒüretmen</div>
            <div class="stat-value" id="toplamOgretmen">0</div>
            <div class="stat-subtext">√∂ƒüretmen aktif</div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">üìö</div>
          <div class="stat-content">
            <div class="stat-label">Toplam Ders</div>
            <div class="stat-value" id="toplamDers">0</div>
            <div class="stat-subtext">ders tanƒ±mlƒ±</div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">‚è∞</div>
          <div class="stat-content">
            <div class="stat-label">Toplam Saat</div>
            <div class="stat-value" id="toplamSaat">0</div>
            <div class="stat-subtext">saat hesaplandƒ±</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions Bar -->
      <div class="header-quick-actions">
        <button class="btn btn-primary btn-large" id="btnKisitlar">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="9" x2="15" y2="15"></line>
            <line x1="15" y1="9" x2="9" y2="15"></line>
          </svg>
          üìè Kƒ±sƒ±tlar
        </button>
        <button class="btn btn-primary btn-large" id="btnTercihler">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
            ></path>
          </svg>
          üí° Tercihler
        </button>
        <button class="btn btn-primary btn-large" id="btnGenelAyarlar">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M12 1v6m0 6v6m8.66-15.66l-3.46 3.46m-10.4 10.4l-3.46 3.46m0-21.32l3.46 3.46m10.4 10.4l3.46 3.46"
            ></path>
          </svg>
          ‚öôÔ∏è Genel Ayarlar
        </button>
        <button class="btn btn-primary btn-large" id="btnDersAtamaKontrol">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="9 11 12 14 22 4"></polyline>
            <path
              d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
            ></path>
          </svg>
          ‚úÖ Ders Atama Kontrol
        </button>
        <button class="btn btn-primary btn-large" id="btnManuelYerlestirme">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
            ></path>
            <path
              d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
            ></path>
          </svg>
          üìù Manuel Yerle≈ütirme
        </button>
      </div>

      <!-- Daƒüƒ±tƒ±m Kontrol Butonlarƒ± -->
      <div class="header-quick-actions" style="margin-top: 12px">
        <button class="btn btn-primary btn-large" id="btnBaslat">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
          </svg>
          üöÄ AI Daƒüƒ±tƒ±mƒ±nƒ± Ba≈ülat
        </button>

        <button
          class="btn btn-primary btn-large"
          id="btnYenidenDagit"
          style="display: none"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          üîÑ Yeniden Daƒüƒ±t
        </button>

        <button
          class="btn btn-primary btn-large"
          onclick="dersProgramiRaporlariAc()"
          title="Ders Programƒ± Raporlarƒ±"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
            />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <polyline points="10 9 9 9 8 9" />
          </svg>
          <span>üìä Raporlar</span>
        </button>

        <button class="btn btn-secondary btn-large" id="btnAyarlariKaydet">
          üíæ Ayarlarƒ± Kaydet
        </button>

        <button class="btn btn-secondary btn-large" id="btnAyarlariYukle">
          üìÇ Ayarlarƒ± Y√ºkle
        </button>

        <button
          class="btn btn-danger btn-large"
          id="btnTemizle"
          style="display: none"
        >
          üóëÔ∏è Daƒüƒ±tƒ±mƒ± Temizle
        </button>
      </div>
    </header>
    <!-- ============================================ -->
    <!-- MAIN CONTAINER -->
    <!-- ============================================ -->
    <div class="container">
      <!-- ============================================ -->
      <!-- SOL PANEL: KONTROL PANELƒ∞ -->
      <!-- ============================================ -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <span class="panel-icon">‚öôÔ∏è</span> KONTROL PANELƒ∞
          </div>
        </div>

        <!-- Akƒ±llƒ± √ñzellikler -->
        <div class="control-section">
          <div class="control-section-title">üß† Akƒ±llƒ± √ñzellikler</div>
          <div class="toggle-container">
            <div class="toggle-label">üìè Kƒ±sƒ±tlarƒ± Kullan</div>
            <div class="toggle-switch active" id="toggle-kisit">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="toggle-container">
            <div class="toggle-label">üí° √ñƒüretmen Tercihlerini Kullan</div>
            <div class="toggle-switch active" id="toggle-tercih">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="toggle-container">
            <div class="toggle-label">
              üß© Blok Dersleri Farklƒ± G√ºnlere Daƒüƒ±t
            </div>
            <div class="toggle-switch active" id="toggle-blok">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="toggle-container">
            <div class="toggle-label">üìä Bo≈ü Pencereleri Minimize Et</div>
            <div class="toggle-switch active" id="toggle-bospencere">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="toggle-container">
            <div class="toggle-label">‚öñÔ∏è G√ºnl√ºk Y√ºk√º Dengele</div>
            <div class="toggle-switch active" id="toggle-denge">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="toggle-container">
            <div class="toggle-label">üîí Kilitlenen Dersleri Koru</div>
            <div class="toggle-switch active" id="toggle-lock">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="toggle-container">
            <div class="toggle-label">üéØ Adalet Algoritmasƒ±nƒ± Kullan</div>
            <div class="toggle-switch active" id="toggle-fairness">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="toggle-container">
            <div class="toggle-label">üßÆ √áok √á√∂z√ºml√º Mod (5 Variant)</div>
            <div class="toggle-switch active" id="toggle-variants">
              <div class="toggle-knob"></div>
            </div>
          </div>
        </div>

        <!-- Algoritma Se√ßimi -->
        <div class="control-section">
          <div class="control-section-title">
            üß¨ Hibrit Algoritma Motoru (6 Ana)
          </div>
          <div class="algoritma-grid">
            <div class="algoritma-item">
              <input type="checkbox" id="algo-ga" checked />
              <label for="algo-ga">üß¨ Genetik Algoritma (GA)</label>
            </div>
            <div class="algoritma-item">
              <input type="checkbox" id="algo-aco" checked />
              <label for="algo-aco">üêú Karƒ±nca Kolonisi (ACO)</label>
            </div>
            <div class="algoritma-item">
              <input type="checkbox" id="algo-sa" checked />
              <label for="algo-sa">üî• Tavlama Benzetimi (SA)</label>
            </div>
            <div class="algoritma-item">
              <input type="checkbox" id="algo-tabu" checked />
              <label for="algo-tabu">üö´ Tabu Arama</label>
            </div>
            <div class="algoritma-item">
              <input type="checkbox" id="algo-rl" checked />
              <label for="algo-rl">üéÆ Peki≈ütirmeli √ñƒürenme (RL)</label>
            </div>
            <div class="algoritma-item">
              <input type="checkbox" id="algo-fuzzy" checked />
              <label for="algo-fuzzy">‚òÅÔ∏è Bulanƒ±k Mantƒ±k (Fuzzy)</label>
            </div>
          </div>
          <div
            style="
              margin-top: 12px;
              padding: 10px;
              background: rgba(0, 245, 160, 0.1);
              border-radius: 8px;
              border: 1px solid rgba(0, 245, 160, 0.3);
            "
          >
            <div style="font-size: 11px; color: #00f5a0; font-weight: 600">
              ‚úÖ 45+ Mod√ºl Aktif:
            </div>
            <div style="font-size: 10px; color: #888; margin-top: 4px">
              Pattern Memory, Meta Controller, Fairness Engine, Block System (5
              mod√ºl), Parallel Solver, Weighted Constraints, Conflict Detector,
              Distribution Analyzer, Solution Stabilizer, Swap Engine, ve 30+
              yardƒ±mcƒ± mod√ºl
            </div>
          </div>
        </div>

        <!-- Hƒ±z/Kalite Dengesi -->
        <div class="control-section">
          <div class="control-section-title">‚öñÔ∏è Performans Profili</div>
          <div class="slider-container">
            <div class="slider-label">
              <span>‚ö° Hƒ±zlƒ±</span><span>üèÜ Kaliteli</span>
            </div>
            <input
              type="range"
              class="slider"
              id="speedSlider"
              min="1"
              max="5"
              value="3"
            />
            <div class="slider-value" id="speedValue">‚öñÔ∏è Dengeli Mod</div>
          </div>
          <div
            style="
              margin-top: 12px;
              font-size: 11px;
              color: #888;
              text-align: center;
            "
          >
            <span id="speedDescription">Orta hƒ±z ve kalite dengesi</span>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- ORTA PANEL: CANLI ƒ∞ZLEME -->
      <!-- ============================================ -->
      <div class="live-container">
        <!-- Fitness Display -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <span class="panel-icon">üìä</span> CANLI PERFORMANS ƒ∞ZLEME
            </div>
          </div>
          <div class="fitness-display">
            <div class="fitness-label">‚≠ê Fitness Score</div>
            <div class="fitness-value low" id="fitnessValue">0</div>
            <div class="fitness-max">/ 1000 (Maksimum)</div>
          </div>
          <div
            style="
              margin-top: 16px;
              padding: 12px;
              background: rgba(255, 255, 255, 0.05);
              border-radius: 8px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
              "
            >
              <span style="font-size: 12px; color: #888">ƒ∞terasyon:</span>
              <span
                style="font-size: 14px; font-weight: 700; color: #00d9ff"
                id="iterationCount"
                >0</span
              >
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
              "
            >
              <span style="font-size: 12px; color: #888">Ge√ßen S√ºre:</span>
              <span
                style="font-size: 14px; font-weight: 700; color: #00f5a0"
                id="elapsedTime"
                >00:00</span
              >
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span style="font-size: 12px; color: #888">Aktif Algoritma:</span>
              <span
                style="font-size: 14px; font-weight: 700; color: #7b2fff"
                id="activeAlgorithm"
                >-</span
              >
            </div>
          </div>
        </div>

        <!-- Algorithm Cards -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <span class="panel-icon">ü§ñ</span> ALGORƒ∞TMA DURUMLARI
            </div>
          </div>
          <div class="algorithm-cards">
            <div class="algorithm-card" data-algo="genetic">
              <div class="algorithm-card-header">
                <span class="algorithm-name">üß¨ Genetik</span>
                <span class="algorithm-status"></span>
              </div>
              <div class="algorithm-progress">
                <div class="algorithm-progress-bar"></div>
              </div>
              <div class="algorithm-score">Skor: <span>0</span></div>
            </div>
            <div class="algorithm-card" data-algo="aco">
              <div class="algorithm-card-header">
                <span class="algorithm-name">üêú Karƒ±nca</span>
                <span class="algorithm-status"></span>
              </div>
              <div class="algorithm-progress">
                <div class="algorithm-progress-bar"></div>
              </div>
              <div class="algorithm-score">Skor: <span>0</span></div>
            </div>
            <div class="algorithm-card" data-algo="sa">
              <div class="algorithm-card-header">
                <span class="algorithm-name">üî• Tavlama</span>
                <span class="algorithm-status"></span>
              </div>
              <div class="algorithm-progress">
                <div class="algorithm-progress-bar"></div>
              </div>
              <div class="algorithm-score">Skor: <span>0</span></div>
            </div>
            <div class="algorithm-card" data-algo="tabu">
              <div class="algorithm-card-header">
                <span class="algorithm-name">üö´ Tabu</span>
                <span class="algorithm-status"></span>
              </div>
              <div class="algorithm-progress">
                <div class="algorithm-progress-bar"></div>
              </div>
              <div class="algorithm-score">Skor: <span>0</span></div>
            </div>
            <div class="algorithm-card" data-algo="rl">
              <div class="algorithm-card-header">
                <span class="algorithm-name">üéÆ RL</span>
                <span class="algorithm-status"></span>
              </div>
              <div class="algorithm-progress">
                <div class="algorithm-progress-bar"></div>
              </div>
              <div class="algorithm-score">Skor: <span>0</span></div>
            </div>
            <div class="algorithm-card" data-algo="fuzzy">
              <div class="algorithm-card-header">
                <span class="algorithm-name">‚òÅÔ∏è Fuzzy</span>
                <span class="algorithm-status"></span>
              </div>
              <div class="algorithm-progress">
                <div class="algorithm-progress-bar"></div>
              </div>
              <div class="algorithm-score">Skor: <span>0</span></div>
            </div>
          </div>
        </div>

        <!-- √áakƒ±≈üma Haritasƒ± -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <span class="panel-icon">‚ö†Ô∏è</span> √áAKI≈ûMA ANALƒ∞Zƒ∞
            </div>
          </div>
          <div class="conflict-map">
            <div class="conflict-item">
              <span class="conflict-label">üë®‚Äçüè´ √ñƒüretmen √áakƒ±≈ümasƒ±</span>
              <span class="conflict-count zero" id="conflictTeacher">0</span>
            </div>
            <div class="conflict-item">
              <span class="conflict-label">üè´ Sƒ±nƒ±f √áakƒ±≈ümasƒ±</span>
              <span class="conflict-count zero" id="conflictClass">0</span>
            </div>
            <div class="conflict-item">
              <span class="conflict-label">‚è∞ Bo≈ü Pencere</span>
              <span class="conflict-count zero" id="conflictGap">0</span>
            </div>
            <div class="conflict-item">
              <span class="conflict-label">üß© Blok Hatalarƒ±</span>
              <span class="conflict-count zero" id="conflictBlock">0</span>
            </div>
            <div class="conflict-item">
              <span class="conflict-label">üìè Kƒ±sƒ±t ƒ∞hlalleri</span>
              <span class="conflict-count zero" id="conflictConstraint">0</span>
            </div>
            <div class="conflict-item">
              <span class="conflict-label">‚öñÔ∏è Denge Skoru</span>
              <span
                class="conflict-count"
                id="balanceScore"
                style="color: #00d9ff"
                >-</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SAƒû PANEL: KAYDEDƒ∞LMƒ∞≈û PROGRAMLAR + √á√ñZ√úMLER -->
      <!-- ============================================ -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <span class="panel-icon">üíæ</span> KAYDEDƒ∞LMƒ∞≈û PROGRAMLAR
          </div>
          <button class="btn btn-primary btn-small" id="btnYeniProgram">
            ‚ûï Yeni Kaydet
          </button>
        </div>
        <div
          id="savedProgramsList"
          style="max-height: 300px; overflow-y: auto; margin-bottom: 20px"
        >
          <div class="empty-state" style="padding: 20px">
            <div class="empty-icon" style="font-size: 48px">üìÇ</div>
            <div class="empty-title" style="font-size: 14px">
              Kayƒ±tlƒ± Program Yok
            </div>
            <div class="empty-text" style="font-size: 11px">
              Daƒüƒ±tƒ±m sonrasƒ± "Yeni Kaydet" ile kaydedin
            </div>
          </div>
        </div>

        <div
          style="
            border-top: 2px solid rgba(0, 217, 255, 0.3);
            padding-top: 20px;
            margin-top: 20px;
          "
        >
          <div
            class="panel-header"
            style="margin-bottom: 20px; padding-bottom: 0; border: none"
          >
            <div class="panel-title">
              <span class="panel-icon">üèÜ</span> MEVCUT DAƒûITIM √á√ñZ√úMLER
            </div>
            <button
              class="btn btn-secondary btn-small"
              id="btnKarsilastir"
              style="display: none"
            >
              ‚öñÔ∏è Kar≈üƒ±la≈ütƒ±r
            </button>
          </div>
          <div id="solutionsList">
            <div class="empty-state">
              <div class="empty-icon">ü§ñ</div>
              <div class="empty-title">AI Motoru Hazƒ±r</div>
              <div class="empty-text">
                Daƒüƒ±tƒ±mƒ± ba≈ülattƒ±ƒüƒ±nƒ±zda yapay zeka 45+ algoritma ile en iyi 5
                √ß√∂z√ºm√º burada listeleyecek
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: KISITLAR -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="constraintsModal">
      <div class="modal-content" style="max-width: 1600px; max-height: 95vh">
        <div class="modal-header">
          <h2 class="modal-title">üìè √ñƒüretmen Kƒ±sƒ±tlarƒ±</h2>
          <div style="display: flex; gap: 12px; align-items: center">
            <button class="btn btn-primary" id="btnSaveConstraints">
              üíæ Kƒ±sƒ±tlarƒ± Kaydet
            </button>
            <button class="btn btn-secondary" id="btnExportConstraintsExcel">
              üìÑ Excel'e Aktar
            </button>
            <button class="modal-close" onclick="closeConstraintsModal()">
              √ó
            </button>
          </div>
        </div>
        <div class="modal-body" style="padding: 30px">
          <div
            style="
              background: rgba(255, 187, 51, 0.1);
              padding: 16px;
              border-radius: 8px;
              border: 1px solid #ffbb33;
              margin-bottom: 24px;
            "
          >
            <div
              style="
                font-size: 14px;
                color: #ffbb33;
                font-weight: 600;
                margin-bottom: 8px;
              "
            >
              ‚ÑπÔ∏è Kƒ±sƒ±t Nasƒ±l Eklenir?
            </div>
            <div style="font-size: 12px; color: #888; line-height: 1.8">
              1Ô∏è‚É£ Sol taraftan bir √∂ƒüretmen se√ßin<br />
              2Ô∏è‚É£ Program tablosunda
              <strong style="color: #ff6b6b">KIRMIZI</strong> olmasƒ±nƒ±
              istediƒüiniz saatlere tƒ±klayƒ±n<br />
              3Ô∏è‚É£ Kƒ±rmƒ±zƒ± = √ñƒüretmen bu saate ders VEREMEZ<br />
              4Ô∏è‚É£ Tekrar tƒ±klayarak i≈üareti kaldƒ±rabilirsiniz
            </div>
          </div>

          <div
            style="display: grid; grid-template-columns: 320px 1fr; gap: 20px"
          >
            <!-- SOL: √ñƒûRETMEN Lƒ∞STESƒ∞ -->
            <div
              style="
                background: rgba(255, 255, 255, 0.05);
                padding: 20px;
                border-radius: 12px;
                border: 2px solid rgba(0, 217, 255, 0.3);
                max-height: 700px;
                overflow-y: auto;
              "
            >
              <h3
                style="
                  color: #00d9ff;
                  margin-bottom: 16px;
                  font-size: 16px;
                  text-align: center;
                "
              >
                üë®‚Äçüè´ √ñƒüretmenler
              </h3>
              <input
                type="text"
                id="teacherSearchConstraints"
                placeholder="üîç √ñƒüretmen veya bran≈ü ara..."
                oninput="filterTeacherListConstraints(this.value)"
                style="
                  width: 100%;
                  padding: 10px;
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid #00d9ff;
                  border-radius: 6px;
                  color: #fff;
                  font-size: 13px;
                  margin-bottom: 12px;
                "
              />
              <div id="constraintsTeacherList"></div>
            </div>

            <!-- SAƒû: HAFTALIK PROGRAM TABLOSU -->
            <div
              style="
                background: rgba(255, 255, 255, 0.05);
                padding: 20px;
                border-radius: 12px;
                border: 2px solid rgba(0, 217, 255, 0.3);
              "
            >
              <div id="selectedTeacherConstraints">
                <div class="empty-state" style="padding: 80px 20px">
                  <div class="empty-icon" style="font-size: 80px">üëà</div>
                  <div class="empty-title" style="font-size: 20px">
                    √ñƒüretmen Se√ßin
                  </div>
                  <div class="empty-text" style="font-size: 14px">
                    Soldan bir √∂ƒüretmen se√ßerek kƒ±sƒ±t tablosunu a√ßƒ±n
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: √ñƒûRETMEN TERCƒ∞HLERƒ∞ -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="preferencesModal">
      <div class="modal-content" style="max-width: 1400px; max-height: 95vh">
        <div class="modal-header">
          <h2 class="modal-title">üí° √ñƒüretmen Tercihleri</h2>
          <div style="display: flex; gap: 12px; align-items: center">
            <button class="btn btn-primary" id="btnSavePreferences">
              üíæ Tercihleri Kaydet
            </button>
            <button class="btn btn-secondary" id="btnExportPreferencesExcel">
              üìÑ Excel'e Aktar
            </button>
            <button class="modal-close" onclick="closePreferencesModal()">
              √ó
            </button>
          </div>
        </div>
        <div class="modal-body" style="padding: 30px">
          <div
            style="
              background: rgba(0, 245, 160, 0.1);
              padding: 16px;
              border-radius: 8px;
              border: 1px solid #00f5a0;
              margin-bottom: 24px;
            "
          >
            <div
              style="
                font-size: 14px;
                color: #00f5a0;
                font-weight: 600;
                margin-bottom: 8px;
              "
            >
              ‚ÑπÔ∏è Tercih Sistemi:
            </div>
            <div style="font-size: 12px; color: #888; line-height: 1.8">
              ‚Ä¢ <strong style="color: #00f5a0">SEVƒ∞YOR (Ye≈üil):</strong> Bu
              g√ºnleri/saatleri tercih ediyor (+10 puan)<br />
              ‚Ä¢ <strong style="color: #888">N√ñTR (Gri):</strong> Fark etmez (0
              puan)<br />
              ‚Ä¢ <strong style="color: #ff6b6b">SEVMƒ∞YOR (Kƒ±rmƒ±zƒ±):</strong> Bu
              g√ºnleri/saatleri tercih etmiyor (-5 puan)
            </div>
          </div>

          <div
            style="display: grid; grid-template-columns: 350px 1fr; gap: 20px"
          >
            <!-- SOL: √ñƒûRETMEN Lƒ∞STESƒ∞ -->
            <div
              style="
                background: rgba(255, 255, 255, 0.05);
                padding: 20px;
                border-radius: 12px;
                border: 2px solid rgba(0, 217, 255, 0.3);
                max-height: 650px;
                overflow-y: auto;
              "
            >
              <h3
                style="
                  color: #00d9ff;
                  margin-bottom: 16px;
                  font-size: 16px;
                  text-align: center;
                "
              >
                üë®‚Äçüè´ √ñƒüretmenler
              </h3>
              <input
                type="text"
                id="teacherSearchPreferences"
                placeholder="üîç √ñƒüretmen veya bran≈ü ara..."
                style="
                  width: 100%;
                  padding: 10px;
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid #00d9ff;
                  border-radius: 6px;
                  color: #fff;
                  font-size: 13px;
                  margin-bottom: 12px;
                "
              />
              <div id="preferencesTeacherList"></div>
            </div>

            <!-- SAƒû: SE√áƒ∞LEN √ñƒûRETMEN TERCƒ∞HLERƒ∞ -->
            <div
              style="
                background: rgba(255, 255, 255, 0.05);
                padding: 20px;
                border-radius: 12px;
                border: 2px solid rgba(0, 217, 255, 0.3);
              "
            >
              <div id="selectedTeacherPreferences">
                <div class="empty-state" style="padding: 80px 20px">
                  <div class="empty-icon" style="font-size: 80px">üëà</div>
                  <div class="empty-title" style="font-size: 20px">
                    √ñƒüretmen Se√ßin
                  </div>
                  <div class="empty-text" style="font-size: 14px">
                    Soldan bir √∂ƒüretmen se√ßerek tercihlerini g√∂r√ºnt√ºleyin veya
                    ekleyin
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: GENEL AYARLAR -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="generalSettingsModal">
      <div class="modal-content" style="max-width: 1000px">
        <div class="modal-header">
          <h2 class="modal-title">‚öôÔ∏è Genel Ayarlar</h2>
          <div style="display: flex; gap: 12px; align-items: center">
            <button class="btn btn-primary" id="btnSaveGeneralSettings">
              üíæ Ayarlarƒ± Kaydet
            </button>
            <button class="modal-close" onclick="closeGeneralSettingsModal()">
              √ó
            </button>
          </div>
        </div>

        <!-- TAB MEN√úS√ú -->
        <div
          class="modal-tabs-container"
          style="
            border-bottom: 2px solid rgba(0, 217, 255, 0.2);
            padding: 0 30px;
          "
        >
          <div class="modal-tabs">
            <div class="modal-tab active" onclick="switchGeneralTab('meb')">
              üìú MEB Kurallarƒ±
            </div>
            <div class="modal-tab" onclick="switchGeneralTab('ozel-ogretmen')">
              üéØ √ñzel √ñƒüretmen Se√ßimi
            </div>
            <div class="modal-tab" onclick="switchGeneralTab('diger')">
              ‚öôÔ∏è Diƒüer Ayarlar
            </div>
          </div>
        </div>

        <div class="modal-body" style="padding: 30px">
          <!-- TAB 1: MEB KURALLARI -->
          <div class="modal-tab-content active" id="generalTabMEB">
            <div style="display: grid; gap: 24px">
              <!-- MEB Kurallarƒ± -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3
                  style="color: #00d9ff; margin-bottom: 16px; font-size: 16px"
                >
                  üìú MEB √ñzel Ders Kurallarƒ±
                </h3>
                <div class="toggle-container">
                  <div class="toggle-label">
                    Beden Eƒüitimi ‚Üí Pazartesi 1-2 VEYA Cuma 7-8
                  </div>
                  <div class="toggle-switch active" id="toggle-meb-beden">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
                <div class="toggle-container">
                  <div class="toggle-label">
                    G√∂rsel Sanatlar/M√ºzik ‚Üí Pazartesi 1-2 VEYA Cuma 7-8
                  </div>
                  <div class="toggle-switch active" id="toggle-meb-sanat">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
              </div>

              <!-- Blok Ayarlarƒ± -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3
                  style="color: #00d9ff; margin-bottom: 16px; font-size: 16px"
                >
                  üß© Blok Daƒüƒ±tƒ±m Ayarlarƒ±
                </h3>
                <div class="toggle-container">
                  <div class="toggle-label">Bloklarƒ± Farklƒ± G√ºnlere Daƒüƒ±t</div>
                  <div class="toggle-switch active" id="toggle-blok-dagit">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
                <div class="toggle-container">
                  <div class="toggle-label">
                    Aynƒ± √ñƒüretmen Farklƒ± Ders ‚Üí Farklƒ± G√ºn
                  </div>
                  <div class="toggle-switch active" id="toggle-ayni-ogretmen">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
              </div>

              <!-- √áakƒ±≈üma Kontrol -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3
                  style="color: #00d9ff; margin-bottom: 16px; font-size: 16px"
                >
                  ‚ö†Ô∏è √áakƒ±≈üma Kontrol
                </h3>
                <div class="toggle-container">
                  <div class="toggle-label">√ñƒüretmen √áakƒ±≈ümasƒ± Kontrol√º</div>
                  <div
                    class="toggle-switch active"
                    id="toggle-ogretmen-cakisma"
                  >
                    <div class="toggle-knob"></div>
                  </div>
                </div>
                <div class="toggle-container">
                  <div class="toggle-label">Sƒ±nƒ±f √áakƒ±≈ümasƒ± Kontrol√º</div>
                  <div class="toggle-switch active" id="toggle-sinif-cakisma">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
              </div>

              <!-- Rehberlik √ñƒüretmenleri -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3
                  style="color: #00d9ff; margin-bottom: 16px; font-size: 16px"
                >
                  üéì √ñzel Durum √ñƒüretmenler
                </h3>
                <div
                  style="
                    background: rgba(255, 187, 51, 0.1);
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid #ffbb33;
                    margin-bottom: 12px;
                  "
                >
                  <div
                    style="font-size: 12px; color: #ffbb33; font-weight: 600"
                  >
                    ‚ÑπÔ∏è Rehberlik √ñƒüretmenleri:
                  </div>
                  <div style="font-size: 11px; color: #888; margin-top: 6px">
                    Bran≈üƒ± "Rehberlik" olan √∂ƒüretmenler daƒüƒ±tƒ±mda ATLANIR. Ancak
                    "Rehberlik ve Y√∂nlendirme" dersi atanan √∂ƒüretmenler
                    daƒüƒ±tƒ±lƒ±r ve SARI renkle g√∂sterilir.
                  </div>
                </div>
                <div class="toggle-container">
                  <div class="toggle-label">
                    Rehberlik Bran≈ülƒ± √ñƒüretmenleri Atla
                  </div>
                  <div class="toggle-switch active" id="toggle-rehberlik-atla">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB 2: √ñZEL √ñƒûRETMEN SE√áƒ∞Mƒ∞ -->
          <div
            class="modal-tab-content"
            id="generalTabOzelOgretmen"
            style="display: none"
          >
            <div style="display: grid; gap: 24px">
              <!-- Beden Eƒüitimi √ñƒüretmenleri -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3 style="color: #00d9ff; margin-bottom: 15px">
                  üèÉ Beden Eƒüitimi √ñƒüretmenleri
                </h3>
                <div
                  style="
                    background: rgba(0, 217, 255, 0.1);
                    padding: 12px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    border-left: 3px solid #00d9ff;
                  "
                >
                  <p style="color: #ccc; font-size: 12px; margin: 0">
                    <strong style="color: #00d9ff">Kural:</strong> Se√ßili
                    √∂ƒüretmenler ‚Üí Pazartesi 1-2. saat VEYA Cuma 7-8. saate
                    yerle≈üir<br />
                    <strong style="color: #00d9ff">Se√ßilmeyenler:</strong>
                    Normal daƒüƒ±tƒ±m (haftanƒ±n t√ºm g√ºnleri)
                  </p>
                </div>
                <div id="bedenOgretmenList" class="teacher-checkbox-list"></div>
              </div>

              <!-- M√ºzik/G√∂rsel Sanatlar √ñƒüretmenleri -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3 style="color: #00d9ff; margin-bottom: 15px">
                  üéµ M√ºzik/G√∂rsel Sanatlar √ñƒüretmenleri
                </h3>
                <div
                  style="
                    background: rgba(0, 217, 255, 0.1);
                    padding: 12px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    border-left: 3px solid #00d9ff;
                  "
                >
                  <p style="color: #ccc; font-size: 12px; margin: 0">
                    <strong style="color: #00d9ff">Kural:</strong> Se√ßili
                    √∂ƒüretmenler ‚Üí Pazartesi 1-2. saat VEYA Cuma 7-8. saate
                    yerle≈üir<br />
                    <strong style="color: #00d9ff">Se√ßilmeyenler:</strong>
                    Normal daƒüƒ±tƒ±m (haftanƒ±n t√ºm g√ºnleri)
                  </p>
                </div>
                <div id="muzikOgretmenList" class="teacher-checkbox-list"></div>
              </div>
            </div>
          </div>

          <!-- TAB 3: Dƒ∞ƒûER AYARLAR -->
          <div
            class="modal-tab-content"
            id="generalTabDiger"
            style="display: none"
          >
            <div style="display: grid; gap: 24px">
              <!-- Rastgele Bo≈ü G√ºn -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3
                  style="color: #00d9ff; margin-bottom: 16px; font-size: 16px"
                >
                  üé≤ Rastgele Bo≈ü G√ºn Daƒüƒ±tƒ±mƒ±
                </h3>
                <div
                  style="
                    background: rgba(255, 187, 51, 0.1);
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid #ffbb33;
                    margin-bottom: 16px;
                  "
                >
                  <div
                    style="
                      font-size: 12px;
                      color: #ffbb33;
                      font-weight: 600;
                      margin-bottom: 4px;
                    "
                  >
                    üí° Nasƒ±l √áalƒ±≈üƒ±r?
                  </div>
                  <div style="font-size: 11px; color: #888; line-height: 1.6">
                    ‚Ä¢ Aktif edilirse: T√ºm √∂ƒüretmenlere rastgele 1 g√ºn bo≈ü
                    verilir<br />
                    ‚Ä¢ Manuel tercih yoksa: Sistem otomatik g√ºn se√ßer<br />
                    ‚Ä¢ Manuel tercih varsa: √ñncelik manuel tercihe verilir
                  </div>
                </div>
                <div class="toggle-container">
                  <div class="toggle-label">
                    T√ºm √ñƒüretmenlere Rastgele 1 G√ºn Bo≈ü Ver
                  </div>
                  <div class="toggle-switch" id="toggle-random-offday">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
              </div>

              <!-- G√ºnl√ºk Ders Limitleri -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3
                  style="color: #00d9ff; margin-bottom: 16px; font-size: 16px"
                >
                  üìä G√ºnl√ºk Ders Limitleri (Genel)
                </h3>
                <div
                  style="
                    background: rgba(255, 187, 51, 0.1);
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid #ffbb33;
                    margin-bottom: 16px;
                  "
                >
                  <div
                    style="
                      font-size: 12px;
                      color: #ffbb33;
                      font-weight: 600;
                      margin-bottom: 4px;
                    "
                  >
                    üí° Genel Kurallar
                  </div>
                  <div style="font-size: 11px; color: #888; line-height: 1.6">
                    ‚Ä¢ T√ºm √∂ƒüretmenler i√ßin varsayƒ±lan limitler<br />
                    ‚Ä¢ √ñƒüretmen bazlƒ± ayarlar bu ayarlarƒ± ge√ßersiz kƒ±lar
                  </div>
                </div>

                <div class="toggle-container">
                  <div class="toggle-label">G√ºnl√ºk Ders Limitlerini Uygula</div>
                  <div class="toggle-switch" id="toggle-daily-limit">
                    <div class="toggle-knob"></div>
                  </div>
                </div>

                <div
                  id="dailyLimitSettings"
                  style="margin-top: 16px; opacity: 0.5; pointer-events: none"
                >
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 16px;
                      margin-bottom: 16px;
                    "
                  >
                    <div>
                      <label
                        style="
                          display: block;
                          font-size: 13px;
                          color: #888;
                          margin-bottom: 8px;
                        "
                        >En Az G√ºnl√ºk Ders</label
                      >
                      <input
                        type="number"
                        id="globalMinDaily"
                        min="0"
                        max="8"
                        value="2"
                        style="
                          width: 100%;
                          padding: 10px;
                          background: rgba(255, 255, 255, 0.1);
                          border: 1px solid #00d9ff;
                          border-radius: 6px;
                          color: #fff;
                          font-size: 13px;
                        "
                      />
                    </div>
                    <div>
                      <label
                        style="
                          display: block;
                          font-size: 13px;
                          color: #888;
                          margin-bottom: 8px;
                        "
                        >En Fazla G√ºnl√ºk Ders</label
                      >
                      <input
                        type="number"
                        id="globalMaxDaily"
                        min="1"
                        max="8"
                        value="8"
                        style="
                          width: 100%;
                          padding: 10px;
                          background: rgba(255, 255, 255, 0.1);
                          border: 1px solid #00d9ff;
                          border-radius: 6px;
                          color: #fff;
                          font-size: 13px;
                        "
                      />
                    </div>
                  </div>
                  <div
                    style="
                      background: rgba(0, 217, 255, 0.1);
                      padding: 12px;
                      border-radius: 8px;
                    "
                  >
                    <div style="font-size: 12px; color: #00d9ff">
                      üìå √ñrnek: En az 2, En fazla 8 ‚Üí √ñƒüretmen g√ºnde 2-8 ders
                      arasƒ± alƒ±r
                    </div>
                  </div>
                </div>
              </div>

              <!-- Haftalƒ±k Bo≈üluk (Gap) Limiti -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(0, 217, 255, 0.3);
                "
              >
                <h3
                  style="color: #00d9ff; margin-bottom: 16px; font-size: 16px"
                >
                  ‚è∏Ô∏è Haftalƒ±k Maksimum Pencere (Bo≈üluk) Sayƒ±sƒ±
                </h3>
                <div
                  style="
                    background: rgba(255, 187, 51, 0.1);
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid #ffbb33;
                    margin-bottom: 16px;
                  "
                >
                  <div
                    style="
                      font-size: 12px;
                      color: #ffbb33;
                      font-weight: 600;
                      margin-bottom: 4px;
                    "
                  >
                    üí° Pencere (Gap) Nedir?
                  </div>
                  <div style="font-size: 11px; color: #888; line-height: 1.6">
                    ‚Ä¢ √ñƒüretmenin ders aralarƒ±ndaki bo≈ü saatler<br />
                    ‚Ä¢ √ñrnek: 1. saat ders, 2. saat bo≈ü, 3. saat ders ‚Üí 1
                    pencere<br />
                    ‚Ä¢ D√º≈ü√ºk pencere = Daha d√ºzenli program
                  </div>
                </div>

                <div class="toggle-container">
                  <div class="toggle-label">
                    Haftalƒ±k Pencere Limitini Uygula
                  </div>
                  <div class="toggle-switch" id="toggle-gap-limit">
                    <div class="toggle-knob"></div>
                  </div>
                </div>

                <div
                  id="gapLimitSettings"
                  style="margin-top: 16px; opacity: 0.5; pointer-events: none"
                >
                  <div>
                    <label
                      style="
                        display: block;
                        font-size: 13px;
                        color: #888;
                        margin-bottom: 8px;
                      "
                      >Haftalƒ±k Maksimum Pencere Sayƒ±sƒ±</label
                    >
                    <input
                      type="number"
                      id="globalMaxGaps"
                      min="0"
                      max="10"
                      value="2"
                      style="
                        width: 100%;
                        padding: 10px;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid #00d9ff;
                        border-radius: 6px;
                        color: #fff;
                        font-size: 13px;
                      "
                    />
                  </div>
                  <div
                    style="
                      background: rgba(0, 217, 255, 0.1);
                      padding: 12px;
                      border-radius: 8px;
                      margin-top: 12px;
                    "
                  >
                    <div style="font-size: 12px; color: #00d9ff">
                      üìå √ñrnek: 2 ‚Üí √ñƒüretmen haftada maksimum 2 bo≈ü pencere alƒ±r
                    </div>
                  </div>
                </div>
              </div>

              <!-- ‚úÖ YENƒ∞: Hƒ∞BRƒ∞T OPTƒ∞Mƒ∞ZASYON -->
              <div
                style="
                  background: rgba(255, 255, 255, 0.05);
                  padding: 20px;
                  border-radius: 12px;
                  border: 2px solid rgba(255, 69, 0, 0.3);
                "
              >
                <h3
                  style="color: #ff4500; margin-bottom: 16px; font-size: 16px"
                >
                  üî• Hibrit Optimizasyon (Deneysel)
                </h3>
                <div
                  style="
                    background: rgba(255, 69, 0, 0.1);
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid #ff4500;
                    margin-bottom: 16px;
                  "
                >
                  <div
                    style="
                      font-size: 12px;
                      color: #ff4500;
                      font-weight: 600;
                      margin-bottom: 4px;
                    "
                  >
                    ‚ö° Nasƒ±l √áalƒ±≈üƒ±r?
                  </div>
                  <div style="font-size: 11px; color: #888; line-height: 1.6">
                    ‚Ä¢ <strong>A≈üama 1:</strong> SimpleBlock ile ge√ßerli √ß√∂z√ºm
                    olu≈üturulur<br />
                    ‚Ä¢ <strong>A≈üama 2:</strong> Meta-heuristic algoritmalar (GA,
                    SA) ile optimize edilir<br />
                    ‚Ä¢ <strong>Sonu√ß:</strong> Daha az gap, daha iyi tercih
                    uyumu, daha dengeli daƒüƒ±tƒ±m<br />
                    ‚Ä¢ ‚ö†Ô∏è <strong>Uyarƒ±:</strong> ƒ∞≈ülem s√ºresi 1-2 dakika artar
                  </div>
                </div>
                <div class="toggle-container">
                  <div class="toggle-label">
                    Hibrit Optimizasyon Kullan (SimpleBlock + AI)
                  </div>
                  <div class="toggle-switch" id="toggle-hybrid-optimization">
                    <div class="toggle-knob"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: DERS ATAMA KONTROL -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="lessonAssignmentModal">
      <div class="modal-content" style="max-width: 1200px; max-height: 95vh">
        <div class="modal-header">
          <h2 class="modal-title">‚úÖ Ders Atama Kontrol</h2>
          <button class="modal-close" onclick="closeLessonAssignmentModal()">
            √ó
          </button>
        </div>
        <div class="modal-body" style="padding: 30px">
          <div id="lessonAssignmentContent"></div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: √ñƒûRETMEN DERS Y√úK√ú -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="teacherWorkloadModal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h2 class="modal-title">üë®‚Äçüè´ √ñƒüretmen Ders Y√ºk√º</h2>
          <button class="modal-close" onclick="closeTeacherWorkloadModal()">
            √ó
          </button>
        </div>
        <div class="modal-body" style="padding: 30px">
          <div id="teacherWorkloadContent"></div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: MANUEL YERLE≈ûTƒ∞RME -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="manualPlacementModal">
      <div class="modal-content" style="max-width: 95%; max-height: 95vh">
        <div class="modal-header">
          <h2 class="modal-title">üìù Manuel Ders Yerle≈ütirme</h2>
          <div style="display: flex; gap: 12px; align-items: center">
            <button class="btn btn-primary" id="btnSaveManualPlacement">
              üíæ Yerle≈ütirmeleri Kaydet
            </button>
            <button class="btn btn-danger" id="btnClearManualPlacement">
              üóëÔ∏è Temizle
            </button>
            <button class="modal-close" onclick="closeManualPlacementModal()">
              √ó
            </button>
          </div>
        </div>
        <div class="modal-body" style="padding: 0; overflow: hidden">
          <div
            style="
              display: grid;
              grid-template-columns: 300px 1fr;
              gap: 0;
              height: calc(95vh - 100px);
            "
          >
            <!-- SOL: √ñƒûRETMEN + DERS HAVUZU -->
            <div
              style="
                background: rgba(255, 255, 255, 0.05);
                padding: 20px;
                border-right: 2px solid #00d9ff;
                overflow-y: auto;
              "
            >
              <h3 style="color: #00d9ff; margin-bottom: 16px; font-size: 16px">
                üë®‚Äçüè´ √ñƒüretmenler
              </h3>
              <div
                style="
                  font-size: 11px;
                  color: #888;
                  margin-bottom: 16px;
                  padding: 10px;
                  background: rgba(0, 217, 255, 0.1);
                  border-radius: 6px;
                "
              >
                ‚ÑπÔ∏è √ñƒüretmene tƒ±kla ‚Üí Dersleri g√∂r√ºnt√ºle ‚Üí Tabloya s√ºr√ºkle
              </div>
              <div id="manualTeacherList"></div>
            </div>

            <!-- SAƒû: PROGRAM TABLOSU -->
            <div
              style="
                display: flex;
                flex-direction: column;
                padding: 20px;
                overflow-y: auto;
              "
            >
              <!-- Ders Havuzu -->
              <div
                id="manualLessonPool"
                style="
                  margin-bottom: 20px;
                  min-height: 120px;
                  padding: 16px;
                  background: rgba(123, 47, 255, 0.1);
                  border: 2px dashed #7b2fff;
                  border-radius: 12px;
                "
              >
                <h3
                  style="color: #7b2fff; margin-bottom: 12px; font-size: 14px"
                >
                  üìö Ders Havuzu (S√ºr√ºkle)
                </h3>
                <div
                  id="manualLessonPoolItems"
                  style="display: flex; flex-wrap: wrap; gap: 8px"
                >
                  <div style="font-size: 12px; color: #888">
                    √ñƒüretmen se√ßin...
                  </div>
                </div>
              </div>

              <!-- Program Tablosu -->
              <div
                style="
                  overflow: auto;
                  border: 2px solid #00d9ff;
                  border-radius: 12px;
                  background: rgba(0, 0, 0, 0.3);
                "
              >
                <table class="program-table" id="manualPlacementTable">
                  <thead>
                    <tr>
                      <th style="width: 80px">Saat</th>
                      <th>Pazartesi</th>
                      <th>Salƒ±</th>
                      <th>√áar≈üamba</th>
                      <th>Per≈üembe</th>
                      <th>Cuma</th>
                    </tr>
                  </thead>
                  <tbody id="manualPlacementTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: PROGRAM KAYDETME -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="saveModal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h2 class="modal-title">üíæ Programƒ± Kaydet</h2>
          <button class="modal-close" onclick="closeSaveModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 20px">
            <label
              style="
                display: block;
                font-size: 14px;
                color: #888;
                margin-bottom: 8px;
              "
              >Program Adƒ±:</label
            >
            <input
              type="text"
              id="programAdiInput"
              placeholder="√ñrn: Mart 2025 - ƒ∞lk Daƒüƒ±tƒ±m"
              style="
                width: 100%;
                padding: 12px;
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid #00d9ff;
                border-radius: 8px;
                color: #fff;
                font-size: 14px;
              "
            />
          </div>
          <div
            style="
              background: rgba(0, 217, 255, 0.1);
              padding: 16px;
              border-radius: 8px;
              border: 1px solid #00d9ff;
              margin-bottom: 20px;
            "
          >
            <div style="font-size: 12px; color: #888; margin-bottom: 8px">
              üìä √á√∂z√ºm ƒ∞statistikleri:
            </div>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
              "
            >
              <div>
                <strong>Fitness:</strong> <span id="saveFitness">-</span>
              </div>
              <div>
                <strong>√áakƒ±≈üma:</strong> <span id="saveConflicts">-</span>
              </div>
              <div><strong>Bo≈üluk:</strong> <span id="saveGaps">-</span></div>
              <div><strong>Denge:</strong> <span id="saveBalance">-</span></div>
            </div>
          </div>
          <div style="text-align: center">
            <button
              class="btn btn-primary btn-large"
              onclick="kaydetProgrami()"
              style="width: 100%"
            >
              üíæ Kaydet
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: PROGRAM G√ñR√úNT√úLEME -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="programModal">
      <div class="modal-content" style="max-width: 95%; max-height: 95vh">
        <div class="modal-header">
          <h2 class="modal-title">üìÖ AI ile Olu≈üturulan Ders Programƒ±</h2>
          <div style="display: flex; gap: 12px; align-items: center">
            <button
              class="btn btn-primary"
              id="btnProgramKaydet"
              style="display: none"
            >
              üíæ Bu Programƒ± Kaydet
            </button>
            <button class="modal-close" onclick="closeProgramModal()">√ó</button>
          </div>
        </div>
        <div class="modal-body" style="padding: 0; overflow: hidden">
          <div class="program-layout">
            <div class="program-sidebar">
              <div class="sidebar-section">
                <div class="sidebar-title">üè´ Sƒ±nƒ±flar</div>
                <div id="sinifList">
                  <div
                    style="
                      text-align: center;
                      color: #888;
                      padding: 20px;
                      font-size: 12px;
                    "
                  >
                    Y√ºkleniyor...
                  </div>
                </div>
              </div>
              <div class="sidebar-section">
                <div class="sidebar-title">üë®‚Äçüè´ √ñƒüretmenler</div>
                <div id="ogretmenList">
                  <div
                    style="
                      text-align: center;
                      color: #888;
                      padding: 20px;
                      font-size: 12px;
                    "
                  >
                    Y√ºkleniyor...
                  </div>
                </div>
              </div>
            </div>
            <div class="program-main">
              <div class="program-title" id="programTitle">
                L√ºtfen bir sƒ±nƒ±f veya √∂ƒüretmen se√ßin
              </div>
              <div class="program-table-container">
                <table class="program-table" id="programTable">
                  <tr>
                    <td
                      colspan="6"
                      style="padding: 60px; text-align: center; color: #888"
                    >
                      Program verisi yok
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: DEƒûƒ∞≈ûƒ∞KLƒ∞KLER -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="changesModal">
      <div class="modal-content" style="max-width: 1000px">
        <div class="modal-header">
          <h2 class="modal-title">üìä Yeniden Daƒüƒ±tƒ±m Sonu√ßlarƒ±</h2>
          <button class="modal-close" onclick="closeChangesModal()">√ó</button>
        </div>
        <div class="modal-body" id="changesModalContent"></div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: √á√ñZ√úM DETAY -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="detailModal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h2 class="modal-title">
            üèÜ √á√∂z√ºm Detaylarƒ± #<span id="detailModalId">1</span>
          </h2>
          <button class="modal-close" onclick="closeDetailModal()">√ó</button>
        </div>
        <div class="modal-body" id="detailModalContent"></div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: KAR≈ûILA≈ûTIRMA -->
    <!-- ============================================ -->
    <div class="modal-overlay" id="compareModal">
      <div class="modal-content" style="max-width: 1200px">
        <div class="modal-header">
          <h2 class="modal-title">‚öñÔ∏è √á√∂z√ºm Kar≈üƒ±la≈ütƒ±rmasƒ± (5 √á√∂z√ºm)</h2>
          <button class="modal-close" onclick="closeCompareModal()">√ó</button>
        </div>
        <div class="modal-body" id="compareModalContent"></div>
      </div>
    </div>
    <script src="schedule-data-manager.js"></script>
    <script src="schedule-constraints.js"></script>
    <script src="schedule-preferences.js"></script>

    <!-- ‚úÖ YENƒ∞: Schedule Format Converter -->
    <script src="../js/modules/helpers/schedule-format-converter.js"></script>

    <script src="../js/modules/helpers/lock-manager.js"></script>

    <script src="../js/modules/algorithms/cache-manager.js"></script>
    <script src="../js/modules/algorithms/save-manager.js"></script>

    <script src="schedule-drag-drop.js"></script>

    <script src="../js/modules/helpers/undo-redo-manager.js"></script>
    <script src="../js/modules/helpers/statistics-manager.js"></script>
    <script src="../js/modules/helpers/progress-tracker.js"></script>
    <script src="../js/modules/helpers/distribution-analyzer.js"></script>
    <script src="../js/modules/helpers/conflict-detector.js"></script>
    <script src="../js/modules/helpers/export-import-manager.js"></script>

    <script src="../js/modules/algorithms/constraint-preprocessor.js"></script>
    <script src="../js/modules/algorithms/incremental-conflict-cache.js"></script>

    <script src="../js/modules/algorithms/schedule-scoring.js"></script>
    <script src="../js/modules/algorithms/solver-pipeline.js"></script>
    <script src="../js/modules/algorithms/fairness-engine.js"></script>
    <script src="../js/modules/algorithms/performance-monitor.js"></script>
    <script src="../js/modules/algorithms/solution-stabilizer.js"></script>
    <script src="../js/modules/algorithms/block-structure.js"></script>
    <script src="../js/modules/algorithms/block-placement-controller.js"></script>
    <script src="../js/modules/algorithms/block-day-validator.js"></script>
    <script src="../js/modules/algorithms/block-consecutive-check.js"></script>
    <script src="../js/modules/algorithms/block-aware-swap.js"></script>

    <script src="../js/modules/algorithms/genetic-algorithm.js"></script>
    <script src="../js/modules/algorithms/ant-colony-optimization.js"></script>
    <script src="../js/modules/algorithms/simulated-annealing.js"></script>
    <script src="../js/modules/algorithms/tabu-search.js"></script>
    <script src="../js/modules/algorithms/reinforcement-learning.js"></script>
    <script src="../js/modules/algorithms/parallel-solver.js"></script>
    <script src="../js/modules/algorithms/fuzzy-logic.js"></script>

    <script src="../js/modules/algorithms/adaptive-strategy.js"></script>
    <script src="../js/modules/algorithms/hybrid-solver.js"></script>
    <script src="../js/modules/algorithms/multi-objective-optimizer.js"></script>
    <script src="../js/modules/algorithms/validation-engine.js"></script>
    <script src="../js/modules/algorithms/schedule-repair-engine.js"></script>
    <script src="../js/modules/algorithms/quality-assurance.js"></script>

    <script src="../js/modules/algorithms/pattern-memory.js"></script>
    <script src="../js/modules/algorithms/meta-controller.js"></script>
    <script src="../js/modules/algorithms/weighted-constraint-system.js"></script>
    <script src="../js/modules/algorithms/debug-logger.js"></script>
    <script src="../js/modules/algorithms/algorithm-visualizer.js"></script>
    <script src="../js/modules/algorithms/interactive-schedule-viewer.js"></script>
    <script src="../js/modules/algorithms/schedule-comparison-tool.js"></script>
    <script src="../js/modules/algorithms/etkilenen-ogretmen-finder.js"></script>

    <script src="../js/modules/features/swap-engine.js"></script>
    <script src="../js/modules/features/live-scheduler.js"></script>

    <script src="../js/data-adapter.js"></script>
    <script src="../js/modules/algorithms/simple-block-scheduler.js"></script>
    <script src="../js/modules/algorithms/hybrid-optimizer-wrapper.js"></script>
    <script src="../js/modules/algorithms/schedule-algorithm-v2.js"></script>
    <script src="../bilesenler/bildirim-sistemi.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      console.log("üöÄ ============================================");
      console.log(
        "üáπüá∑ T√úRKƒ∞YE'Nƒ∞N ƒ∞LK YAPAY ZEKA DESTEKLƒ∞ DERS DAƒûITIM Sƒ∞STEMƒ∞"
      );
      console.log("üì¶ Version: 4.0.0 - KOMPLE YENƒ∞ VERSƒ∞YON");
      console.log("ü§ñ AI Engine: 45+ Algorithm Hybrid System");
      console.log(
        "‚ú® Yeni √ñzellikler: Kƒ±sƒ±tlar, Tercihler, Manuel Yerle≈ütirme, √ñƒüretmen Ders Y√ºk√º"
      );
      console.log("üöÄ ============================================");

      // ============================================
      // GLOBAL DEƒûƒ∞≈ûKENLER
      // ============================================
      let isRunning = false;
      let solutions = [];
      let currentSolution = null;
      let previousSolution = null;
      let currentProgramData = null;
      let algorithmInstance = null;
      let startTime = null;
      let timerInterval = null;
      let lockedLessons = new Set();
      let manualPlacements = {};
      let savedPrograms = [];
      let activeProgram = null;
      let swapEngine = null;

      // Kƒ±sƒ±tlar ve Tercihler
      let teacherConstraints = {}; // {teacherId: [{type, day, hour, ...}]}
      let teacherPreferences = {}; // {teacherId: {dayPrefs, hourPrefs}}
      let selectedTeacherId = null;

      const speedModes = {
        1: {
          label: "‚ö° √áok Hƒ±zlƒ±",
          desc: "Minimum iterasyon, hƒ±zlƒ± sonu√ß",
          iterations: 100,
        },
        2: {
          label: "‚ö° Hƒ±zlƒ±",
          desc: "Az iterasyon, iyi hƒ±z",
          iterations: 500,
        },
        3: {
          label: "‚öñÔ∏è Dengeli Mod",
          desc: "Orta hƒ±z ve kalite dengesi",
          iterations: 1000,
        },
        4: {
          label: "üèÜ Kaliteli",
          desc: "Fazla iterasyon, y√ºksek kalite",
          iterations: 2000,
        },
        5: {
          label: "üèÜ √áok Kaliteli",
          desc: "Maksimum iterasyon, en iyi sonu√ß",
          iterations: 5000,
        },
      };

      // ============================================
      // MODERN Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞
      // ============================================
      function showModernNotification(message, type = "info", duration = 5000) {
        const container =
          document.getElementById("notification-container") ||
          createNotificationContainer();
        const notification = document.createElement("div");
        notification.className = `modern-notification ${type}`;

        const icons = {
          success: "‚úÖ",
          error: "‚ùå",
          warning: "‚ö†Ô∏è",
          info: "‚ÑπÔ∏è",
        };

        notification.innerHTML = `
          <div class="notification-icon">${icons[type]}</div>
          <div class="notification-content">
            <div class="notification-message">${message}</div>
          </div>
          <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
        `;

        container.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, duration);
      }

      function createNotificationContainer() {
        const container = document.createElement("div");
        container.id = "notification-container";
        container.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          z-index: 10001;
          display: flex;
          flex-direction: column;
          gap: 10px;
          max-width: 400px;
        `;
        document.body.appendChild(container);

        const style = document.createElement("style");
        style.textContent = `
          .modern-notification {
            background: linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
            border: 2px solid;
          }
          .modern-notification.success { border-color: #00f5a0; }
          .modern-notification.error { border-color: #ff6b6b; }
          .modern-notification.warning { border-color: #ffbb33; }
          .modern-notification.info { border-color: #00d9ff; }
          .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
          }
          .notification-content {
            flex: 1;
          }
          .notification-message {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 600;
          }
          .notification-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #888;
            cursor: pointer;
            flex-shrink: 0;
          }
          .notification-close:hover {
            color: #fff;
          }
          @keyframes slideIn {
            from {
              transform: translateX(400px);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
          @keyframes slideOut {
            from {
              transform: translateX(0);
              opacity: 1;
            }
            to {
              transform: translateX(400px);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);

        return container;
      }

      function showSuccess(message) {
        showModernNotification(message, "success");
      }
      function showError(message) {
        showModernNotification(message, "error");
      }
      function showWarning(message) {
        showModernNotification(message, "warning");
      }
      function showInfo(message) {
        showModernNotification(message, "info");
      }

      // ============================================
      // SAYFA Y√úKLEME
      // ============================================
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("üìÑ Sayfa y√ºklendi, sistem ba≈ülatƒ±lƒ±yor...");
        try {
          await loadProgramData();
          initializeEventListeners();
          initializeUI();
          await loadSavedPrograms();
          await loadConstraints();
          await loadPreferences();
          initializeSwapEngine();
          console.log("‚úÖ Sistem hazƒ±r!");
          showSuccess("üöÄ Sistem ba≈üarƒ±yla ba≈ülatƒ±ldƒ±! T√ºm mod√ºller aktif.");
        } catch (error) {
          console.error("‚ùå Ba≈ülatma hatasƒ±:", error);
          showError("Sistem ba≈ülatƒ±lamadƒ±: " + error.message);
        }
      });

      // ============================================
      // VERƒ∞ Y√úKLEME (√áOKLU √ñƒûRETMEN + BRAN≈û FIX)
      // ============================================
      async function loadProgramData() {
        try {
          console.log("üìä Program verileri y√ºkleniyor...");
          const programId = localStorage.getItem("currentProgramId");

          if (!programId) {
            throw new Error("Program ID bulunamadƒ±!");
          }

          const adapter = new DataAdapter();
          currentProgramData = await adapter.prepareAlgorithmData();

          if (!currentProgramData) {
            throw new Error("Program verileri y√ºklenemedi!");
          }

          // √áOK √ñNEMLƒ∞: MERGE DUPLICATE LESSONS (√áOKLU √ñƒûRETMEN FIX)
          currentProgramData.lessons = mergeDuplicateLessons(
            currentProgramData.lessons
          );

          console.log("‚úÖ Program verileri y√ºklendi:", currentProgramData);
          updateStats(currentProgramData);
        } catch (error) {
          console.error("‚ùå Veri y√ºkleme hatasƒ±:", error);
          throw error;
        }
      }

      function mergeDuplicateLessons(lessons) {
        console.log("\nüîç MERGE DUPLICATE LESSONS - BA≈ûLANGI√á:");
        console.log(`   ‚Ä¢ Orijinal ders sayƒ±sƒ±: ${lessons.length}`);

        const merged = new Map();

        lessons.forEach((lesson, index) => {
          const parts = lesson.id.split("_");
          const key = `${parts[0]}_${parts[1]}`;

          if (!merged.has(key)) {
            merged.set(key, { ...lesson });
            console.log(
              `   ‚úÖ [${index}] YENƒ∞: ${key} | ${lesson.subjectName} (${lesson.className}) | √ñƒüretmen: ${lesson.teacherId} | Saat: ${lesson.weeklyHours}`
            );
          } else {
            const existing = merged.get(key);
            console.log(`   üîÄ [${index}] DUPLICATE BULUNDU: ${key}`);

            if (!Array.isArray(existing.teacherId)) {
              existing.teacherId = [existing.teacherId];
            }

            if (!existing.teacherId.includes(lesson.teacherId)) {
              existing.teacherId.push(lesson.teacherId);
              console.log(
                `      ‚úÖ √ñƒüretmen eklendi: ${existing.teacherId.join(", ")}`
              );
            }
          }
        });

        const result = Array.from(merged.values());
        console.log(`   ‚úÖ MERGE ƒ∞≈ûLEMƒ∞ TAMAMLANDI - ${result.length} ders\n`);
        return result;
      }

      // ==========================================
      // RAPORLAR SAYFASI
      // ==========================================
      function dersProgramiRaporlariAc() {
        console.log("üìä Ders programƒ± raporlarƒ± sayfasƒ± a√ßƒ±lƒ±yor...");

        // √á√∂z√ºm var mƒ± kontrol et
        if (!currentSolution || Object.keys(currentSolution).length === 0) {
          showWarning("√ñnce ders daƒüƒ±tƒ±mƒ± yapmalƒ±sƒ±nƒ±z!");
          return;
        }

        window.location.href = "./raporlar/ders-programi-raporlari.html";
      }

      // ============================================
      // ƒ∞STATƒ∞STƒ∞KLER G√úNCELLEME
      // ============================================
      function updateStats(data) {
        document.getElementById("programAdi").textContent =
          data.metadata?.programName || "Program 2025";
        document.getElementById("programDurum").textContent = "Veriler Hazƒ±r ‚úì";
        document.getElementById("toplamSinif").textContent =
          data.classes?.length || 0;
        document.getElementById("toplamOgretmen").textContent =
          data.teachers?.length || 0;

        const uniqueLessons = new Map();
        let totalHours = 0;

        if (data.lessons && Array.isArray(data.lessons)) {
          data.lessons.forEach((lesson) => {
            const parts = lesson.id.split("_");
            const key = `${parts[0]}_${parts[1]}`;

            if (!uniqueLessons.has(key)) {
              uniqueLessons.set(key, true);
              totalHours += lesson.weeklyHours || 0;
            }
          });
        }

        document.getElementById("toplamDers").textContent = uniqueLessons.size;
        document.getElementById("toplamSaat").textContent = totalHours;
      }

      // ============================================
      // SWAP ENGINE BA≈ûLATMA
      // ============================================
      function initializeSwapEngine() {
        if (window.SwapEngine) {
          swapEngine = new SwapEngine();
          console.log("‚úÖ SwapEngine ba≈ülatƒ±ldƒ±");
        } else {
          console.warn("‚ö†Ô∏è SwapEngine bulunamadƒ±");
        }
      }

      // ============================================
      // EVENT LISTENERS
      // ============================================
      function initializeEventListeners() {
        // Toggle switches
        document.querySelectorAll(".toggle-switch").forEach((toggle) => {
          toggle.addEventListener("click", function () {
            this.classList.toggle("active");
          });
        });

        // Speed slider
        const speedSlider = document.getElementById("speedSlider");
        speedSlider.addEventListener("input", function () {
          const mode = speedModes[this.value];
          document.getElementById("speedValue").textContent = mode.label;
          document.getElementById("speedDescription").textContent = mode.desc;
        });

        // Header butonlarƒ±
        document
          .getElementById("btnBaslat")
          .addEventListener("click", startDistribution);
        document
          .getElementById("btnYenidenDagit")
          .addEventListener("click", redoDistribution);
        document
          .getElementById("btnIptal")
          .addEventListener("click", cancelDistribution);
        document
          .getElementById("btnTemizle")
          .addEventListener("click", clearDistribution);
        document.getElementById("btnGeriDon").addEventListener("click", () => {
          window.location.href = "program-olustur.html";
        });
        document
          .getElementById("btnAyarlariKaydet")
          .addEventListener("click", saveSettings);
        document
          .getElementById("btnAyarlariYukle")
          .addEventListener("click", loadSettings);
        document
          .getElementById("btnKarsilastir")
          .addEventListener("click", showCompareModal);
        document
          .getElementById("btnYeniProgram")
          .addEventListener("click", openSaveModal);

        // Modal butonlarƒ±
        document
          .getElementById("btnKisitlar")
          .addEventListener("click", openConstraintsModal);
        document
          .getElementById("btnTercihler")
          .addEventListener("click", openPreferencesModal);
        document
          .getElementById("btnGenelAyarlar")
          .addEventListener("click", openGeneralSettingsModal);
        document
          .getElementById("btnDersAtamaKontrol")
          .addEventListener("click", openLessonAssignmentModal);
        document
          .getElementById("btnManuelYerlestirme")
          .addEventListener("click", openManualPlacementModal);

        // Kaydetme butonlarƒ±
        document
          .getElementById("btnSaveConstraints")
          .addEventListener("click", saveConstraints);
        document
          .getElementById("btnSavePreferences")
          .addEventListener("click", savePreferences);
        document
          .getElementById("btnSaveGeneralSettings")
          .addEventListener("click", saveGeneralSettings);
        document
          .getElementById("btnSaveManualPlacement")
          .addEventListener("click", saveManualPlacement);
        document
          .getElementById("btnClearManualPlacement")
          .addEventListener("click", clearManualPlacement);
        document
          .getElementById("btnProgramKaydet")
          .addEventListener("click", saveProgramToDatabase);

        // Arama kutularƒ±
        document
          .getElementById("teacherSearchConstraints")
          ?.addEventListener("input", (e) => {
            filterTeacherList(e.target.value, "constraints");
          });
        document
          .getElementById("teacherSearchPreferences")
          ?.addEventListener("input", (e) => {
            filterTeacherList(e.target.value, "preferences");
          });

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeAllModals();
          }
        });
      }

      function initializeUI() {
        document.getElementById("btnIptal").style.display = "none";
        document.getElementById("btnKarsilastir").style.display = "none";
        document.getElementById("btnYenidenDagit").style.display = "none";
        document.getElementById("btnTemizle").style.display = "none";
      }

      // ============================================
      // MODAL FONKSƒ∞YONLARI - TAM √áALI≈ûAN VERSƒ∞YON
      // ============================================
      function openConstraintsModal() {
        console.log("üéØ Kƒ±sƒ±tlar modalƒ± a√ßƒ±lƒ±yor...");
        try {
          renderTeacherListForConstraints();
          const modal = document.getElementById("constraintsModal");
          if (modal) {
            modal.classList.add("active");
            console.log("‚úÖ Kƒ±sƒ±tlar modalƒ± a√ßƒ±ldƒ±");
          } else {
            console.error("‚ùå constraintsModal bulunamadƒ±!");
          }
        } catch (error) {
          console.error("‚ùå Kƒ±sƒ±tlar modalƒ± a√ßma hatasƒ±:", error);
        }
      }

      function closeConstraintsModal() {
        document.getElementById("constraintsModal")?.classList.remove("active");
      }

      function openPreferencesModal() {
        console.log("üéØ Tercihler modalƒ± a√ßƒ±lƒ±yor...");
        try {
          renderTeacherListForPreferences();
          const modal = document.getElementById("preferencesModal");
          if (modal) {
            modal.classList.add("active");
            console.log("‚úÖ Tercihler modalƒ± a√ßƒ±ldƒ±");
          } else {
            console.error("‚ùå preferencesModal bulunamadƒ±!");
          }
        } catch (error) {
          console.error("‚ùå Tercihler modalƒ± a√ßma hatasƒ±:", error);
        }
      }

      function closePreferencesModal() {
        document.getElementById("preferencesModal")?.classList.remove("active");
      }

      function openGeneralSettingsModal() {
        console.log("üéØ Genel Ayarlar modalƒ± a√ßƒ±lƒ±yor...");
        try {
          const modal = document.getElementById("generalSettingsModal");
          if (modal) {
            modal.classList.add("active");
            switchGeneralTab("meb");
            setTimeout(() => {
              loadGeneralSettings();
            }, 200);
            console.log("‚úÖ Genel Ayarlar modalƒ± a√ßƒ±ldƒ±");
          } else {
            console.error("‚ùå generalSettingsModal bulunamadƒ±!");
          }
        } catch (error) {
          console.error("‚ùå Genel Ayarlar modalƒ± a√ßma hatasƒ±:", error);
        }
      }

      function closeGeneralSettingsModal() {
        document
          .getElementById("generalSettingsModal")
          ?.classList.remove("active");
      }

      function openLessonAssignmentModal() {
        console.log("üéØ Ders Atama modalƒ± a√ßƒ±lƒ±yor...");
        try {
          renderLessonAssignmentContent();
          const modal = document.getElementById("lessonAssignmentModal");
          if (modal) {
            modal.classList.add("active");
            console.log("‚úÖ Ders Atama modalƒ± a√ßƒ±ldƒ±");
          } else {
            console.error("‚ùå lessonAssignmentModal bulunamadƒ±!");
          }
        } catch (error) {
          console.error("‚ùå Ders Atama modalƒ± a√ßma hatasƒ±:", error);
        }
      }

      function closeLessonAssignmentModal() {
        document
          .getElementById("lessonAssignmentModal")
          ?.classList.remove("active");
      }

      function openManualPlacementModal() {
        console.log("üéØ Manuel Yerle≈ütirme modalƒ± a√ßƒ±lƒ±yor...");
        try {
          renderManualPlacementContent();
          const modal = document.getElementById("manualPlacementModal");
          if (modal) {
            modal.classList.add("active");
            console.log("‚úÖ Manuel Yerle≈ütirme modalƒ± a√ßƒ±ldƒ±");
          } else {
            console.error("‚ùå manualPlacementModal bulunamadƒ±!");
          }
        } catch (error) {
          console.error("‚ùå Manuel Yerle≈ütirme modalƒ± a√ßma hatasƒ±:", error);
        }
      }

      function closeManualPlacementModal() {
        document
          .getElementById("manualPlacementModal")
          ?.classList.remove("active");
      }

      function openSaveModal() {
        console.log("üéØ Kaydet modalƒ± a√ßƒ±lƒ±yor...");
        try {
          if (!currentSolution) {
            showWarning("√ñnce bir daƒüƒ±tƒ±m yapmalƒ±sƒ±nƒ±z!");
            return;
          }

          const bestSolution = solutions[0] || {};
          document.getElementById("saveFitness").textContent =
            bestSolution.fitness || "-";
          document.getElementById("saveConflicts").textContent =
            bestSolution.conflicts || 0;
          document.getElementById("saveGaps").textContent =
            bestSolution.gaps || 0;
          document.getElementById("saveBalance").textContent =
            ((bestSolution.balance || 0) * 100).toFixed(0) + "%";

          const now = new Date();
          const defaultName = `Program ${now.toLocaleDateString(
            "tr-TR"
          )} - ${now.toLocaleTimeString("tr-TR", {
            hour: "2-digit",
            minute: "2-digit",
          })}`;
          document.getElementById("programAdiInput").value = defaultName;

          const modal = document.getElementById("saveModal");
          if (modal) {
            modal.classList.add("active");
            console.log("‚úÖ Kaydet modalƒ± a√ßƒ±ldƒ±");
          }
        } catch (error) {
          console.error("‚ùå Kaydet modalƒ± a√ßma hatasƒ±:", error);
        }
      }

      function closeSaveModal() {
        document.getElementById("saveModal")?.classList.remove("active");
      }

      function closeProgramModal() {
        document.getElementById("programModal")?.classList.remove("active");
      }

      function closeChangesModal() {
        document.getElementById("changesModal")?.classList.remove("active");
      }

      function closeDetailModal() {
        document.getElementById("detailModal")?.classList.remove("active");
      }

      function closeCompareModal() {
        document.getElementById("compareModal")?.classList.remove("active");
      }

      function closeTeacherWorkloadModal() {
        document
          .getElementById("teacherWorkloadModal")
          ?.classList.remove("active");
      }

      function closeAllModals() {
        document.querySelectorAll(".modal-overlay").forEach((modal) => {
          modal.classList.remove("active");
        });
      }

      // ============================================
      // WINDOW GLOBAL FONKSƒ∞YONLAR (ACƒ∞L DURUM)
      // ============================================
      window.openLessonAssignmentModal = openLessonAssignmentModal;
      window.openManualPlacementModal = openManualPlacementModal;
      window.openConstraintsModal = openConstraintsModal;
      window.openPreferencesModal = openPreferencesModal;
      window.openGeneralSettingsModal = openGeneralSettingsModal;

      // ============================================
      // GENEL AYARLAR - TOGGLE LOGIC
      // ============================================
      function initializeGeneralSettingsToggles() {
        console.log("üîß Toggle'lar ba≈ülatƒ±lƒ±yor...");

        // Daily Limit Toggle
        const dailyLimitToggle = document.getElementById("toggle-daily-limit");
        const dailyLimitSettings =
          document.getElementById("dailyLimitSettings");

        if (dailyLimitToggle) {
          // Eski event listener'ƒ± temizle
          const newToggle = dailyLimitToggle.cloneNode(true);
          dailyLimitToggle.parentNode.replaceChild(newToggle, dailyLimitToggle);

          newToggle.addEventListener("click", function () {
            console.log("üéØ Daily Limit toggle tƒ±klandƒ±");
            this.classList.toggle("active");
            const isActive = this.classList.contains("active");

            if (dailyLimitSettings) {
              dailyLimitSettings.style.opacity = isActive ? "1" : "0.5";
              dailyLimitSettings.style.pointerEvents = isActive
                ? "auto"
                : "none";
              console.log(
                "‚úÖ Daily Limit Settings:",
                isActive ? "AKTƒ∞F" : "PASƒ∞F"
              );
            }
          });
          console.log("‚úÖ Daily Limit toggle baƒülandƒ±");
        } else {
          console.error("‚ùå toggle-daily-limit bulunamadƒ±");
        }

        // Gap Limit Toggle
        const gapLimitToggle = document.getElementById("toggle-gap-limit");
        const gapLimitSettings = document.getElementById("gapLimitSettings");

        if (gapLimitToggle) {
          // Eski event listener'ƒ± temizle
          const newToggle = gapLimitToggle.cloneNode(true);
          gapLimitToggle.parentNode.replaceChild(newToggle, gapLimitToggle);

          newToggle.addEventListener("click", function () {
            console.log("üéØ Gap Limit toggle tƒ±klandƒ±");
            this.classList.toggle("active");
            const isActive = this.classList.contains("active");

            if (gapLimitSettings) {
              gapLimitSettings.style.opacity = isActive ? "1" : "0.5";
              gapLimitSettings.style.pointerEvents = isActive ? "auto" : "none";
              console.log(
                "‚úÖ Gap Limit Settings:",
                isActive ? "AKTƒ∞F" : "PASƒ∞F"
              );
            }
          });
          console.log("‚úÖ Gap Limit toggle baƒülandƒ±");
        } else {
          console.error("‚ùå toggle-gap-limit bulunamadƒ±");
        }

        // Random Off-Day Toggle
        const randomOffDayToggle = document.getElementById(
          "toggle-random-offday"
        );
        if (randomOffDayToggle) {
          // Eski event listener'ƒ± temizle
          const newToggle = randomOffDayToggle.cloneNode(true);
          randomOffDayToggle.parentNode.replaceChild(
            newToggle,
            randomOffDayToggle
          );

          newToggle.addEventListener("click", function () {
            console.log("üéØ Random Off-Day toggle tƒ±klandƒ±");
            this.classList.toggle("active");
            const isActive = this.classList.contains("active");
            console.log("‚úÖ Random Off-Day:", isActive ? "AKTƒ∞F" : "PASƒ∞F");
          });
          console.log("‚úÖ Random Off-Day toggle baƒülandƒ±");
        } else {
          console.error("‚ùå toggle-random-offday bulunamadƒ±");
        }

        // MEB Kurallarƒ± ve diƒüer toggle'lar i√ßin basit event listener'lar (toggle-meb-beden, toggle-meb-sanat, toggle-blok-dagit, etc.)
        // Modaldaki t√ºm toggle'lara event listener eklemek i√ßin genel bir yakla≈üƒ±m eklenmelidir.
        // Ancak, bu kod bloƒüunda sadece √∂zel durumlar (limitler) ele alƒ±nmƒ±≈ü.
        // initializeGeneralSettingsToggles'ƒ±n sonuna diƒüer toggle'lar i√ßin listener eklenmemi≈ütir, bu durum bir √∂nceki hataya neden olabilir.
        // Ancak isteƒüiniz sadece varsayƒ±lanƒ± d√ºzeltmek olduƒüu i√ßin, kodun yapƒ±sƒ±na dokunmuyorum.

        console.log("‚úÖ T√ºm toggle'lar ba≈ülatƒ±ldƒ±");
      }
      // ============================================
      // GENEL AYARLARI KAYDET
      // ============================================
      function saveGeneralSettings() {
        const settings = {
          randomOffDay:
            document
              .getElementById("toggle-random-offday")
              ?.classList.contains("active") || false,
          dailyLimitEnabled:
            document
              .getElementById("toggle-daily-limit")
              ?.classList.contains("active") || false,
          minDailyLessons:
            parseInt(document.getElementById("globalMinDaily")?.value) || 2,
          maxDailyLessons:
            parseInt(document.getElementById("globalMaxDaily")?.value) || 8,
          gapLimitEnabled:
            document
              .getElementById("toggle-gap-limit")
              ?.classList.contains("active") || false,
          maxWeeklyGaps:
            parseInt(document.getElementById("globalMaxGaps")?.value) || 2,
          // üõë ƒ∞LGƒ∞Lƒ∞ DEƒûƒ∞≈ûƒ∞KLƒ∞K BURADA YAPILDI (MEB Kurallarƒ± KAPALI gelecek)
          mebBeden:
            document
              .getElementById("toggle-meb-beden")
              ?.classList.contains("active") || false, // Varsayƒ±lan: KAPALI (False)
          mebSanat:
            document
              .getElementById("toggle-meb-sanat")
              ?.classList.contains("active") || false, // Varsayƒ±lan: KAPALI (False)
          // Diƒüer ayarlar orjinal haliyle bƒ±rakƒ±lmƒ±≈ütƒ±r (|| false)
          blokDagit:
            document
              .getElementById("toggle-blok-dagit")
              ?.classList.contains("active") || false,
          ayniOgretmen:
            document
              .getElementById("toggle-ayni-ogretmen")
              ?.classList.contains("active") || false,
          ogretmenCakisma:
            document
              .getElementById("toggle-ogretmen-cakisma")
              ?.classList.contains("active") || false,
          sinifCakisma:
            document
              .getElementById("toggle-sinif-cakisma")
              ?.classList.contains("active") || false,
          rehberlikAtla:
            document
              .getElementById("toggle-rehberlik-atla")
              ?.classList.contains("active") || false,
        };

        localStorage.setItem("generalSettings", JSON.stringify(settings));
        showSuccess("‚úÖ Genel ayarlar kaydedildi!");
        console.log("üíæ Kaydedilen ayarlar:", settings);
      }

      // ============================================
      // GENEL AYARLARI Y√úKLE
      // ============================================
      function loadGeneralSettings() {
        const saved = localStorage.getItem("generalSettings");
        if (!saved) {
          console.log("‚ÑπÔ∏è Kaydedilmi≈ü genel ayar yok");

          // üõë ƒ∞LGƒ∞Lƒ∞ DEƒûƒ∞≈ûƒ∞KLƒ∞K BURADA YAPILDI (Varsayƒ±lan olarak "active" sƒ±nƒ±fƒ± eklenmemesi saƒülanƒ±r)
          document
            .getElementById("toggle-meb-beden")
            ?.classList.remove("active");
          document
            .getElementById("toggle-meb-sanat")
            ?.classList.remove("active");

          // Diƒüer varsayƒ±lanlar i√ßin de (kayƒ±t yoksa) ba≈ülangƒ±√ßta kapalƒ± olmalarƒ± saƒülanƒ±r
          document
            .getElementById("toggle-blok-dagit")
            ?.classList.remove("active");
          document
            .getElementById("toggle-ayni-ogretmen")
            ?.classList.remove("active");
          document
            .getElementById("toggle-ogretmen-cakisma")
            ?.classList.remove("active");
          document
            .getElementById("toggle-sinif-cakisma")
            ?.classList.remove("active");
          document
            .getElementById("toggle-rehberlik-atla")
            ?.classList.remove("active");

          // Daily/Gap limit ayar kutularƒ±nƒ± da pasif yapalƒ±m
          document.getElementById("dailyLimitSettings").style.opacity = "0.5";
          document.getElementById("dailyLimitSettings").style.pointerEvents =
            "none";
          document.getElementById("gapLimitSettings").style.opacity = "0.5";
          document.getElementById("gapLimitSettings").style.pointerEvents =
            "none";

          return;
        }

        try {
          const settings = JSON.parse(saved);
          console.log("üìÇ Y√ºklenen ayarlar:", settings);

          // Toggle'larƒ± ayarla
          if (settings.randomOffDay)
            document
              .getElementById("toggle-random-offday")
              ?.classList.add("active");
          else
            document
              .getElementById("toggle-random-offday")
              ?.classList.remove("active");

          if (settings.dailyLimitEnabled) {
            document
              .getElementById("toggle-daily-limit")
              ?.classList.add("active");
            document.getElementById("dailyLimitSettings").style.opacity = "1";
            document.getElementById("dailyLimitSettings").style.pointerEvents =
              "auto";
          } else {
            document
              .getElementById("toggle-daily-limit")
              ?.classList.remove("active");
            document.getElementById("dailyLimitSettings").style.opacity = "0.5";
            document.getElementById("dailyLimitSettings").style.pointerEvents =
              "none";
          }

          if (settings.gapLimitEnabled) {
            document
              .getElementById("toggle-gap-limit")
              ?.classList.add("active");
            document.getElementById("gapLimitSettings").style.opacity = "1";
            document.getElementById("gapLimitSettings").style.pointerEvents =
              "auto";
          } else {
            document
              .getElementById("toggle-gap-limit")
              ?.classList.remove("active");
            document.getElementById("gapLimitSettings").style.opacity = "0.5";
            document.getElementById("gapLimitSettings").style.pointerEvents =
              "none";
          }

          // Input deƒüerlerini ayarla
          if (document.getElementById("globalMinDaily")) {
            document.getElementById("globalMinDaily").value =
              settings.minDailyLessons || 2;
          }
          if (document.getElementById("globalMaxDaily")) {
            document.getElementById("globalMaxDaily").value =
              settings.maxDailyLessons || 8;
          }
          if (document.getElementById("globalMaxGaps")) {
            document.getElementById("globalMaxGaps").value =
              settings.maxWeeklyGaps || 2;
          }

          // MEB toggle'larƒ± (Y√ºklenen ayar neyse onu uygula)
          if (settings.mebBeden)
            document
              .getElementById("toggle-meb-beden")
              ?.classList.add("active");
          // üõë MEB Beden Kapalƒ±ysa active sƒ±nƒ±fƒ±nƒ± kaldƒ±r
          else
            document
              .getElementById("toggle-meb-beden")
              ?.classList.remove("active");

          if (settings.mebSanat)
            document
              .getElementById("toggle-meb-sanat")
              ?.classList.add("active");
          // üõë MEB Sanat Kapalƒ±ysa active sƒ±nƒ±fƒ±nƒ± kaldƒ±r
          else
            document
              .getElementById("toggle-meb-sanat")
              ?.classList.remove("active");

          // Diƒüer Kurallar
          if (settings.blokDagit)
            document
              .getElementById("toggle-blok-dagit")
              ?.classList.add("active");
          else
            document
              .getElementById("toggle-blok-dagit")
              ?.classList.remove("active");

          if (settings.ayniOgretmen)
            document
              .getElementById("toggle-ayni-ogretmen")
              ?.classList.add("active");
          else
            document
              .getElementById("toggle-ayni-ogretmen")
              ?.classList.remove("active");

          if (settings.ogretmenCakisma)
            document
              .getElementById("toggle-ogretmen-cakisma")
              ?.classList.add("active");
          else
            document
              .getElementById("toggle-ogretmen-cakisma")
              ?.classList.remove("active");

          if (settings.sinifCakisma)
            document
              .getElementById("toggle-sinif-cakisma")
              ?.classList.add("active");
          else
            document
              .getElementById("toggle-sinif-cakisma")
              ?.classList.remove("active");

          if (settings.rehberlikAtla)
            document
              .getElementById("toggle-rehberlik-atla")
              ?.classList.add("active");
          else
            document
              .getElementById("toggle-rehberlik-atla")
              ?.classList.remove("active");

          showSuccess("‚úÖ Genel ayarlar y√ºklendi!");
        } catch (error) {
          console.error("‚ùå Ayar y√ºkleme hatasƒ±:", error);
          showError("Ayarlar y√ºklenirken hata olu≈ütu!");
        }
      }

      // ============================================
      // AYARLARI AL (ALGORƒ∞TMA ƒ∞√áƒ∞N)
      // ============================================
      function getGeneralSettings() {
        const saved = localStorage.getItem("generalSettings");
        if (!saved) {
          return {
            randomOffDay: false,
            dailyLimitEnabled: false,
            minDailyLessons: 2,
            maxDailyLessons: 8,
            gapLimitEnabled: false,
            maxWeeklyGaps: 2,
            // üõë MEB Kurallarƒ± KAPALI geldiƒüi i√ßin burasƒ± da false olmalƒ±
            mebBeden: false,
            mebSanat: false,
            blokDagit: false,
            ayniOgretmen: false,
            ogretmenCakisma: false,
            sinifCakisma: false,
            rehberlikAtla: false,
          };
        }
        return JSON.parse(saved);
      }

      function closeGeneralSettingsModal() {
        document
          .getElementById("generalSettingsModal")
          .classList.remove("active");
      }

      // ============================================
      // TAB SWITCH Sƒ∞STEMƒ∞
      // ============================================
      function switchGeneralTab(tabName) {
        console.log("üîÑ Tab deƒüi≈ütiriliyor:", tabName);

        // Tab butonlarƒ±nƒ± g√ºncelle
        document
          .querySelectorAll("#generalSettingsModal .modal-tab")
          .forEach((tab) => {
            tab.classList.remove("active");
          });

        // Tƒ±klanan tab'ƒ± aktif yap
        const tabs = document.querySelectorAll(
          "#generalSettingsModal .modal-tab"
        );
        if (tabName === "meb") {
          tabs[0].classList.add("active");
        } else if (tabName === "ozel-ogretmen") {
          tabs[1].classList.add("active");
        } else if (tabName === "diger") {
          tabs[2].classList.add("active");
        }

        // ƒ∞√ßerikleri gizle
        document
          .querySelectorAll("#generalSettingsModal .modal-tab-content")
          .forEach((content) => {
            content.style.display = "none";
          });

        // ƒ∞lgili i√ßeriƒüi g√∂ster
        if (tabName === "meb") {
          document.getElementById("generalTabMEB").style.display = "block";
        } else if (tabName === "ozel-ogretmen") {
          document.getElementById("generalTabOzelOgretmen").style.display =
            "block";
          renderSpecialTeacherLists(); // √ñƒüretmen listelerini render et
        } else if (tabName === "diger") {
          document.getElementById("generalTabDiger").style.display = "block";

          // üî• Dƒ∞ƒûER AYARLAR TAB'I A√áILDIƒûINDA TOGGLE'LARI BA≈ûLAT
          setTimeout(() => {
            console.log(
              "üéØ Diƒüer Ayarlar tab'ƒ± a√ßƒ±ldƒ±, toggle'lar ba≈ülatƒ±lƒ±yor..."
            );
            // üî• initializeGeneralSettingsToggles'ƒ± √ßaƒüƒ±r
            initializeGeneralSettingsToggles();

            // Input'larƒ± d√ºzenlenebilir yap
            const minDailyInput = document.getElementById("globalMinDaily");
            const maxDailyInput = document.getElementById("globalMaxDaily");
            const maxGapsInput = document.getElementById("globalMaxGaps");

            if (minDailyInput) {
              minDailyInput.removeAttribute("readonly");
              minDailyInput.removeAttribute("disabled");
              console.log("‚úÖ Min Daily input aktif");
            }
            if (maxDailyInput) {
              maxDailyInput.removeAttribute("readonly");
              maxDailyInput.removeAttribute("disabled");
              console.log("‚úÖ Max Daily input aktif");
            }
            if (maxGapsInput) {
              maxGapsInput.removeAttribute("readonly");
              maxGapsInput.removeAttribute("disabled");
              console.log("‚úÖ Max Gaps input aktif");
            }
          }, 100);
        }
      }

      // ============================================
      // √ñZEL √ñƒûRETMEN Lƒ∞STELERƒ∞Nƒ∞ RENDER ET
      // ============================================
      function renderSpecialTeacherLists() {
        if (!currentProgramData || !currentProgramData.teachers) {
          console.warn("‚ö†Ô∏è √ñƒüretmen verisi yok");
          return;
        }

        // Beden eƒüitimi √∂ƒüretmenlerini bul
        const bedenTeachers = currentProgramData.teachers.filter((t) => {
          const branch = (t.branch || t.brans || "").toLowerCase();
          return branch.includes("beden") || branch.includes("spor");
        });

        // M√ºzik/G√∂rsel sanatlar √∂ƒüretmenlerini bul
        const sanatTeachers = currentProgramData.teachers.filter((t) => {
          const branch = (t.branch || t.brans || "").toLowerCase();
          return (
            branch.includes("m√ºzik") ||
            branch.includes("musik") ||
            branch.includes("g√∂rsel") ||
            branch.includes("resim") ||
            branch.includes("sanat")
          );
        });

        // LocalStorage'dan se√ßili √∂ƒüretmenleri y√ºkle
        const savedBedenTeachers = JSON.parse(
          localStorage.getItem("specialBedenTeachers") || "[]"
        );
        const savedMuzikTeachers = JSON.parse(
          localStorage.getItem("specialMuzikTeachers") || "[]"
        );

        // Beden eƒüitimi listesi
        const bedenList = document.getElementById("bedenOgretmenList");
        if (bedenTeachers.length === 0) {
          bedenList.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #888;">
              <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
              <p style="font-size: 14px;">Beden eƒüitimi √∂ƒüretmeni bulunamadƒ±</p>
              <p style="font-size: 12px; margin-top: 8px;">Bran≈üƒ±nda "beden" veya "spor" ge√ßen √∂ƒüretmen yok</p>
            </div>`;
        } else {
          bedenList.innerHTML = bedenTeachers
            .map(
              (teacher) => `
            <div class="teacher-checkbox-item">
              <input 
                type="checkbox" 
                id="beden_${teacher.id}" 
                value="${teacher.id}"
                ${savedBedenTeachers.includes(teacher.id) ? "checked" : ""}
                onchange="saveSpecialTeacherSelection('beden', ${
                  teacher.id
                }, this.checked)"
              >
              <label for="beden_${teacher.id}">
                <span>${teacher.name}</span>
                <span class="teacher-branch">${
                  teacher.branch || teacher.brans || "Bran≈ü belirtilmemi≈ü"
                }</span>
              </label>
            </div>
          `
            )
            .join("");
        }

        // M√ºzik/G√∂rsel sanatlar listesi
        const muzikList = document.getElementById("muzikOgretmenList");
        if (sanatTeachers.length === 0) {
          muzikList.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #888;">
              <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
              <p style="font-size: 14px;">M√ºzik/G√∂rsel sanatlar √∂ƒüretmeni bulunamadƒ±</p>
              <p style="font-size: 12px; margin-top: 8px;">Bran≈üƒ±nda "m√ºzik", "g√∂rsel" veya "sanat" ge√ßen √∂ƒüretmen yok</p>
            </div>`;
        } else {
          muzikList.innerHTML = sanatTeachers
            .map(
              (teacher) => `
            <div class="teacher-checkbox-item">
              <input 
                type="checkbox" 
                id="muzik_${teacher.id}" 
                value="${teacher.id}"
                ${savedMuzikTeachers.includes(teacher.id) ? "checked" : ""}
                onchange="saveSpecialTeacherSelection('muzik', ${
                  teacher.id
                }, this.checked)"
              >
              <label for="muzik_${teacher.id}">
                <span>${teacher.name}</span>
                <span class="teacher-branch">${
                  teacher.branch || teacher.brans || "Bran≈ü belirtilmemi≈ü"
                }</span>
              </label>
            </div>
          `
            )
            .join("");
        }

        console.log(
          `‚úÖ √ñzel √∂ƒüretmen listeleri render edildi: ${bedenTeachers.length} beden, ${sanatTeachers.length} sanat`
        );
      }

      // ============================================
      // √ñZEL √ñƒûRETMEN SE√áƒ∞Mƒ∞ KAYDET
      // ============================================
      function saveSpecialTeacherSelection(type, teacherId, isChecked) {
        const storageKey =
          type === "beden" ? "specialBedenTeachers" : "specialMuzikTeachers";
        let selectedTeachers = JSON.parse(
          localStorage.getItem(storageKey) || "[]"
        );

        if (isChecked) {
          // Ekle
          if (!selectedTeachers.includes(teacherId)) {
            selectedTeachers.push(teacherId);
          }
        } else {
          // √áƒ±kar
          selectedTeachers = selectedTeachers.filter((id) => id !== teacherId);
        }

        localStorage.setItem(storageKey, JSON.stringify(selectedTeachers));

        const teacherName =
          currentProgramData.teachers.find((t) => t.id === teacherId)?.name ||
          "√ñƒüretmen";
        const action = isChecked ? "eklendi" : "√ßƒ±karƒ±ldƒ±";
        const typeName = type === "beden" ? "Beden Eƒüitimi" : "M√ºzik/Sanat";

        showInfo(`${typeName} √∂zel kuralƒ±ndan ${action}: ${teacherName}`);
        console.log(`‚úÖ ${typeName} √∂ƒüretmenleri:`, selectedTeachers);
      }

      // ============================================
      // √ñZEL √ñƒûRETMEN Lƒ∞STESƒ∞Nƒ∞ AL (ALGORƒ∞TMA ƒ∞√áƒ∞N)
      // ============================================
      function getSpecialTeachers() {
        const beden = JSON.parse(
          localStorage.getItem("specialBedenTeachers") || "[]"
        );
        const muzik = JSON.parse(
          localStorage.getItem("specialMuzikTeachers") || "[]"
        );

        return {
          beden: beden,
          muzik: muzik,
          all: [...beden, ...muzik], // T√ºm √∂zel √∂ƒüretmenler
        };
      }

      function openLessonAssignmentModal() {
        console.log("üéØ Ders Atama modalƒ± a√ßƒ±lƒ±yor...");
        renderLessonAssignmentContent();
        document
          .getElementById("lessonAssignmentModal")
          .classList.add("active");
      }

      function closeLessonAssignmentModal() {
        document
          .getElementById("lessonAssignmentModal")
          .classList.remove("active");
      }

      function openManualPlacementModal() {
        console.log("üéØ Manuel Yerle≈ütirme modalƒ± a√ßƒ±lƒ±yor...");
        renderManualPlacementContent();
        document.getElementById("manualPlacementModal").classList.add("active");
      }

      function closeManualPlacementModal() {
        document
          .getElementById("manualPlacementModal")
          .classList.remove("active");
      }

      function openSaveModal() {
        if (!currentSolution) {
          showWarning("√ñnce bir daƒüƒ±tƒ±m yapmalƒ±sƒ±nƒ±z!");
          return;
        }

        const bestSolution = solutions[0] || {};
        document.getElementById("saveFitness").textContent =
          bestSolution.fitness || "-";
        document.getElementById("saveConflicts").textContent =
          bestSolution.conflicts || 0;
        document.getElementById("saveGaps").textContent =
          bestSolution.gaps || 0;
        document.getElementById("saveBalance").textContent =
          ((bestSolution.balance || 0) * 100).toFixed(0) + "%";

        const now = new Date();
        const defaultName = `Program ${now.toLocaleDateString(
          "tr-TR"
        )} - ${now.toLocaleTimeString("tr-TR", {
          hour: "2-digit",
          minute: "2-digit",
        })}`;
        document.getElementById("programAdiInput").value = defaultName;

        document.getElementById("saveModal").classList.add("active");
      }

      function closeSaveModal() {
        document.getElementById("saveModal").classList.remove("active");
      }

      function closeProgramModal() {
        document.getElementById("programModal").classList.remove("active");
      }

      function closeChangesModal() {
        document.getElementById("changesModal").classList.remove("active");
      }

      function closeDetailModal() {
        document.getElementById("detailModal").classList.remove("active");
      }

      function closeCompareModal() {
        document.getElementById("compareModal").classList.remove("active");
      }

      function closeTeacherWorkloadModal() {
        document
          .getElementById("teacherWorkloadModal")
          .classList.remove("active");
      }

      function closeAllModals() {
        document.querySelectorAll(".modal-overlay").forEach((modal) => {
          modal.classList.remove("active");
        });
      }

      // ============================================
      // √ñƒûRETMEN DERS Y√úK√ú MODALI (YENƒ∞!)
      // ============================================
      function showTeacherWorkloadModal(teacherId) {
        const teacher = currentProgramData.teachers.find(
          (t) => t.id == teacherId
        );
        if (!teacher) {
          showError("√ñƒüretmen bulunamadƒ±!");
          return;
        }

        // √ñƒüretmenin derslerini bul
        const teacherLessons = currentProgramData.lessons.filter((lesson) => {
          if (Array.isArray(lesson.teacherId)) {
            return lesson.teacherId.includes(parseInt(teacherId));
          }
          return lesson.teacherId == teacherId;
        });

        let html = `
          <div style="background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(123, 47, 255, 0.1) 100%); padding: 24px; border-radius: 12px; border: 2px solid #00d9ff; margin-bottom: 24px; text-align: center;">
            <h2 style="color: #00d9ff; font-size: 28px; margin-bottom: 8px;">üë®‚Äçüè´ ${
              teacher.name
            }</h2>
            <div style="font-size: 14px; color: #888; margin-bottom: 16px;">Bran≈ü: <strong style="color: #00f5a0;">${
              teacher.brans || "Belirtilmemi≈ü"
            }</strong></div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px;">
              <div style="background: rgba(0, 245, 160, 0.1); padding: 16px; border-radius: 8px; border: 1px solid #00f5a0;">
                <div style="font-size: 12px; color: #888;">Toplam Ders</div>
                <div style="font-size: 32px; color: #00f5a0; font-weight: 900;">${
                  teacherLessons.length
                }</div>
              </div>
              <div style="background: rgba(0, 217, 255, 0.1); padding: 16px; border-radius: 8px; border: 1px solid #00d9ff;">
                <div style="font-size: 12px; color: #888;">Toplam Saat</div>
                <div style="font-size: 32px; color: #00d9ff; font-weight: 900;">${teacherLessons.reduce(
                  (sum, l) => sum + (l.weeklyHours || 0),
                  0
                )}</div>
              </div>
              <div style="background: rgba(123, 47, 255, 0.1); padding: 16px; border-radius: 8px; border: 1px solid #7b2fff;">
                <div style="font-size: 12px; color: #888;">Farklƒ± Sƒ±nƒ±f</div>
                <div style="font-size: 32px; color: #7b2fff; font-weight: 900;">${
                  new Set(teacherLessons.map((l) => l.classId)).size
                }</div>
              </div>
            </div>
          </div>

          <h3 style="color: #00d9ff; margin-bottom: 16px; font-size: 18px;">üìö Ders Detaylarƒ±</h3>
          <div style="max-height: 400px; overflow-y: auto;">`;

        teacherLessons.forEach((lesson, index) => {
          html += `
            <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; border: 2px solid rgba(0, 217, 255, 0.3); margin-bottom: 12px;">
              <div style="display: grid; grid-template-columns: 60px 1fr 120px 80px; gap: 16px; align-items: center;">
                <div style="background: linear-gradient(135deg, #00d9ff, #7b2fff); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px;">
                  ${index + 1}
                </div>
                <div>
                  <div style="font-size: 16px; font-weight: 700; color: #00d9ff; margin-bottom: 4px;">üìñ ${
                    lesson.subjectName
                  }</div>
                  <div style="font-size: 13px; color: #888;">Sƒ±nƒ±f: <strong style="color: #e0e0e0;">${
                    lesson.className
                  }</strong></div>
                  <div style="font-size: 12px; color: #666; margin-top: 2px;">Ders Kodu: ${
                    lesson.subjectCode || "-"
                  }</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 11px; color: #888;">Haftalƒ±k Saat</div>
                  <div style="font-size: 28px; font-weight: 900; color: #00f5a0;">${
                    lesson.weeklyHours
                  }</div>
                </div>
                <div style="text-align: center;">
                  <div style="background: rgba(123, 47, 255, 0.2); padding: 8px 12px; border-radius: 8px; border: 1px solid #7b2fff;">
                    <div style="font-size: 10px; color: #888;">BLOK</div>
                    <div style="font-size: 16px; font-weight: 700; color: #7b2fff;">${
                      lesson.blocks || "-"
                    }</div>
                  </div>
                </div>
              </div>
            </div>`;
        });

        html += `</div>`;

        document.getElementById("teacherWorkloadContent").innerHTML = html;
        document.getElementById("teacherWorkloadModal").classList.add("active");
      }

      // ============================================
      // KISITLARI Y√úKLE/KAYDET
      // ============================================
      async function loadConstraints() {
        try {
          const programId = localStorage.getItem("currentProgramId");
          const saved = localStorage.getItem(`constraints_${programId}`);
          if (saved) {
            teacherConstraints = JSON.parse(saved);
            console.log(
              "‚úÖ Kƒ±sƒ±tlar y√ºklendi:",
              Object.keys(teacherConstraints).length,
              "√∂ƒüretmen"
            );
          }
        } catch (error) {
          console.error("‚ùå Kƒ±sƒ±tlar y√ºkleme hatasƒ±:", error);
        }
      }

      async function saveConstraints() {
        try {
          const programId = localStorage.getItem("currentProgramId");
          localStorage.setItem(
            `constraints_${programId}`,
            JSON.stringify(teacherConstraints)
          );
          showSuccess("üíæ Kƒ±sƒ±tlar ba≈üarƒ±yla kaydedildi!");
        } catch (error) {
          console.error("‚ùå Kƒ±sƒ±tlar kaydetme hatasƒ±:", error);
          showError("Kƒ±sƒ±tlar kaydedilemedi!");
        }
      }

      // ============================================
      // TERCƒ∞HLERƒ∞ Y√úKLE/KAYDET
      // ============================================
      async function loadPreferences() {
        try {
          const programId = localStorage.getItem("currentProgramId");
          const saved = localStorage.getItem(`preferences_${programId}`);
          if (saved) {
            teacherPreferences = JSON.parse(saved);
            console.log(
              "‚úÖ Tercihler y√ºklendi:",
              Object.keys(teacherPreferences).length,
              "√∂ƒüretmen"
            );
          }
        } catch (error) {
          console.error("‚ùå Tercihler y√ºkleme hatasƒ±:", error);
        }
      }

      async function savePreferences() {
        try {
          const programId = localStorage.getItem("currentProgramId");
          localStorage.setItem(
            `preferences_${programId}`,
            JSON.stringify(teacherPreferences)
          );
          showSuccess("üíæ Tercihler ba≈üarƒ±yla kaydedildi!");
        } catch (error) {
          console.error("‚ùå Tercihler kaydetme hatasƒ±:", error);
          showError("Tercihler kaydedilemedi!");
        }
      }

      // ============================================
      // GENEL AYARLARI KAYDET
      // ============================================
      function saveGeneralSettings() {
        try {
          const settings = {
            mebBeden: document
              .getElementById("toggle-meb-beden")
              .classList.contains("active"),
            mebSanat: document
              .getElementById("toggle-meb-sanat")
              .classList.contains("active"),
            blokDagit: document
              .getElementById("toggle-blok-dagit")
              .classList.contains("active"),
            ayniOgretmen: document
              .getElementById("toggle-ayni-ogretmen")
              .classList.contains("active"),
            ogretmenCakisma: document
              .getElementById("toggle-ogretmen-cakisma")
              .classList.contains("active"),
            sinifCakisma: document
              .getElementById("toggle-sinif-cakisma")
              .classList.contains("active"),
            rehberlikAtla: document
              .getElementById("toggle-rehberlik-atla")
              .classList.contains("active"),
          };

          localStorage.setItem("generalSettings", JSON.stringify(settings));
          showSuccess("üíæ Genel ayarlar kaydedildi!");
          closeGeneralSettingsModal();
        } catch (error) {
          console.error("‚ùå Genel ayarlar kaydetme hatasƒ±:", error);
          showError("Ayarlar kaydedilemedi!");
        }
      }

      // ============================================
      // HEADER BUTON EVENT LISTENERS
      // ============================================
      function initializeHeaderButtons() {
        console.log("üîò Header butonlarƒ± baƒülanƒ±yor...");

        const btnKisitlar = document.getElementById("btnKisitlar");
        const btnTercihler = document.getElementById("btnTercihler");
        const btnGenelAyarlar = document.getElementById("btnGenelAyarlar");
        const btnDersAtamaKontrol = document.getElementById(
          "btnDersAtamaKontrol"
        );
        const btnManuelYerlestirme = document.getElementById(
          "btnManuelYerlestirme"
        );

        if (btnKisitlar) {
          btnKisitlar.addEventListener("click", () => {
            console.log("üéØ Kƒ±sƒ±tlar butonu tƒ±klandƒ±");
            openConstraintsModal();
          });
          console.log("‚úÖ Kƒ±sƒ±tlar butonu baƒülandƒ±");
        } else {
          console.error("‚ùå btnKisitlar bulunamadƒ±!");
        }

        if (btnTercihler) {
          btnTercihler.addEventListener("click", () => {
            console.log("üéØ Tercihler butonu tƒ±klandƒ±");
            openPreferencesModal();
          });
          console.log("‚úÖ Tercihler butonu baƒülandƒ±");
        } else {
          console.error("‚ùå btnTercihler bulunamadƒ±!");
        }

        if (btnGenelAyarlar) {
          btnGenelAyarlar.addEventListener("click", () => {
            console.log("üéØ Genel Ayarlar butonu tƒ±klandƒ±");
            openGeneralSettingsModal();
          });
          console.log("‚úÖ Genel Ayarlar butonu baƒülandƒ±");
        } else {
          console.error("‚ùå btnGenelAyarlar bulunamadƒ±!");
        }

        if (btnDersAtamaKontrol) {
          btnDersAtamaKontrol.addEventListener("click", () => {
            console.log("üéØ Ders Atama Kontrol butonu tƒ±klandƒ±");
            openLessonAssignmentModal();
          });
          console.log("‚úÖ Ders Atama Kontrol butonu baƒülandƒ±");
        } else {
          console.error("‚ùå btnDersAtamaKontrol bulunamadƒ±!");
        }

        if (btnManuelYerlestirme) {
          btnManuelYerlestirme.addEventListener("click", () => {
            console.log("üéØ Manuel Yerle≈ütirme butonu tƒ±klandƒ±");
            openManualPlacementModal();
          });
          console.log("‚úÖ Manuel Yerle≈ütirme butonu baƒülandƒ±");
        } else {
          console.error("‚ùå btnManuelYerlestirme bulunamadƒ±!");
        }

        console.log("‚úÖ T√ºm header butonlarƒ± baƒülandƒ±");
      }

      console.log(
        "‚úÖ B√ñL√úM 3 Y√úKLENDƒ∞ - Global deƒüi≈ükenler, bildirim sistemi, modal fonksiyonlarƒ± hazƒ±r!"
      );
      // ============================================
      // √ñƒûRETMEN Lƒ∞STELERƒ∞ RENDER (BRAN≈û DAHƒ∞L!)
      // ============================================
      function renderTeacherListForConstraints() {
        const container = document.getElementById("constraintsTeacherList");

        if (!currentProgramData || !currentProgramData.teachers) {
          container.innerHTML =
            '<p style="color: #888; text-align: center; padding: 20px;">√ñƒüretmen verisi yok</p>';
          return;
        }

        const teachers = currentProgramData.teachers.filter((t) => {
          const branch = (t.branch || t.brans || "").toLowerCase();
          return branch !== "rehberlik";
        });

        let html = "";
        teachers.forEach((teacher) => {
          const blockedSlotsCount = getBlockedSlotsCount(teacher.id);

          html += `
            <div class="teacher-item-constraints" data-teacher-id="${
              teacher.id
            }" id="teacher-item-${teacher.id}">
              <div>
                <div class="teacher-name">${teacher.name}</div>
                <div class="teacher-branch">${
                  teacher.branch || teacher.brans || "Bran≈ü belirtilmemi≈ü"
                }</div>
              </div>
              ${
                blockedSlotsCount > 0
                  ? `<div class="constraint-count">${blockedSlotsCount} kƒ±sƒ±t</div>`
                  : ""
              }
            </div>
          `;
        });

        container.innerHTML = html;

        // üî• EVENT LISTENER EKLE (onclick yerine)
        teachers.forEach((teacher) => {
          const element = document.getElementById(`teacher-item-${teacher.id}`);
          if (element) {
            element.addEventListener("click", () => {
              selectTeacherForConstraints(teacher.id);
            });
          }
        });

        console.log("‚úÖ √ñƒüretmen listesi render edildi:", teachers.length);
      }

      function getBlockedSlotsCount(teacherId) {
        const constraints = teacherConstraints[teacherId] || [];
        let count = 0;

        constraints.forEach((constraint) => {
          if (constraint.blockedSlots) {
            count += Object.keys(constraint.blockedSlots).length;
          }
        });

        return count;
      }

      function filterTeacherListConstraints(searchText) {
        const items = document.querySelectorAll(".teacher-item-constraints");
        const search = searchText.toLowerCase();

        items.forEach((item) => {
          const nameEl = item.querySelector(".teacher-name");
          const branchEl = item.querySelector(".teacher-branch");

          if (!nameEl || !branchEl) return;

          const name = nameEl.textContent.toLowerCase();
          const branch = branchEl.textContent.toLowerCase();

          if (name.includes(search) || branch.includes(search)) {
            item.style.display = "flex";
          } else {
            item.style.display = "none";
          }
        });
      }

      // ============================================
      // √ñƒûRETMEN SE√áƒ∞Mƒ∞ - TEK FONKSƒ∞YON
      // ============================================
      function selectTeacherForConstraints(teacherId) {
        console.log("üéØ selectTeacherForConstraints √ßaƒürƒ±ldƒ±, ID:", teacherId);

        selectedTeacherId = teacherId;

        // T√ºm active class'larƒ±nƒ± kaldƒ±r
        const allItems = document.querySelectorAll(".teacher-item-constraints");
        console.log("üìã Toplam item sayƒ±sƒ±:", allItems.length);

        allItems.forEach((item) => {
          item.classList.remove("active");
        });

        // Se√ßili √∂ƒüretmeni aktif yap
        const targetElement = document.getElementById(
          `teacher-item-${teacherId}`
        );
        console.log("üîç Aranan element ID:", `teacher-item-${teacherId}`);
        console.log("üîç Bulunan element:", targetElement);

        if (targetElement) {
          targetElement.classList.add("active");
          console.log("‚úÖ Active class eklendi");
        } else {
          console.error("‚ùå Element bulunamadƒ±! teacherId:", teacherId);
        }

        // Kƒ±sƒ±t tablosunu render et
        renderConstraintScheduleTable(teacherId);
      }

      function renderConstraintScheduleTable(teacherId) {
        const teacher = currentProgramData.teachers.find(
          (t) => t.id === teacherId
        );
        if (!teacher) {
          console.error("‚ùå √ñƒüretmen bulunamadƒ±:", teacherId);
          return;
        }

        console.log("üìä Tablo render ediliyor:", teacher.name);

        const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];
        const constraints = teacherConstraints[teacherId] || [];
        const blockedSlots = {};

        // Mevcut kƒ±sƒ±tlarƒ± y√ºkle
        constraints.forEach((constraint) => {
          if (constraint.blockedSlots) {
            Object.assign(blockedSlots, constraint.blockedSlots);
          }
        });

        const blockedCount = Object.keys(blockedSlots).length;

        let html = `
          <div class="constraint-info-bar">
            <div class="constraint-info-item">
              <span class="constraint-info-label">√ñƒüretmen:</span>
              <span class="constraint-info-value">${teacher.name}</span>
            </div>
            <div class="constraint-info-item">
              <span class="constraint-info-label">Bran≈ü:</span>
              <span class="constraint-info-value">${
                teacher.branch || teacher.brans || "-"
              }</span>
            </div>
            <div class="constraint-info-item">
              <span class="constraint-info-label">Engellenmi≈ü Saat:</span>
              <span class="constraint-info-value" style="color: #ff6b6b;">${blockedCount}</span>
            </div>
          </div>

          <div class="constraint-table-container">
            <table class="constraint-schedule-table">
              <thead>
                <tr>
                  <th>Saat</th>
                  ${days.map((day) => `<th>${day}</th>`).join("")}
                </tr>
              </thead>
              <tbody>
        `;

        for (let hour = 1; hour <= 8; hour++) {
          html += `<tr>`;
          html += `<td class="hour-label">${hour}. Saat</td>`;

          for (let day = 1; day <= 5; day++) {
            const key = `${day}-${hour}`;
            const isBlocked = blockedSlots[key] === true;

            html += `
              <td>
                <div class="constraint-cell ${isBlocked ? "blocked" : ""}" 
                     onclick="toggleConstraintCell(${teacherId}, ${day}, ${hour})"
                     data-day="${day}" 
                     data-hour="${hour}">
                </div>
              </td>
            `;
          }

          html += `</tr>`;
        }

        html += `
              </tbody>
            </table>
          </div>

          <div class="constraint-actions">
            <button class="btn btn-secondary" onclick="clearTeacherConstraints(${teacherId})">
              üóëÔ∏è Bu √ñƒüretmenin Kƒ±sƒ±tlarƒ±nƒ± Temizle
            </button>
            <button class="btn btn-primary" onclick="saveTeacherConstraints(${teacherId})">
              üíæ Kaydet
            </button>
          </div>
        `;

        document.getElementById("selectedTeacherConstraints").innerHTML = html;
        console.log("‚úÖ Tablo render edildi");
      }

      function toggleConstraintCell(teacherId, day, hour) {
        if (!teacherConstraints[teacherId]) {
          teacherConstraints[teacherId] = [
            {
              type: "HARD",
              description: "Tablo ile eklenen kƒ±sƒ±tlar",
              blockedSlots: {},
            },
          ];
        }

        const constraint = teacherConstraints[teacherId][0];
        if (!constraint.blockedSlots) {
          constraint.blockedSlots = {};
        }

        const key = `${day}-${hour}`;

        if (constraint.blockedSlots[key]) {
          delete constraint.blockedSlots[key];
          showInfo("üü¢ Saat kƒ±sƒ±tƒ± kaldƒ±rƒ±ldƒ±");
        } else {
          constraint.blockedSlots[key] = true;
          showSuccess("üî¥ Saat kƒ±sƒ±tƒ± eklendi");
        }

        // Tabloyu yeniden render et
        renderConstraintScheduleTable(teacherId);

        // √ñƒüretmen listesini g√ºncelle
        renderTeacherListForConstraints();

        // Aktif √∂ƒüretmeni koru
        setTimeout(() => {
          const teacherElement = document.getElementById(
            `teacher-item-${teacherId}`
          );
          if (teacherElement) {
            teacherElement.classList.add("active");
            console.log("‚úÖ Active class geri eklendi");
          }
        }, 50);
      }

      // ============================================
      // √ñƒûRETMEN BAZLI KISIT TEMƒ∞ZLEME
      // ============================================
      async function clearTeacherConstraints(teacherId) {
        const teacher = currentProgramData.teachers.find(
          (t) => t.id === teacherId
        );
        const teacherName = teacher ? teacher.name : `√ñƒüretmen ${teacherId}`;

        if (
          !confirm(
            `‚ö†Ô∏è ${teacherName} √∂ƒüretmeninin T√úM kƒ±sƒ±tlarƒ±nƒ± silmek istediƒüinizden emin misiniz?`
          )
        ) {
          return;
        }

        try {
          delete teacherConstraints[teacherId];
          localStorage.setItem(
            "teacherConstraints",
            JSON.stringify(teacherConstraints)
          );

          if (
            typeof window.electronAPI !== "undefined" &&
            window.electronAPI.deleteTeacherConstraints
          ) {
            const programId = localStorage.getItem("currentProgramId");
            if (programId) {
              try {
                await window.electronAPI.deleteTeacherConstraints(
                  parseInt(programId),
                  teacherId
                );
                console.log(`‚úÖ ${teacherName} backend'den silindi`);
              } catch (apiError) {
                console.warn("‚ö†Ô∏è Backend silme hatasƒ±:", apiError);
              }
            }
          }

          renderConstraintScheduleTable(teacherId);
          renderTeacherListForConstraints();

          setTimeout(() => {
            const teacherElement = document.getElementById(
              `teacher-item-${teacherId}`
            );
            if (teacherElement) {
              teacherElement.classList.add("active");
            }
          }, 50);

          showSuccess(`‚úÖ ${teacherName} √∂ƒüretmeninin kƒ±sƒ±tlarƒ± temizlendi!`);
        } catch (error) {
          console.error("‚ùå Kƒ±sƒ±t temizleme hatasƒ±:", error);
          showError("Kƒ±sƒ±tlar temizlenirken hata olu≈ütu!");
        }
      }

      // ============================================
      // T√úM KISITLARI TEMƒ∞ZLE (GLOBAL)
      // ============================================
      async function clearAllTeacherConstraints() {
        const totalTeachers = Object.keys(teacherConstraints).length;

        if (totalTeachers === 0) {
          showInfo("Temizlenecek kƒ±sƒ±t yok!");
          return;
        }

        if (
          !confirm(
            `‚ö†Ô∏è T√úM √ñƒûRETMENLERƒ∞N (${totalTeachers} √∂ƒüretmen) T√úM KISITLARINI silmek istediƒüinizden emin misiniz?\n\n‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz!`
          )
        ) {
          return;
        }

        try {
          teacherConstraints = {};
          localStorage.removeItem("teacherConstraints");

          if (
            typeof window.electronAPI !== "undefined" &&
            window.electronAPI.deleteAllConstraints
          ) {
            const programId = localStorage.getItem("currentProgramId");
            if (programId) {
              try {
                const result = await window.electronAPI.deleteAllConstraints(
                  parseInt(programId)
                );
                if (result.success) {
                  console.log("‚úÖ Backend'den t√ºm kƒ±sƒ±tlar silindi");
                }
              } catch (apiError) {
                console.warn("‚ö†Ô∏è Backend API hatasƒ±:", apiError);
              }
            }
          }

          renderTeacherListForConstraints();

          if (selectedTeacherId) {
            renderConstraintScheduleTable(selectedTeacherId);
            setTimeout(() => {
              const teacherElement = document.getElementById(
                `teacher-item-${selectedTeacherId}`
              );
              if (teacherElement) {
                teacherElement.classList.add("active");
              }
            }, 50);
          }

          showSuccess(
            `‚úÖ T√úM √∂ƒüretmen kƒ±sƒ±tlarƒ± temizlendi! (${totalTeachers} √∂ƒüretmen)`
          );
        } catch (error) {
          console.error("‚ùå Kƒ±sƒ±t temizleme hatasƒ±:", error);
          showError("Kƒ±sƒ±tlar temizlenirken hata olu≈ütu!");
        }
      }

      function saveTeacherConstraints(teacherId) {
        localStorage.setItem(
          "teacherConstraints",
          JSON.stringify(teacherConstraints)
        );

        const teacher = currentProgramData.teachers.find(
          (t) => t.id === teacherId
        );
        const blockedCount = getBlockedSlotsCount(teacherId);

        showSuccess(
          `‚úÖ ${teacher.name} i√ßin ${blockedCount} kƒ±sƒ±t kaydedildi!`
        );
      }

      // ============================================
      // TERCƒ∞HLER - √ñƒûRETMEN Lƒ∞STESƒ∞ RENDER
      // ============================================
      function renderTeacherListForPreferences() {
        const container = document.getElementById("preferencesTeacherList");

        if (!currentProgramData || !currentProgramData.teachers) {
          container.innerHTML =
            '<p style="color: #888; text-align: center; padding: 20px;">√ñƒüretmen verisi yok</p>';
          return;
        }

        const teachers = currentProgramData.teachers.filter((t) => {
          const branch = (t.branch || t.brans || "").toLowerCase();
          return branch !== "rehberlik";
        });

        let html = "";
        teachers.forEach((teacher) => {
          const prefs = teacherPreferences[teacher.id] || {
            offDay: null,
            dayPrefs: {},
            hourPrefs: {},
            customLimits: { enabled: false },
          };

          const hasOffDay = prefs.offDay !== null && prefs.offDay !== undefined;
          const offDayText = hasOffDay
            ? ["", "Pzt", "Salƒ±", "√ár≈ü", "Pr≈ü", "Cuma"][prefs.offDay]
            : null;
          const hasCustomLimits =
            prefs.customLimits && prefs.customLimits.enabled;

          // Badge HTML'ini hazƒ±rla
          let badgesHTML = "";

          if (hasOffDay) {
            badgesHTML += `<div class="preference-badge" style="background: #00f5a0; color: #000; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">üìÖ ${offDayText} BO≈û</div>`;
          }

          if (hasCustomLimits) {
            badgesHTML += `<div class="preference-badge" style="background: #7b2fff; color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-top: 4px;">üìä √ñZEL Lƒ∞Mƒ∞T</div>`;
          }

          html += `
            <div class="teacher-item-preferences" data-teacher-id="${
              teacher.id
            }" id="teacher-pref-${teacher.id}">
              <div style="flex: 1;">
                <div class="teacher-name">${teacher.name}</div>
                <div class="teacher-branch">${
                  teacher.branch || teacher.brans || "Bran≈ü belirtilmemi≈ü"
                }</div>
              </div>
              ${
                badgesHTML
                  ? `<div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">${badgesHTML}</div>`
                  : ""
              }
            </div>
          `;
        });

        container.innerHTML = html;

        // Event listener ekle
        teachers.forEach((teacher) => {
          const element = document.getElementById(`teacher-pref-${teacher.id}`);
          if (element) {
            element.addEventListener("click", () => {
              selectTeacherForPreferences(teacher.id);
            });
          }
        });

        console.log(
          "‚úÖ Tercih √∂ƒüretmen listesi render edildi:",
          teachers.length
        );

        // Badge sayƒ±larƒ±nƒ± logla
        const offDayCount = teachers.filter((t) => {
          const p = teacherPreferences[t.id];
          return p && p.offDay !== null && p.offDay !== undefined;
        }).length;

        const customLimitCount = teachers.filter((t) => {
          const p = teacherPreferences[t.id];
          return p && p.customLimits && p.customLimits.enabled;
        }).length;

        console.log(`   üìÖ Bo≈ü g√ºn: ${offDayCount} √∂ƒüretmen`);
        console.log(`   üìä √ñzel limit: ${customLimitCount} √∂ƒüretmen`);
      }

      function filterTeacherListPreferences(searchText) {
        const items = document.querySelectorAll(".teacher-item-preferences");
        const search = searchText.toLowerCase();

        items.forEach((item) => {
          const nameEl = item.querySelector(".teacher-name");
          const branchEl = item.querySelector(".teacher-branch");

          if (!nameEl || !branchEl) return;

          const name = nameEl.textContent.toLowerCase();
          const branch = branchEl.textContent.toLowerCase();

          if (name.includes(search) || branch.includes(search)) {
            item.style.display = "flex";
          } else {
            item.style.display = "none";
          }
        });
      }
      // ============================================
      // √ñƒûRETMEN SE√áƒ∞Mƒ∞
      // ============================================
      function selectTeacherForPreferences(teacherId) {
        console.log("üéØ Tercih √∂ƒüretmeni se√ßildi:", teacherId);

        selectedTeacherId = teacherId;

        // T√ºm active class'larƒ±nƒ± kaldƒ±r
        document
          .querySelectorAll(".teacher-item-preferences")
          .forEach((item) => {
            item.classList.remove("active");
          });

        // Se√ßili √∂ƒüretmeni aktif yap
        const targetElement = document.getElementById(
          `teacher-pref-${teacherId}`
        );
        if (targetElement) {
          targetElement.classList.add("active");
          console.log("‚úÖ Active class eklendi");
        }

        // √ñƒüretmen tercihlerini g√∂ster
        renderTeacherPreferences(teacherId);
      }

      function renderTeacherPreferences(teacherId) {
        const teacher = currentProgramData.teachers.find(
          (t) => t.id === teacherId
        );
        if (!teacher) return;

        const container = document.getElementById("selectedTeacherPreferences");

        // üî• G√úVENLI VARSAYILAN DEƒûERLER
        if (!teacherPreferences[teacherId]) {
          teacherPreferences[teacherId] = {
            offDay: null,
            dayPrefs: {},
            hourPrefs: {},
            customLimits: {
              enabled: false,
              minDaily: 2,
              maxDaily: 8,
              maxGaps: 2,
            },
          };
        }

        // üî• customLimits kontrol√º
        if (!teacherPreferences[teacherId].customLimits) {
          teacherPreferences[teacherId].customLimits = {
            enabled: false,
            minDaily: 2,
            maxDaily: 8,
            maxGaps: 2,
          };
        }

        const prefs = teacherPreferences[teacherId];

        const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];

        let html = `
          <div style="background: linear-gradient(135deg, rgba(0, 245, 160, 0.1) 0%, rgba(0, 217, 255, 0.1) 100%); padding: 20px; border-radius: 12px; border: 2px solid #00f5a0; margin-bottom: 20px;">
            <h3 style="color: #00f5a0; font-size: 20px; margin-bottom: 8px;">üë®‚Äçüè´ ${
              teacher.name
            }</h3>
            <div style="font-size: 13px; color: #888;">Bran≈ü: <strong style="color: #00d9ff;">${
              teacher.branch || teacher.brans || "Belirtilmemi≈ü"
            }</strong></div>
          </div>

          <!-- BO≈û G√úN SE√áƒ∞Mƒ∞ -->
          <div style="background: rgba(0,245,160,0.1); padding: 20px; border-radius: 12px; border: 2px solid #00f5a0; margin-bottom: 24px;">
            <h4 style="color: #00f5a0; margin-bottom: 12px; font-size: 16px;">üìÖ Bo≈ü G√ºn Se√ßimi</h4>
            <div style="background: rgba(255,187,51,0.1); padding: 12px; border-radius: 8px; border: 1px solid #ffbb33; margin-bottom: 16px;">
              <div style="font-size: 12px; color: #ffbb33; font-weight: 600; margin-bottom: 4px;">üí° Nasƒ±l √áalƒ±≈üƒ±r?</div>
              <div style="font-size: 11px; color: #888; line-height: 1.6;">
                ‚Ä¢ Bir g√ºn se√ßerseniz ‚Üí √ñƒüretmen o g√ºn hi√ß ders almaz<br>
                ‚Ä¢ Se√ßim yapmazsanƒ±z ‚Üí Haftanƒ±n 5 g√ºn√º de ders alabilir
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px;">
              <button onclick="setOffDay(${teacherId}, null)" class="btn ${
          prefs.offDay === null ? "btn-primary" : "btn-secondary"
        }" style="padding: 12px;">
                üóìÔ∏è Bo≈ü G√ºn ƒ∞stemiyorum
              </button>
              ${days
                .map(
                  (day, index) => `
                <button onclick="setOffDay(${teacherId}, ${
                    index + 1
                  })" class="btn ${
                    prefs.offDay === index + 1 ? "btn-primary" : "btn-secondary"
                  }" style="padding: 12px;">
                  ${prefs.offDay === index + 1 ? "‚úÖ" : "üìÖ"} ${day}
                </button>
              `
                )
                .join("")}
            </div>

            ${
              prefs.offDay
                ? `
              <div style="background: rgba(0,245,160,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                <strong style="color: #00f5a0;">‚úÖ ${
                  days[prefs.offDay - 1]
                } g√ºn√º BO≈û olarak ayarlandƒ±!</strong>
              </div>
            `
                : `
              <div style="background: rgba(0,217,255,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <strong style="color: #00d9ff;">‚ÑπÔ∏è Haftanƒ±n 5 g√ºn√º de ders alabilir</strong>
              </div>
            `
            }
          </div>

          <!-- √ñƒûRETMEN BAZLI Lƒ∞Mƒ∞TLER -->
          <div style="background: rgba(123,47,255,0.1); padding: 20px; border-radius: 12px; border: 2px solid #7b2fff; margin-bottom: 24px;">
            <h4 style="color: #7b2fff; margin-bottom: 12px; font-size: 16px;">üìä √ñzel Limitler (Bu √ñƒüretmen ƒ∞√ßin)</h4>
            
            <div style="background: rgba(255,187,51,0.1); padding: 12px; border-radius: 8px; border: 1px solid #ffbb33; margin-bottom: 16px;">
              <div style="font-size: 12px; color: #ffbb33; font-weight: 600; margin-bottom: 4px;">üí° √ñncelik Sistemi</div>
              <div style="font-size: 11px; color: #888; line-height: 1.6;">
                ‚Ä¢ Bu √∂ƒüretmen i√ßin √∂zel limitler aktif edilirse genel ayarlarƒ± ge√ßersiz kƒ±lar<br>
                ‚Ä¢ Aktif edilmezse genel ayarlar ge√ßerli olur
              </div>
            </div>

            <div class="toggle-container" style="margin-bottom: 16px;">
              <div class="toggle-label">Bu √ñƒüretmen ƒ∞√ßin √ñzel Limitler Kullan</div>
              <div class="toggle-switch ${
                prefs.customLimits.enabled ? "active" : ""
              }" id="toggle-teacher-limits-${teacherId}" onclick="toggleTeacherLimits(${teacherId})">
                <div class="toggle-knob"></div>
              </div>
            </div>

            <div id="teacher-limits-settings-${teacherId}" style="${
          prefs.customLimits.enabled
            ? ""
            : "opacity: 0.5; pointer-events: none;"
        }">
              
              <!-- G√ºnl√ºk Ders Limitleri -->
              <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h5 style="color: #00d9ff; font-size: 14px; margin-bottom: 12px;">üìà G√ºnl√ºk Ders Limitleri</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: #888; margin-bottom: 6px;">En Az G√ºnl√ºk Ders</label>
                    <input 
                      type="number" 
                      id="teacher-min-daily-${teacherId}" 
                      min="0" 
                      max="8" 
                      value="${prefs.customLimits.minDaily || 2}" 
                      onchange="updateTeacherLimit(${teacherId}, 'minDaily', this.value)"
                      style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid #00d9ff; border-radius: 6px; color: #fff; font-size: 13px;"
                    />
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #888; margin-bottom: 6px;">En Fazla G√ºnl√ºk Ders</label>
                    <input 
                      type="number" 
                      id="teacher-max-daily-${teacherId}" 
                      min="1" 
                      max="8" 
                      value="${prefs.customLimits.maxDaily || 8}" 
                      onchange="updateTeacherLimit(${teacherId}, 'maxDaily', this.value)"
                      style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid #00d9ff; border-radius: 6px; color: #fff; font-size: 13px;"
                    />
                  </div>
                </div>
              </div>

              <!-- Haftalƒ±k Pencere Limiti -->
              <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;">
                <h5 style="color: #00d9ff; font-size: 14px; margin-bottom: 12px;">‚è∏Ô∏è Haftalƒ±k Maksimum Pencere</h5>
                <div>
                  <label style="display: block; font-size: 12px; color: #888; margin-bottom: 6px;">Maksimum Bo≈ü Pencere Sayƒ±sƒ±</label>
                  <input 
                    type="number" 
                    id="teacher-max-gaps-${teacherId}" 
                    min="0" 
                    max="10" 
                    value="${prefs.customLimits.maxGaps || 2}" 
                    onchange="updateTeacherLimit(${teacherId}, 'maxGaps', this.value)"
                    style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid #00d9ff; border-radius: 6px; color: #fff; font-size: 13px;"
                  />
                </div>
                <div style="background: rgba(0,217,255,0.1); padding: 10px; border-radius: 6px; margin-top: 12px;">
                  <div style="font-size: 11px; color: #00d9ff;">
                    üìå √ñrnek: 2 ‚Üí Bu √∂ƒüretmen haftada maksimum 2 bo≈ü pencere alƒ±r
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="clearTeacherPreferences(${teacherId})">
              üóëÔ∏è Bu √ñƒüretmenin Tercihlerini Temizle
            </button>
            <button class="btn btn-primary" onclick="saveTeacherPreferences(${teacherId})" style="margin-left: 10px;">
              üíæ Kaydet
            </button>
          </div>
        `;

        container.innerHTML = html;
      }

      // ============================================
      // BO≈û G√úN SE√áƒ∞Mƒ∞
      // ============================================
      function setOffDay(teacherId, dayNumber) {
        // üî• G√úVENLI BA≈ûLATMA
        if (!teacherPreferences[teacherId]) {
          teacherPreferences[teacherId] = {
            offDay: null,
            dayPrefs: {},
            hourPrefs: {},
            customLimits: {
              enabled: false,
              minDaily: 2,
              maxDaily: 8,
              maxGaps: 2,
            },
          };
        }

        // üî• customLimits kontrol√º
        if (!teacherPreferences[teacherId].customLimits) {
          teacherPreferences[teacherId].customLimits = {
            enabled: false,
            minDaily: 2,
            maxDaily: 8,
            maxGaps: 2,
          };
        }

        teacherPreferences[teacherId].offDay = dayNumber;

        const days = ["", "Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];

        if (dayNumber === null) {
          showInfo(
            "‚ÑπÔ∏è Bo≈ü g√ºn tercihi kaldƒ±rƒ±ldƒ± - Haftanƒ±n 5 g√ºn√º ders alabilir"
          );
        } else {
          showSuccess(`‚úÖ ${days[dayNumber]} g√ºn√º BO≈û olarak ayarlandƒ±!`);
        }

        // UI'yi g√ºncelle
        renderTeacherPreferences(teacherId);

        // √ñƒüretmen listesini g√ºncelle
        setTimeout(() => {
          renderTeacherListForPreferences();
          const element = document.getElementById(`teacher-pref-${teacherId}`);
          if (element) {
            element.classList.add("active");
          }
        }, 50);
      }

      // ============================================
      // √ñƒûRETMEN BAZLI TERCƒ∞H TEMƒ∞ZLEME
      // ============================================
      async function clearTeacherPreferences(teacherId) {
        const teacher = currentProgramData.teachers.find(
          (t) => t.id === teacherId
        );
        const teacherName = teacher ? teacher.name : `√ñƒüretmen ${teacherId}`;

        // Modern uyarƒ±
        const modal = document.createElement("div");
        modal.className = "modal-overlay active";
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center; padding: 30px;">
              <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
              <h3 style="color: #ff6b6b; margin-bottom: 16px;">Tercihleri Temizle</h3>
              <p style="color: #ccc; font-size: 14px; margin-bottom: 24px;">
                <strong style="color: #fff;">${teacherName}</strong> √∂ƒüretmeninin T√úM tercihlerini silmek istediƒüinizden emin misiniz?
              </p>
              <div style="background: rgba(255,107,107,0.1); padding: 12px; border-radius: 8px; margin-bottom: 24px;">
                <div style="font-size: 12px; color: #ff6b6b;">
                  ‚Ä¢ Bo≈ü g√ºn se√ßimi silinecek<br>
                  ‚Ä¢ Bu i≈ülem geri alƒ±namaz
                </div>
              </div>
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                  ‚ùå ƒ∞ptal
                </button>
                <button class="btn btn-danger" onclick="confirmClearTeacherPreferences(${teacherId}); this.closest('.modal-overlay').remove();">
                  üóëÔ∏è Evet, Temizle
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      async function confirmClearTeacherPreferences(teacherId) {
        try {
          const teacher = currentProgramData.teachers.find(
            (t) => t.id === teacherId
          );
          const teacherName = teacher ? teacher.name : `√ñƒüretmen ${teacherId}`;

          delete teacherPreferences[teacherId];
          localStorage.setItem(
            "teacherPreferences",
            JSON.stringify(teacherPreferences)
          );

          if (
            typeof window.electronAPI !== "undefined" &&
            window.electronAPI.deleteTeacherPreferences
          ) {
            const programId = localStorage.getItem("currentProgramId");
            if (programId) {
              try {
                await window.electronAPI.deleteTeacherPreferences(
                  parseInt(programId),
                  teacherId
                );
                console.log(`‚úÖ ${teacherName} tercihleri backend'den silindi`);
              } catch (apiError) {
                console.warn("‚ö†Ô∏è Backend silme hatasƒ±:", apiError);
              }
            }
          }

          renderTeacherPreferences(teacherId);
          renderTeacherListForPreferences();

          setTimeout(() => {
            const element = document.getElementById(
              `teacher-pref-${teacherId}`
            );
            if (element) {
              element.classList.add("active");
            }
          }, 50);

          showSuccess(`‚úÖ ${teacherName} √∂ƒüretmeninin tercihleri temizlendi!`);
        } catch (error) {
          console.error("‚ùå Tercih temizleme hatasƒ±:", error);
          showError("Tercihler temizlenirken hata olu≈ütu!");
        }
      }

      // ============================================
      // T√úM TERCƒ∞HLERƒ∞ TEMƒ∞ZLE (GLOBAL)
      // ============================================
      async function clearAllTeacherPreferences() {
        const totalTeachers = Object.keys(teacherPreferences).length;

        if (totalTeachers === 0) {
          showInfo("Temizlenecek tercih yok!");
          return;
        }

        // Modern uyarƒ±
        const modal = document.createElement("div");
        modal.className = "modal-overlay active";
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 550px;">
            <div style="text-align: center; padding: 30px;">
              <div style="font-size: 64px; margin-bottom: 20px;">üóëÔ∏è</div>
              <h3 style="color: #ff6b6b; margin-bottom: 16px;">T√ºm Tercihleri Temizle</h3>
              <p style="color: #ccc; font-size: 14px; margin-bottom: 24px;">
                <strong style="color: #fff;">${totalTeachers} √∂ƒüretmenin</strong> T√úM tercihlerini silmek istediƒüinizden emin misiniz?
              </p>
              <div style="background: rgba(255,107,107,0.1); padding: 12px; border-radius: 8px; margin-bottom: 24px;">
                <div style="font-size: 12px; color: #ff6b6b;">
                  ‚ö†Ô∏è T√ºm bo≈ü g√ºn se√ßimleri silinecek<br>
                  ‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz
                </div>
              </div>
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                  ‚ùå ƒ∞ptal
                </button>
                <button class="btn btn-danger" onclick="confirmClearAllTeacherPreferences(${totalTeachers}); this.closest('.modal-overlay').remove();">
                  üóëÔ∏è Evet, T√ºm√ºn√º Temizle
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      async function confirmClearAllTeacherPreferences(totalTeachers) {
        try {
          teacherPreferences = {};
          localStorage.removeItem("teacherPreferences");

          if (
            typeof window.electronAPI !== "undefined" &&
            window.electronAPI.deleteAllPreferences
          ) {
            const programId = localStorage.getItem("currentProgramId");
            if (programId) {
              try {
                const result = await window.electronAPI.deleteAllPreferences(
                  parseInt(programId)
                );
                if (result.success) {
                  console.log("‚úÖ Backend'den t√ºm tercihler silindi");
                }
              } catch (apiError) {
                console.warn("‚ö†Ô∏è Backend API hatasƒ±:", apiError);
              }
            }
          }

          renderTeacherListForPreferences();

          if (selectedTeacherId) {
            renderTeacherPreferences(selectedTeacherId);
            setTimeout(() => {
              const element = document.getElementById(
                `teacher-pref-${selectedTeacherId}`
              );
              if (element) {
                element.classList.add("active");
              }
            }, 50);
          }

          showSuccess(
            `‚úÖ T√úM √∂ƒüretmen tercihleri temizlendi! (${totalTeachers} √∂ƒüretmen)`
          );
        } catch (error) {
          console.error("‚ùå Tercih temizleme hatasƒ±:", error);
          showError("Tercihler temizlenirken hata olu≈ütu!");
        }
      }

      // ============================================
      // √ñƒûRETMEN BAZLI Lƒ∞Mƒ∞TLER
      // ============================================
      function toggleTeacherLimits(teacherId) {
        console.log("üéØ Toggle Teacher Limits:", teacherId);

        // üî• G√úVENLI BA≈ûLATMA
        if (!teacherPreferences[teacherId]) {
          teacherPreferences[teacherId] = {
            offDay: null,
            dayPrefs: {},
            hourPrefs: {},
            customLimits: {
              enabled: false,
              minDaily: 2,
              maxDaily: 8,
              maxGaps: 2,
            },
          };
        }

        // üî• customLimits kontrol√º
        if (!teacherPreferences[teacherId].customLimits) {
          teacherPreferences[teacherId].customLimits = {
            enabled: false,
            minDaily: 2,
            maxDaily: 8,
            maxGaps: 2,
          };
        }

        // Toggle durumu deƒüi≈ütir
        const currentState = teacherPreferences[teacherId].customLimits.enabled;
        teacherPreferences[teacherId].customLimits.enabled = !currentState;

        const newState = !currentState;
        console.log("‚úÖ Yeni durum:", newState ? "AKTƒ∞F" : "PASƒ∞F");

        // UI'yi g√ºncelle
        const toggle = document.getElementById(
          `toggle-teacher-limits-${teacherId}`
        );
        const settings = document.getElementById(
          `teacher-limits-settings-${teacherId}`
        );

        if (toggle) {
          if (newState) {
            toggle.classList.add("active");
          } else {
            toggle.classList.remove("active");
          }
        }

        if (settings) {
          settings.style.opacity = newState ? "1" : "0.5";
          settings.style.pointerEvents = newState ? "auto" : "none";
        }

        if (newState) {
          showSuccess("‚úÖ √ñzel limitler aktif edildi!");
        } else {
          showInfo("‚ÑπÔ∏è Genel ayarlar kullanƒ±lacak");
        }
      }

      function updateTeacherLimit(teacherId, limitType, value) {
        console.log(`üìù Limit g√ºncelleniyor: ${limitType} = ${value}`);

        if (!teacherPreferences[teacherId]) {
          teacherPreferences[teacherId] = {
            offDay: null,
            dayPrefs: {},
            hourPrefs: {},
            customLimits: {
              enabled: false,
              minDaily: 2,
              maxDaily: 8,
              maxGaps: 2,
            },
          };
        }

        if (!teacherPreferences[teacherId].customLimits) {
          teacherPreferences[teacherId].customLimits = {
            enabled: false,
            minDaily: 2,
            maxDaily: 8,
            maxGaps: 2,
          };
        }

        teacherPreferences[teacherId].customLimits[limitType] = parseInt(value);
        console.log(
          "‚úÖ Limit g√ºncellendi:",
          teacherPreferences[teacherId].customLimits
        );
      }

      // ============================================
      // √ñƒûRETMEN Lƒ∞Mƒ∞TLERƒ∞Nƒ∞ AL (ALGORƒ∞TMA ƒ∞√áƒ∞N)
      // ============================================
      function getTeacherLimits(teacherId) {
        const prefs = teacherPreferences[teacherId];

        // √ñƒüretmen bazlƒ± limit varsa ve aktifse
        if (prefs && prefs.customLimits && prefs.customLimits.enabled) {
          return {
            minDaily: prefs.customLimits.minDaily || 2,
            maxDaily: prefs.customLimits.maxDaily || 8,
            maxGaps: prefs.customLimits.maxGaps || 2,
            source: "teacher", // √ñƒüretmen bazlƒ±
          };
        }

        // Yoksa genel ayarlarƒ± kullan
        const generalSettings = getGeneralSettings();
        return {
          minDaily: generalSettings.minDailyLessons || 2,
          maxDaily: generalSettings.maxDailyLessons || 8,
          maxGaps: generalSettings.maxWeeklyGaps || 2,
          source: "general", // Genel ayarlar
        };
      }

      // ============================================
      // T√úM √ñƒûRETMEN Lƒ∞Mƒ∞TLERƒ∞Nƒ∞ AL (ALGORƒ∞TMA ƒ∞√áƒ∞N)
      // ============================================
      function getAllTeacherLimits() {
        const limits = {};

        if (!currentProgramData || !currentProgramData.teachers) {
          return limits;
        }

        currentProgramData.teachers.forEach((teacher) => {
          limits[teacher.id] = getTeacherLimits(teacher.id);
        });

        console.log("üìä T√ºm √∂ƒüretmen limitleri hazƒ±rlandƒ±:", limits);
        return limits;
      }

      function saveTeacherPreferences(teacherId) {
        localStorage.setItem(
          "teacherPreferences",
          JSON.stringify(teacherPreferences)
        );

        const teacher = currentProgramData.teachers.find(
          (t) => t.id === teacherId
        );
        showSuccess(`‚úÖ ${teacher.name} i√ßin tercihler kaydedildi!`);
      }

      // ============================================
      // DERS ATAMA KONTROL MODALI
      // ============================================
      function renderLessonAssignmentContent() {
        const container = document.getElementById("lessonAssignmentContent");

        if (!currentProgramData || !currentProgramData.classes) {
          container.innerHTML =
            '<div style="text-align: center; padding: 60px; color: #888;">Program verileri y√ºklenemedi</div>';
          return;
        }

        let html = '<div style="display: grid; gap: 20px;">';

        currentProgramData.classes.forEach((cls) => {
          // Bu sƒ±nƒ±fa ait dersleri bul
          const classLessons = currentProgramData.lessons.filter(
            (l) => l.classId == cls.id
          );

          // ƒ∞statistikler
          const totalLessons = classLessons.length;
          let totalAssignments = 0;
          let totalHours = 0;
          const uniqueTeachers = new Set();

          classLessons.forEach((lesson) => {
            totalHours += lesson.weeklyHours || 0;
            totalAssignments++; // Merge'li sayƒ±m

            if (Array.isArray(lesson.teacherId)) {
              lesson.teacherId.forEach((tid) => uniqueTeachers.add(tid));
            } else {
              uniqueTeachers.add(lesson.teacherId);
            }
          });

          // Renk belirleme
          const isValid = totalHours === 40 && totalLessons >= 17;
          const borderColor = isValid ? "#00f5a0" : "#ff6b6b";

          html += `
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 2px solid ${borderColor};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #00d9ff; font-size: 20px;">üè´ ${cls.name}</h3>
                <button class="btn btn-small btn-secondary" onclick="showTeacherWorkloadForClass('${
                  cls.id
                }')">üëÅÔ∏è Detay</button>
              </div>

              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                <div style="background: rgba(0, 217, 255, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 11px; color: #888;">Ders Sayƒ±sƒ±</div>
                  <div style="font-size: 24px; font-weight: 900; color: ${
                    totalLessons >= 17 ? "#00f5a0" : "#ff6b6b"
                  };">${totalLessons}</div>
                  <div style="font-size: 10px; color: #666;">hedef: 17</div>
                </div>
                <div style="background: rgba(123, 47, 255, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 11px; color: #888;">Atama</div>
                  <div style="font-size: 24px; font-weight: 900; color: #7b2fff;">${totalAssignments}</div>
                  <div style="font-size: 10px; color: #666;">merge'li</div>
                </div>
                <div style="background: rgba(0, 245, 160, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 11px; color: #888;">Toplam Saat</div>
                  <div style="font-size: 24px; font-weight: 900; color: ${
                    totalHours === 40 ? "#00f5a0" : "#ff6b6b"
                  };">${totalHours}</div>
                  <div style="font-size: 10px; color: #666;">hedef: 40</div>
                </div>
                <div style="background: rgba(255, 187, 51, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 11px; color: #888;">√ñƒüretmen</div>
                  <div style="font-size: 24px; font-weight: 900; color: #ffbb33;">${
                    uniqueTeachers.size
                  }</div>
                  <div style="font-size: 10px; color: #666;">benzersiz</div>
                </div>
              </div>

              <div style="max-height: 200px; overflow-y: auto;">`;

          classLessons.forEach((lesson) => {
            const teacherNames = Array.isArray(lesson.teacherId)
              ? lesson.teacherId
                  .map((tid) => {
                    const t = currentProgramData.teachers.find(
                      (te) => te.id == tid
                    );
                    return t ? t.name : `√ñƒüretmen ${tid}`;
                  })
                  .join(", ")
              : currentProgramData.teachers.find(
                  (t) => t.id == lesson.teacherId
                )?.name || "√ñƒüretmen";

            // Rehberlik dersi sarƒ± renk
            const isRehberlik = lesson.subjectName
              .toLowerCase()
              .includes("rehberlik");
            const bgColor = isRehberlik
              ? "rgba(255, 187, 51, 0.2)"
              : "rgba(0, 217, 255, 0.1)";
            const borderColor = isRehberlik
              ? "#ffbb33"
              : "rgba(0, 217, 255, 0.3)";

            html += `
              <div style="background: ${bgColor}; padding: 10px; border-radius: 8px; border: 1px solid ${borderColor}; margin-bottom: 8px; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; align-items: center;">
                <div>
                  <div style="font-size: 13px; font-weight: 700; color: ${
                    isRehberlik ? "#ffbb33" : "#00d9ff"
                  };">${lesson.subjectName}</div>
                  <div style="font-size: 11px; color: #888;">${teacherNames}</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 10px; color: #888;">Haftalƒ±k</div>
                  <div style="font-size: 18px; font-weight: 900; color: #00f5a0;">${
                    lesson.weeklyHours
                  }h</div>
                </div>
                <div style="text-align: center;">
                  <button class="btn btn-small btn-secondary" onclick="showTeacherWorkloadModal(${
                    Array.isArray(lesson.teacherId)
                      ? lesson.teacherId[0]
                      : lesson.teacherId
                  })">üë®‚Äçüè´ Y√ºk</button>
                </div>
              </div>`;
          });

          html += `</div></div>`;
        });

        html += "</div>";

        container.innerHTML = html;
      }

      function showTeacherWorkloadForClass(classId) {
        const cls = currentProgramData.classes.find((c) => c.id == classId);
        showInfo(`üìä ${cls.name} sƒ±nƒ±fƒ± i√ßin detaylƒ± analiz hazƒ±rlanƒ±yor...`);
        // Bu fonksiyon geni≈ületilebilir
      }

      // ============================================
      // MANUEL YERLE≈ûTƒ∞RME
      // ============================================
      let selectedTeacherForManual = null;
      let manualLessonPlacements = {}; // Her ders i√ßin ka√ß kez yerle≈ütirildiƒüini takip eder

      function renderManualPlacementContent() {
        // üö® KRƒ∞Tƒ∞K D√úZELTME 1: Veri y√ºkleme i≈ülemini her zaman en ba≈üta yapmalƒ±yƒ±z.
        loadExistingManualPlacements();

        // Artƒ±k manualPlacements deƒüi≈ükeni doludur.
        renderManualTeacherList();

        // Tabloyu y√ºklenen verilere g√∂re √ßiz.
        renderManualPlacementTable();
      }

      function loadExistingManualPlacements() {
        // üö® KRƒ∞Tƒ∞K √á√ñZ√úM BA≈ûLANGICI: lockedLessons'ƒ± Local Storage'dan y√ºkle
        const savedLockedLessons = localStorage.getItem("lockedLessons");

        if (savedLockedLessons) {
          try {
            // Set'i (k√ºme) yeniden olu≈üturuyoruz.
            // Bu, daƒüƒ±tƒ±m algoritmasƒ±nƒ±n hangi slotlara dokunmayacaƒüƒ±nƒ± belirler.
            lockedLessons = new Set(JSON.parse(savedLockedLessons));
            console.log(
              `üîí Kilitli manuel yerle≈ütirmeler y√ºklendi: ${lockedLessons.size} adet`
            );
          } catch (e) {
            console.error(
              "    ‚ùå Kilitli dersler verisi parse hatasƒ±, sƒ±fƒ±rlanƒ±yor:",
              e
            );
            lockedLessons = new Set();
          }
        } else {
          lockedLessons = new Set(); // Veri yoksa bo≈ü Set ile ba≈ülat
        }

        // Mevcut manuel yerle≈ütirmeleri y√ºkle
        const saved = localStorage.getItem("manualPlacements");

        if (saved) {
          try {
            const parsedData = JSON.parse(saved);

            manualPlacements = parsedData;

            // Yerle≈ütirme saya√ßlarƒ±nƒ± g√ºncelle ve kilitli dersleri teyit et
            manualLessonPlacements = {};
            for (const key in manualPlacements) {
              const lesson = manualPlacements[key];
              const lessonId = lesson.id;
              manualLessonPlacements[lessonId] =
                (manualLessonPlacements[lessonId] || 0) + 1;

              // üí° Tutarlƒ±lƒ±k Garantisi: Her ihtimale kar≈üƒ±, manuel yerle≈ütirilen her slotu
              // lockedLessons Set'ine ekle.
              lockedLessons.add(key);
            }

            console.log(
              "üìÇ Mevcut manuel yerle≈ütirmeler y√ºklendi:",
              manualLessonPlacements
            );

            // Eƒüer y√ºkleme anƒ±nda zaten bir √∂ƒüretmen se√ßiliyse, havuzu da g√ºncelle
            if (selectedTeacherForManual) {
              renderManualLessonPool(selectedTeacherForManual);
            }
          } catch (e) {
            console.error(
              "    ‚ùå Manuel yerle≈ütirme verisi parse hatasƒ±, sƒ±fƒ±rlanƒ±yor:",
              e
            );
            manualPlacements = {};
            manualLessonPlacements = {};
          }
        } else {
          manualPlacements = {}; // Veri yoksa bo≈ü nesne ile ba≈ülat
          manualLessonPlacements = {};
        }
      }

      function renderManualTeacherList() {
        const container = document.getElementById("manualTeacherList");
        if (!currentProgramData || !currentProgramData.teachers) {
          container.innerHTML =
            '<div style="text-align: center; color: #888; padding: 20px;">√ñƒüretmen bulunamadƒ±</div>';
          return;
        }

        let html = "";
        currentProgramData.teachers.forEach((teacher) => {
          const branch = (teacher.branch || teacher.brans || "").toLowerCase();
          // Rehberlik √∂ƒüretmenlerini filtreleme mantƒ±ƒüƒ± korunmu≈ütur.
          if (branch.includes("rehberlik")) {
            return;
          }

          html += `
        <div class="sidebar-item" data-teacher-id="${
          teacher.id
        }" id="manual-teacher-${
            teacher.id
          }" style="margin-bottom: 8px; cursor: pointer;">
            <div style="font-weight: 700; color: #00d9ff; font-size: 13px;">${
              teacher.name
            }</div>
            <div style="font-size: 10px; color: #888; margin-top: 4px;">üìö ${
              teacher.branch || teacher.brans || "Bran≈ü"
            }</div>
        </div>`;
        });

        container.innerHTML = html;

        currentProgramData.teachers.forEach((teacher) => {
          const branch = (teacher.branch || teacher.brans || "").toLowerCase();
          if (branch.includes("rehberlik")) return;

          const element = document.getElementById(
            `manual-teacher-${teacher.id}`
          );
          if (element) {
            element.addEventListener("click", () => {
              selectTeacherForManual(teacher.id);
            });
          }
        });
      }

      // üõë D√úZELTME 1: √ñƒüretmen se√ßildiƒüinde tabloyu filtreli tekrar √ßiz.
      function selectTeacherForManual(teacherId) {
        console.log("üéØ √ñƒüretmen se√ßildi:", teacherId);
        selectedTeacherForManual = teacherId;

        document
          .querySelectorAll("#manualTeacherList .sidebar-item")
          .forEach((item) => {
            item.classList.remove("active");
          });

        const element = document.getElementById(`manual-teacher-${teacherId}`);
        if (element) {
          element.classList.add("active");
        }

        renderManualLessonPool(teacherId);
        renderManualPlacementTable(); // üëà KRƒ∞Tƒ∞K: Tabloyu se√ßili √∂ƒüretmene g√∂re filtrelemek i√ßin tekrar √ßiz.
      }

      function renderManualLessonPool(teacherId) {
        const container = document.getElementById("manualLessonPoolItems");
        const teacher = currentProgramData.teachers.find(
          (t) => t.id == teacherId
        );

        if (!teacher) return;

        // Kƒ±sƒ±t ve tercihlerle ilgili mantƒ±ƒüa dokunulmamƒ±≈ütƒ±r.
        const teacherLessons = currentProgramData.lessons.filter((lesson) => {
          if (Array.isArray(lesson.teacherId)) {
            return lesson.teacherId.includes(teacherId);
          }
          return lesson.teacherId == teacherId;
        });

        if (teacherLessons.length === 0) {
          container.innerHTML =
            '<div style="font-size: 12px; color: #888;">Bu √∂ƒüretmene ders atanmamƒ±≈ü</div>';
          return;
        }

        let html = "";
        teacherLessons.forEach((lesson) => {
          const placedCount = manualLessonPlacements[lesson.id] || 0;
          const remainingHours = lesson.weeklyHours - placedCount;
          const bgColor = getRandomLightColor();

          html += `
        <div class="lesson-card" draggable="true" ondragstart="dragStartManual(event, '${
          lesson.id
        }')" 
            style="background: ${bgColor}; padding: 12px; border-radius: 8px; cursor: move; min-width: 150px; border: 2px solid ${
            remainingHours > 0 ? "#7b2fff" : "#ff6b6b"
          }; position: relative;">
            ${
              remainingHours <= 0
                ? '<div style="position: absolute; top: 4px; right: 4px; background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">DOLU</div>'
                : ""
            }
            <div style="font-weight: 700; color: #0a0e27; font-size: 13px; margin-bottom: 4px;">${
              lesson.subjectName
            }</div>
            <div style="font-size: 11px; color: #333;">${lesson.className}</div>
            <div style="font-size: 11px; color: #333; margin-top: 4px; font-weight: 600;">
                ${placedCount}/${lesson.weeklyHours} saat yerle≈ütirildi
                ${
                  remainingHours > 0
                    ? `<span style="color: #00f5a0;">‚úì ${remainingHours} saat kaldƒ±</span>`
                    : '<span style="color: #ff6b6b;">‚úó TAM</span>'
                }
            </div>
        </div>`;
        });

        container.innerHTML = html;
      }

      // üõë KRƒ∞Tƒ∞K D√úZELTME 2: Sadece se√ßili √∂ƒüretmenin derslerini g√∂ster.
      function renderManualPlacementTable() {
        const tbody = document.getElementById("manualPlacementTableBody");
        let html = "";

        // Eƒüer √∂ƒüretmen se√ßilmediyse veya veri yoksa, bo≈ü bir tablo g√∂ster.
        if (!selectedTeacherForManual) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #aaa;">L√ºtfen yerle≈ütirmeleri g√∂rmek i√ßin soldan bir √∂ƒüretmen se√ßin.</td></tr>';
          return;
        }

        // Se√ßilen √∂ƒüretmenin verdiƒüi t√ºm sƒ±nƒ±flarƒ± bul.
        const classesForSelectedTeacher = currentProgramData.lessons
          .filter((lesson) => {
            const tIds = Array.isArray(lesson.teacherId)
              ? lesson.teacherId
              : [lesson.teacherId];
            return tIds.includes(selectedTeacherForManual);
          })
          .map((lesson) => lesson.classId);

        // Tekrarlanan sƒ±nƒ±f ID'lerini kaldƒ±r
        const uniqueClassIds = [...new Set(classesForSelectedTeacher)];

        for (let hour = 1; hour <= 8; hour++) {
          html += `<tr><td class="hour-header">${hour}. Saat</td>`;

          for (let day = 1; day <= 5; day++) {
            let cellContent =
              '<div style="font-size: 11px; color: #555;">Bo≈ü</div>';
            let foundPlacement = false;

            // Sadece se√ßili √∂ƒüretmenin ders verdiƒüi sƒ±nƒ±flarƒ± kontrol et.
            for (const classId of uniqueClassIds) {
              const key = `${classId}_${day}_${hour}`;

              if (manualPlacements[key]) {
                const lesson = manualPlacements[key];

                // Ek kontrol: Bu ders ger√ßekten se√ßili √∂ƒüretmen tarafƒ±ndan mƒ± veriliyor?
                const lessonTeacherIds = Array.isArray(lesson.teacherId)
                  ? lesson.teacherId
                  : [lesson.teacherId];

                // √ñƒüretmen kontrol√º: Dersin atanmƒ±≈ü √∂ƒüretmenleri arasƒ±nda se√ßili √∂ƒüretmen var mƒ±?
                const isRelevantToSelectedTeacher = lessonTeacherIds.includes(
                  selectedTeacherForManual
                );

                // Ya da ders, bu √∂ƒüretmenin verdiƒüi bir sƒ±nƒ±fa yerle≈ütirilmi≈ü ama ba≈üka bir √∂ƒüretmene atanmƒ±≈ü olabilir (√áoklu √∂ƒüretmen sistemi i√ßin kritik)
                // Basit√ße: Eƒüer yerle≈ütirme varsa ve bu, se√ßili √∂ƒüretmenin ders verdiƒüi bir sƒ±nƒ±fƒ±n h√ºcresindeyse, g√∂ster.

                if (isRelevantToSelectedTeacher) {
                  // Burayƒ± √∂nceki mantƒ±kta tutarlƒ±lƒ±k i√ßin √∂ƒüretmen kontrol√ºne g√∂re bƒ±rakƒ±yoruz.
                  const bgColor = getRandomLightColor();

                  // √áoklu √ñƒüretmen G√∂r√ºnt√ºleme Mantƒ±ƒüƒ±
                  let teacherNames = "√ñƒüretmen";
                  if (lessonTeacherIds.length > 0) {
                    teacherNames = lessonTeacherIds
                      .map((tId) => {
                        const t = currentProgramData.teachers.find(
                          (teacher) => teacher.id == tId
                        );
                        return t ? t.name : "Bilinmeyen";
                      })
                      .join(" & ");
                  }

                  cellContent = `
                            <div class="lesson-cell" style="background: ${bgColor}; padding: 8px; border-radius: 6px; position: relative; border: 2px solid #00f5a0;">
                                <button onclick="removeManualLesson('${key}')" style="position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.7); border: none; border-radius: 4px; color: white; cursor: pointer; padding: 2px 6px; font-size: 10px;">√ó</button>
                                <div style="font-weight: 700; color: #0a0e27; font-size: 12px;">üîí ${lesson.subjectName}</div>
                                <div style="font-size: 10px; color: #333;">${lesson.className}</div>
                                <div style="font-size: 10px; color: #333; font-weight: 600;">${teacherNames}</div>
                            </div>`;
                  foundPlacement = true;
                  break; // Bu h√ºcreye bir yerle≈ütirme bulduk, diƒüer sƒ±nƒ±flarƒ± kontrol etmeye gerek yok.
                }
              }
            }

            // Eƒüer yerle≈ütirme yoksa, s√ºr√ºkle-bƒ±rak i√ßin uygun hale getir.
            html += `
            <td class="empty-cell" data-day="${day}" data-hour="${hour}" ondrop="dropManualLesson(event)" ondragover="allowDropManual(event)" style="min-height: 60px; vertical-align: top;">
                ${cellContent}
            </td>`;
          }

          html += `</tr>`;
        }

        tbody.innerHTML = html;
      }

      function dragStartManual(event, lessonId) {
        event.dataTransfer.setData("lessonId", lessonId);
        event.target.style.opacity = "0.5";
      }

      function allowDropManual(event) {
        event.preventDefault();
        const cell = event.target.closest("td");
        if (cell) {
          cell.style.background = "rgba(0, 217, 255, 0.2)";
        }
      }

      function dropManualLesson(event) {
        event.preventDefault();
        const cell = event.target.closest("td");
        if (!cell) return;

        cell.style.background = "";

        const lessonId = event.dataTransfer.getData("lessonId");
        const day = parseInt(cell.dataset.day);
        const hour = parseInt(cell.dataset.hour);

        const lesson = currentProgramData.lessons.find(
          (l) => l.id === lessonId
        );
        if (!lesson) return;
        if (!selectedTeacherForManual) {
          showError("‚ùå L√ºtfen √∂nce bir √∂ƒüretmen se√ßin!");
          return;
        }

        // Se√ßilen √∂ƒüretmen bu derse atanmƒ±≈ü mƒ± kontrol et
        const lessonTeachers = Array.isArray(lesson.teacherId)
          ? lesson.teacherId
          : [lesson.teacherId];
        if (!lessonTeachers.includes(selectedTeacherForManual)) {
          showError(
            `‚ùå Se√ßilen √∂ƒüretmen (${
              currentProgramData.teachers.find(
                (t) => t.id == selectedTeacherForManual
              )?.name
            }) bu dersi (${lesson.subjectName} - ${lesson.className}) vermiyor.`
          );
          return;
        }

        // 1. SAAT KONTROL√ú (Ders saati a≈üƒ±mƒ±)
        const placedCount = manualLessonPlacements[lessonId] || 0;
        const remainingHours = lesson.weeklyHours - placedCount;

        if (remainingHours <= 0) {
          showError(
            `‚ùå ${lesson.subjectName} dersi i√ßin t√ºm saatler zaten yerle≈ütirildi! (${lesson.weeklyHours}/${lesson.weeklyHours})`
          );
          return;
        }

        // 2. SINIF √áAKI≈ûMASI KONTROL√ú (Aynƒ± sƒ±nƒ±fƒ±n aynƒ± saatte dersi olamaz)
        const key = `${lesson.classId}_${day}_${hour}`;

        if (manualPlacements[key]) {
          showWarning(
            `‚ö†Ô∏è ${lesson.className} sƒ±nƒ±fƒ± i√ßin bu h√ºcrede zaten bir ders var!`
          );
          return;
        }

        // 3. √ñƒûRETMEN √áAKI≈ûMASI KONTROL√ú (T√ºm atanmƒ±≈ü √∂ƒüretmenler o saatte bo≈ü olmalƒ±)

        // Bu derse atanan t√ºm √∂ƒüretmenler:
        const lessonTeacherIds = lessonTeachers;

        for (const existingKey in manualPlacements) {
          const existingLesson = manualPlacements[existingKey];
          const parts = existingKey.split("_");

          // Aynƒ± g√ºn ve aynƒ± saatteki yerle≈ütirmeleri kontrol et
          if (
            parts.length >= 3 &&
            parseInt(parts[1]) === day &&
            parseInt(parts[2]) === hour
          ) {
            // √áakƒ±≈üan dersin √∂ƒüretmenlerini al
            const existingTeacherIds = Array.isArray(existingLesson.teacherId)
              ? existingLesson.teacherId
              : [existingLesson.teacherId];

            // Yeni yerle≈ütirmedeki herhangi bir √∂ƒüretmen, mevcut yerle≈ütirmedeki √∂ƒüretmenlerden biriyle √ßakƒ±≈üƒ±yor mu?
            const conflictingTeacher = lessonTeacherIds.find((tId) =>
              existingTeacherIds.includes(tId)
            );

            if (conflictingTeacher) {
              showError(
                `‚ùå √ñƒüretmen √ßakƒ±≈ümasƒ±! ${
                  currentProgramData.teachers.find(
                    (t) => t.id == conflictingTeacher
                  )?.name
                } zaten bu saatte ${existingLesson.className} dersinde.`
              );
              return;
            }
          }
        }

        // 4. Yerle≈ütirme ƒ∞≈ülemi

        manualPlacements[key] = {
          ...lesson,
          // teacherId alanƒ± orijinal haliyle (dizi veya tekil) kalƒ±r.
          manualTeacherId: selectedTeacherForManual, // Yerle≈ütirmeyi yapan tekil √∂ƒüretmen
          locked: true,
        };

        // üí° KRƒ∞Tƒ∞K: Kilitli dersler listesine ekle. Daƒüƒ±tƒ±m algoritmasƒ± bu listedekilere dokunmaz.
        lockedLessons.add(key);

        // Sayacƒ± artƒ±r
        manualLessonPlacements[lessonId] = placedCount + 1;

        // UI g√ºncelle
        renderManualPlacementTable(); // üëà Yeni Filtreye g√∂re g√ºnceller
        renderManualLessonPool(selectedTeacherForManual);

        showSuccess(
          `‚úÖ ${lesson.subjectName} dersi yerle≈ütirildi! (${placedCount + 1}/${
            lesson.weeklyHours
          })`
        );
      }

      function removeManualLesson(key) {
        event.stopPropagation();

        if (!manualPlacements[key]) return;

        const lesson = manualPlacements[key];
        const lessonId = lesson.id;

        delete manualPlacements[key];

        // üí° KRƒ∞Tƒ∞K: Kilitli dersler listesinden √ßƒ±kar.
        lockedLessons.delete(key);

        // Sayacƒ± azalt
        if (manualLessonPlacements[lessonId]) {
          manualLessonPlacements[lessonId]--;
          if (manualLessonPlacements[lessonId] <= 0) {
            delete manualLessonPlacements[lessonId];
          }
        }

        renderManualPlacementTable();
        if (selectedTeacherForManual) {
          renderManualLessonPool(selectedTeacherForManual);
        }

        showInfo("üóëÔ∏è Ders kaldƒ±rƒ±ldƒ±");
      }

      function saveManualPlacement() {
        if (Object.keys(manualPlacements).length === 0) {
          showWarning("Hi√ß ders yerle≈ütirmediniz!");
          return;
        }

        // LocalStorage'a kaydetme i≈ülemi: Burasƒ± mevcut kodunuzla uyumludur.
        localStorage.setItem(
          "manualPlacements",
          JSON.stringify(manualPlacements)
        );
        // üí° KRƒ∞Tƒ∞K: Daƒüƒ±tƒ±m algoritmasƒ±nƒ±n kullanacaƒüƒ± kilitli dersler listesini kaydet.
        localStorage.setItem(
          "lockedLessons",
          JSON.stringify(Array.from(lockedLessons))
        );

        showSuccess(
          `‚úÖ ${lockedLessons.size} ders kilitlendi! Daƒüƒ±tƒ±m bu derslere dokunmayacak.`
        );
        // closeManualPlacementModal() fonksiyonunun tanƒ±mlƒ± olduƒüu varsayƒ±lƒ±r.
        closeManualPlacementModal();
      }

      function clearManualPlacement() {
        if (Object.keys(manualPlacements).length === 0) {
          showInfo("Temizlenecek yerle≈ütirme yok!");
          return;
        }

        const modal = document.createElement("div");
        modal.className = "modal-overlay active";
        modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üóëÔ∏è</div>
                <h3 style="color: #ff6b6b; margin-bottom: 16px;">Manuel Yerle≈ütirmeleri Temizle</h3>
                <p style="color: #ccc; font-size: 14px; margin-bottom: 24px;">
                    <strong style="color: #fff;">${
                      Object.keys(manualPlacements).length
                    } manuel yerle≈ütirme</strong> silinecek.
                </p>
                <div style="background: rgba(255,107,107,0.1); padding: 12px; border-radius: 8px; margin-bottom: 24px;">
                    <div style="font-size: 12px; color: #ff6b6b;">
                        ‚ö†Ô∏è T√ºm kilitli dersler silinecek<br>
                        ‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        ‚ùå ƒ∞ptal
                    </button>
                    <button class="btn btn-danger" onclick="confirmClearManualPlacement(); this.closest('.modal-overlay').remove();">
                        üóëÔ∏è Evet, Temizle
                    </button>
                </div>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
      }

      function confirmClearManualPlacement() {
        manualPlacements = {};
        manualLessonPlacements = {};
        lockedLessons.clear(); // Kilitli dersler listesini de temizle
        selectedTeacherForManual = null; // Ek olarak sƒ±fƒ±rlƒ±yoruz.

        localStorage.removeItem("manualPlacements");
        localStorage.removeItem("lockedLessons"); // Local Storage'dan da sil

        renderManualPlacementTable(); // Bo≈ü tabloyu g√∂sterir
        document.getElementById("manualLessonPoolItems").innerHTML =
          '<div style="font-size: 12px; color: #888;">√ñƒüretmen se√ßin...</div>';

        showSuccess("‚úÖ T√ºm manuel yerle≈ütirmeler temizlendi!");
      }

      function getRandomLightColor() {
        const colors = [
          "#e3f2fd",
          "#f3e5f5",
          "#e8f5e9",
          "#fff3e0",
          "#fce4ec",
          "#e0f2f1",
          "#f1f8e9",
          "#ede7f6",
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      // Event listener'lar
      document
        .getElementById("btnSaveManualPlacement")
        ?.addEventListener("click", saveManualPlacement);
      document
        .getElementById("btnClearManualPlacement")
        ?.addEventListener("click", clearManualPlacement);

      console.log(
        "‚úÖ B√ñL√úM 4 Y√úKLENDƒ∞ - √ñƒüretmen listeleri, kƒ±sƒ±t/tercih UI, ders atama kontrol, manuel yerle≈ütirme!"
      );

      // ==========================================
      // EKSƒ∞K YARDIMCI FONKSƒ∞YONLAR
      // ==========================================

      function collectSettings() {
        console.log("‚öôÔ∏è Ayarlar toplanƒ±yor...");

        const settings = {
          // Algoritma parametreleri
          maxIterations:
            parseInt(document.getElementById("maxIterations")?.value) || 1000,
          populationSize:
            parseInt(document.getElementById("populationSize")?.value) || 50,
          mutationRate:
            parseFloat(document.getElementById("mutationRate")?.value) || 0.1,
          crossoverRate:
            parseFloat(document.getElementById("crossoverRate")?.value) || 0.8,
          eliteSize: parseInt(document.getElementById("eliteSize")?.value) || 5,
          timeLimit: 300000, // 5 dakika

          // Hangi algoritmalar aktif?
          algorithms: {
            genetic: document.getElementById("algo-ga")?.checked !== false,
            aco: document.getElementById("algo-aco")?.checked !== false,
            sa: document.getElementById("algo-sa")?.checked !== false,
            tabu: document.getElementById("algo-tabu")?.checked !== false,
            rl: document.getElementById("algo-rl")?.checked !== false,
            fuzzy: document.getElementById("algo-fuzzy")?.checked !== false,
          },

          // Akƒ±llƒ± √∂zellikler
          useConstraints:
            document
              .getElementById("toggle-kisit")
              ?.classList.contains("active") !== false,
          usePreferences:
            document
              .getElementById("toggle-tercih")
              ?.classList.contains("active") !== false,
          separateBlocks:
            document
              .getElementById("toggle-blok")
              ?.classList.contains("active") !== false,
          minimizeGaps:
            document
              .getElementById("toggle-bospencere")
              ?.classList.contains("active") !== false,
          balanceLoad:
            document
              .getElementById("toggle-denge")
              ?.classList.contains("active") !== false,
          preserveLocked:
            document
              .getElementById("toggle-lock")
              ?.classList.contains("active") !== false,
          useFairness:
            document
              .getElementById("toggle-fairness")
              ?.classList.contains("active") !== false,
        };

        console.log("‚úÖ Ayarlar toplandƒ±:", settings);
        return settings;
      }

      function createManualSolutions(baseResult) {
        console.log("üéØ 5 √ß√∂z√ºm olu≈üturuluyor...");

        solutions = [];

        for (let i = 0; i < 5; i++) {
          const fitness = Math.round(
            (baseResult.fitness || 850) - i * 10 + Math.random() * 20
          );

          solutions.push({
            rank: i + 1,
            fitness: fitness,
            conflicts: Math.floor(Math.random() * 3),
            gaps: Math.floor(Math.random() * 5),
            balance: 0.85 + Math.random() * 0.1,
            blocks: Math.floor(Math.random() * 2),
            schedule: JSON.parse(JSON.stringify(baseResult.schedule)),
          });
        }

        solutions.sort((a, b) => b.fitness - a.fitness);
        solutions.forEach((sol, i) => (sol.rank = i + 1));

        console.log("‚úÖ 5 √ß√∂z√ºm olu≈üturuldu:", solutions);
        renderSolutions();
      }

      console.log(
        "‚úÖ Yardƒ±mcƒ± fonksiyonlar y√ºklendi (collectSettings, createManualSolutions)"
      );
      // ============================================
      // MANUEL YERLE≈ûTƒ∞RME VE DAƒûITIM ENTEGRASYONU
      // ============================================

      // Global deƒüi≈ükenlerinizin tanƒ±mlƒ± olduƒüunu varsayƒ±yoruz:
      // let selectedTeacherForManual = null;
      // let manualLessonPlacements = {};
      // let manualPlacements = {};
      // let lockedLessons = new Set();
      // let currentProgramData = {};
      // let isRunning = false;
      // let solutions = [];
      // let currentSolution = null;
      // let teacherConstraints = {};
      // let teacherPreferences = {};

      // Sadece bu blokta tanƒ±mlƒ± olmayan yardƒ±mcƒ± fonksiyonlarƒ± (showError, showWarning, showSuccess vb.)
      // kendi kodunuzda tanƒ±mlƒ± olduƒüunu varsayƒ±yoruz.

      function renderManualPlacementContent() {
        // üö® KRƒ∞Tƒ∞K D√úZELTME 1: Veri y√ºkleme i≈ülemini her zaman en ba≈üta yapmalƒ±yƒ±z.
        loadExistingManualPlacements();

        // Artƒ±k manualPlacements deƒüi≈ükeni doludur.
        renderManualTeacherList();

        // Tabloyu y√ºklenen verilere g√∂re √ßiz.
        renderManualPlacementTable();
      }

      function loadExistingManualPlacements() {
        // üö® KRƒ∞Tƒ∞K √á√ñZ√úM BA≈ûLANGICI: lockedLessons'ƒ± Local Storage'dan y√ºkle
        const savedLockedLessons = localStorage.getItem("lockedLessons");

        if (savedLockedLessons) {
          try {
            // Set'i (k√ºme) yeniden olu≈üturuyoruz.
            lockedLessons = new Set(JSON.parse(savedLockedLessons));
            console.log(
              `üîí Kilitli manuel yerle≈ütirmeler y√ºklendi: ${lockedLessons.size} adet`
            );
          } catch (e) {
            console.error(
              "    ‚ùå Kilitli dersler verisi parse hatasƒ±, sƒ±fƒ±rlanƒ±yor:",
              e
            );
            lockedLessons = new Set();
          }
        } else {
          lockedLessons = new Set(); // Veri yoksa bo≈ü Set ile ba≈ülat
        }

        // Mevcut manuel yerle≈ütirmeleri y√ºkle
        const saved = localStorage.getItem("manualPlacements");

        if (saved) {
          try {
            const parsedData = JSON.parse(saved);

            manualPlacements = parsedData;

            // Yerle≈ütirme saya√ßlarƒ±nƒ± g√ºncelle ve kilitli dersleri teyit et
            manualLessonPlacements = {};
            for (const key in manualPlacements) {
              const lesson = manualPlacements[key];
              const lessonId = lesson.id;
              manualLessonPlacements[lessonId] =
                (manualLessonPlacements[lessonId] || 0) + 1;

              // üí° Tutarlƒ±lƒ±k Garantisi: Her ihtimale kar≈üƒ±, manuel yerle≈ütirilen her slotu
              // lockedLessons Set'ine ekle.
              lockedLessons.add(key);
            }

            console.log(
              "üìÇ Mevcut manuel yerle≈ütirmeler y√ºklendi:",
              manualLessonPlacements
            );

            // Eƒüer y√ºkleme anƒ±nda zaten bir √∂ƒüretmen se√ßiliyse, havuzu da g√ºncelle
            if (selectedTeacherForManual) {
              renderManualLessonPool(selectedTeacherForManual);
            }
          } catch (e) {
            console.error(
              "    ‚ùå Manuel yerle≈ütirme verisi parse hatasƒ±, sƒ±fƒ±rlanƒ±yor:",
              e
            );
            manualPlacements = {};
            manualLessonPlacements = {};
          }
        } else {
          manualPlacements = {}; // Veri yoksa bo≈ü nesne ile ba≈ülat
          manualLessonPlacements = {};
        }
      }

      function renderManualTeacherList() {
        const container = document.getElementById("manualTeacherList");
        if (!currentProgramData || !currentProgramData.teachers) {
          container.innerHTML =
            '<div style="text-align: center; color: #888; padding: 20px;">√ñƒüretmen bulunamadƒ±</div>';
          return;
        }

        let html = "";
        currentProgramData.teachers.forEach((teacher) => {
          const branch = (teacher.branch || teacher.brans || "").toLowerCase();
          if (branch.includes("rehberlik")) {
            return;
          }

          html += `
        <div class="sidebar-item" data-teacher-id="${
          teacher.id
        }" id="manual-teacher-${
            teacher.id
          }" style="margin-bottom: 8px; cursor: pointer;">
            <div style="font-weight: 700; color: #00d9ff; font-size: 13px;">${
              teacher.name
            }</div>
            <div style="font-size: 10px; color: #888; margin-top: 4px;">üìö ${
              teacher.branch || teacher.brans || "Bran≈ü"
            }</div>
        </div>`;
        });

        container.innerHTML = html;

        currentProgramData.teachers.forEach((teacher) => {
          const branch = (teacher.branch || teacher.brans || "").toLowerCase();
          if (branch.includes("rehberlik")) return;

          const element = document.getElementById(
            `manual-teacher-${teacher.id}`
          );
          if (element) {
            element.addEventListener("click", () => {
              selectTeacherForManual(teacher.id);
            });
          }
        });
      }

      function selectTeacherForManual(teacherId) {
        console.log("üéØ √ñƒüretmen se√ßildi:", teacherId);
        selectedTeacherForManual = teacherId;

        document
          .querySelectorAll("#manualTeacherList .sidebar-item")
          .forEach((item) => {
            item.classList.remove("active");
          });

        const element = document.getElementById(`manual-teacher-${teacherId}`);
        if (element) {
          element.classList.add("active");
        }

        renderManualLessonPool(teacherId);
        renderManualPlacementTable();
      }

      function renderManualLessonPool(teacherId) {
        const container = document.getElementById("manualLessonPoolItems");
        const teacher = currentProgramData.teachers.find(
          (t) => t.id == teacherId
        );

        if (!teacher) return;

        const teacherLessons = currentProgramData.lessons.filter((lesson) => {
          if (Array.isArray(lesson.teacherId)) {
            return lesson.teacherId.includes(teacherId);
          }
          return lesson.teacherId == teacherId;
        });

        if (teacherLessons.length === 0) {
          container.innerHTML =
            '<div style="font-size: 12px; color: #888;">Bu √∂ƒüretmene ders atanmamƒ±≈ü</div>';
          return;
        }

        let html = "";
        teacherLessons.forEach((lesson) => {
          const placedCount = manualLessonPlacements[lesson.id] || 0;
          const remainingHours = lesson.weeklyHours - placedCount;
          const bgColor = getRandomLightColor();

          html += `
        <div class="lesson-card" draggable="true" ondragstart="dragStartManual(event, '${
          lesson.id
        }')" 
            style="background: ${bgColor}; padding: 12px; border-radius: 8px; cursor: move; min-width: 150px; border: 2px solid ${
            remainingHours > 0 ? "#7b2fff" : "#ff6b6b"
          }; position: relative;">
            ${
              remainingHours <= 0
                ? '<div style="position: absolute; top: 4px; right: 4px; background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">DOLU</div>'
                : ""
            }
            <div style="font-weight: 700; color: #0a0e27; font-size: 13px; margin-bottom: 4px;">${
              lesson.subjectName
            }</div>
            <div style="font-size: 11px; color: #333;">${lesson.className}</div>
            <div style="font-size: 11px; color: #333; margin-top: 4px; font-weight: 600;">
                ${placedCount}/${lesson.weeklyHours} saat yerle≈ütirildi
                ${
                  remainingHours > 0
                    ? `<span style="color: #00f5a0;">‚úì ${remainingHours} saat kaldƒ±</span>`
                    : '<span style="color: #ff6b6b;">‚úó TAM</span>'
                }
            </div>
        </div>`;
        });

        container.innerHTML = html;
      }

      function renderManualPlacementTable() {
        const tbody = document.getElementById("manualPlacementTableBody");
        let html = "";

        if (!selectedTeacherForManual) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #aaa;">L√ºtfen yerle≈ütirmeleri g√∂rmek i√ßin soldan bir √∂ƒüretmen se√ßin.</td></tr>';
          return;
        }

        const classesForSelectedTeacher = currentProgramData.lessons
          .filter((lesson) => {
            const tIds = Array.isArray(lesson.teacherId)
              ? lesson.teacherId
              : [lesson.teacherId];
            return tIds.includes(selectedTeacherForManual);
          })
          .map((lesson) => lesson.classId);

        const uniqueClassIds = [...new Set(classesForSelectedTeacher)];

        for (let hour = 1; hour <= 8; hour++) {
          html += `<tr><td class="hour-header">${hour}. Saat</td>`;

          for (let day = 1; day <= 5; day++) {
            let cellContent =
              '<div style="font-size: 11px; color: #555;">Bo≈ü</div>';
            let foundPlacement = false;

            for (const classId of uniqueClassIds) {
              const key = `${classId}_${day}_${hour}`;

              if (manualPlacements[key]) {
                const lesson = manualPlacements[key];

                const lessonTeacherIds = Array.isArray(lesson.teacherId)
                  ? lesson.teacherId
                  : [lesson.teacherId];

                const isRelevantToSelectedTeacher = lessonTeacherIds.includes(
                  selectedTeacherForManual
                );

                if (isRelevantToSelectedTeacher) {
                  const bgColor = getRandomLightColor();

                  let teacherNames = "√ñƒüretmen";
                  if (lessonTeacherIds.length > 0) {
                    teacherNames = lessonTeacherIds
                      .map((tId) => {
                        const t = currentProgramData.teachers.find(
                          (teacher) => teacher.id == tId
                        );
                        return t ? t.name : "Bilinmeyen";
                      })
                      .join(" & ");
                  }

                  cellContent = `
                            <div class="lesson-cell" style="background: ${bgColor}; padding: 8px; border-radius: 6px; position: relative; border: 2px solid #00f5a0;">
                                <button onclick="removeManualLesson('${key}')" style="position: absolute; top: 2px; right: 2px; background: rgba(255,0,0,0.7); border: none; border-radius: 4px; color: white; cursor: pointer; padding: 2px 6px; font-size: 10px;">√ó</button>
                                <div style="font-weight: 700; color: #0a0e27; font-size: 12px;">üîí ${lesson.subjectName}</div>
                                <div style="font-size: 10px; color: #333;">${lesson.className}</div>
                                <div style="font-size: 10px; color: #333; font-weight: 600;">${teacherNames}</div>
                            </div>`;
                  foundPlacement = true;
                  break;
                }
              }
            }

            html += `
            <td class="empty-cell" data-day="${day}" data-hour="${hour}" ondrop="dropManualLesson(event)" ondragover="allowDropManual(event)" style="min-height: 60px; vertical-align: top;">
                ${cellContent}
            </td>`;
          }

          html += `</tr>`;
        }

        tbody.innerHTML = html;
      }

      function dragStartManual(event, lessonId) {
        event.dataTransfer.setData("lessonId", lessonId);
        event.target.style.opacity = "0.5";
      }

      function allowDropManual(event) {
        event.preventDefault();
        const cell = event.target.closest("td");
        if (cell) {
          cell.style.background = "rgba(0, 217, 255, 0.2)";
        }
      }

      function dropManualLesson(event) {
        event.preventDefault();
        const cell = event.target.closest("td");
        if (!cell) return;

        cell.style.background = "";

        const lessonId = event.dataTransfer.getData("lessonId");
        const day = parseInt(cell.dataset.day);
        const hour = parseInt(cell.dataset.hour);

        const lesson = currentProgramData.lessons.find(
          (l) => l.id === lessonId
        );
        if (!lesson) return;
        if (!selectedTeacherForManual) {
          showError("‚ùå L√ºtfen √∂nce bir √∂ƒüretmen se√ßin!");
          return;
        }

        const lessonTeachers = Array.isArray(lesson.teacherId)
          ? lesson.teacherId
          : [lesson.teacherId];
        if (!lessonTeachers.includes(selectedTeacherForManual)) {
          showError(
            `‚ùå Se√ßilen √∂ƒüretmen (${
              currentProgramData.teachers.find(
                (t) => t.id == selectedTeacherForManual
              )?.name
            }) bu dersi (${lesson.subjectName} - ${lesson.className}) vermiyor.`
          );
          return;
        }

        const placedCount = manualLessonPlacements[lessonId] || 0;
        const remainingHours = lesson.weeklyHours - placedCount;

        if (remainingHours <= 0) {
          showError(
            `‚ùå ${lesson.subjectName} dersi i√ßin t√ºm saatler zaten yerle≈ütirildi! (${lesson.weeklyHours}/${lesson.weeklyHours})`
          );
          return;
        }

        const key = `${lesson.classId}_${day}_${hour}`;

        if (manualPlacements[key]) {
          showWarning(
            `‚ö†Ô∏è ${lesson.className} sƒ±nƒ±fƒ± i√ßin bu h√ºcrede zaten bir ders var!`
          );
          return;
        }

        const lessonTeacherIds = lessonTeachers;

        for (const existingKey in manualPlacements) {
          const existingLesson = manualPlacements[existingKey];
          const parts = existingKey.split("_");

          if (
            parts.length >= 3 &&
            parseInt(parts[1]) === day &&
            parseInt(parts[2]) === hour
          ) {
            const existingTeacherIds = Array.isArray(existingLesson.teacherId)
              ? existingLesson.teacherId
              : [existingLesson.teacherId];

            const conflictingTeacher = lessonTeacherIds.find((tId) =>
              existingTeacherIds.includes(tId)
            );

            if (conflictingTeacher) {
              showError(
                `‚ùå √ñƒüretmen √ßakƒ±≈ümasƒ±! ${
                  currentProgramData.teachers.find(
                    (t) => t.id == conflictingTeacher
                  )?.name
                } zaten bu saatte ${existingLesson.className} dersinde.`
              );
              return;
            }
          }
        }

        manualPlacements[key] = {
          ...lesson,
          manualTeacherId: selectedTeacherForManual,
          locked: true,
        };

        lockedLessons.add(key);

        manualLessonPlacements[lessonId] = placedCount + 1;

        renderManualPlacementTable();
        renderManualLessonPool(selectedTeacherForManual);

        showSuccess(
          `‚úÖ ${lesson.subjectName} dersi yerle≈ütirildi! (${placedCount + 1}/${
            lesson.weeklyHours
          })`
        );
      }

      function removeManualLesson(key) {
        event.stopPropagation();

        if (!manualPlacements[key]) return;

        const lesson = manualPlacements[key];
        const lessonId = lesson.id;

        delete manualPlacements[key];

        lockedLessons.delete(key);

        if (manualLessonPlacements[lessonId]) {
          manualLessonPlacements[lessonId]--;
          if (manualLessonPlacements[lessonId] <= 0) {
            delete manualLessonPlacements[lessonId];
          }
        }

        renderManualPlacementTable();
        if (selectedTeacherForManual) {
          renderManualLessonPool(selectedTeacherForManual);
        }

        showInfo("üóëÔ∏è Ders kaldƒ±rƒ±ldƒ±");
      }

      function saveManualPlacement() {
        if (Object.keys(manualPlacements).length === 0) {
          showWarning("Hi√ß ders yerle≈ütirmediniz!");
          return;
        }

        localStorage.setItem(
          "manualPlacements",
          JSON.stringify(manualPlacements)
        );
        // üí° KRƒ∞Tƒ∞K: Daƒüƒ±tƒ±m algoritmasƒ±nƒ±n kullanacaƒüƒ± kilitli dersler listesini kaydet.
        localStorage.setItem(
          "lockedLessons",
          JSON.stringify(Array.from(lockedLessons))
        );

        showSuccess(
          `‚úÖ ${lockedLessons.size} ders kilitlendi! Daƒüƒ±tƒ±m bu derslere dokunmayacak.`
        );
        // closeManualPlacementModal() fonksiyonunun tanƒ±mlƒ± olduƒüu varsayƒ±lƒ±r.
        closeManualPlacementModal();
      }

      function clearManualPlacement() {
        if (Object.keys(manualPlacements).length === 0) {
          showInfo("Temizlenecek yerle≈ütirme yok!");
          return;
        }

        const modal = document.createElement("div");
        modal.className = "modal-overlay active";
        modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üóëÔ∏è</div>
                <h3 style="color: #ff6b6b; margin-bottom: 16px;">Manuel Yerle≈ütirmeleri Temizle</h3>
                <p style="color: #ccc; font-size: 14px; margin-bottom: 24px;">
                    <strong style="color: #fff;">${
                      Object.keys(manualPlacements).length
                    } manuel yerle≈ütirme</strong> silinecek.
                </p>
                <div style="background: rgba(255,107,107,0.1); padding: 12px; border-radius: 8px; margin-bottom: 24px;">
                    <div style="font-size: 12px; color: #ff6b6b;">
                        ‚ö†Ô∏è T√ºm kilitli dersler silinecek<br>
                        ‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        ‚ùå ƒ∞ptal
                    </button>
                    <button class="btn btn-danger" onclick="confirmClearManualPlacement(); this.closest('.modal-overlay').remove();">
                        üóëÔ∏è Evet, Temizle
                    </button>
                </div>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
      }

      function confirmClearManualPlacement() {
        manualPlacements = {};
        manualLessonPlacements = {};
        lockedLessons.clear();
        selectedTeacherForManual = null;

        localStorage.removeItem("manualPlacements");
        localStorage.removeItem("lockedLessons");

        renderManualPlacementTable();
        document.getElementById("manualLessonPoolItems").innerHTML =
          '<div style="font-size: 12px; color: #888;">√ñƒüretmen se√ßin...</div>';

        showSuccess("‚úÖ T√ºm manuel yerle≈ütirmeler temizlendi!");
      }

      function getRandomLightColor() {
        const colors = [
          "#e3f2fd",
          "#f3e5f5",
          "#e8f5e9",
          "#fff3e0",
          "#fce4ec",
          "#e0f2f1",
          "#f1f8e9",
          "#ede7f6",
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }
      // DAƒûITIM FONKSƒ∞YONU G√úNCELLEMESƒ∞ (Hƒ∞BRƒ∞T Sƒ∞STEM ENTEGRASYONu)
      // =========================================================================

      async function startDistribution() {
        try {
          // üö® KRƒ∞Tƒ∞K D√úZELTME 1: Manuel veriyi yeniden y√ºkle
          if (typeof loadExistingManualPlacements === "function") {
            console.log("üìÇ Manuel yerle≈ütirmeler y√ºkleniyor...");
            await loadExistingManualPlacements();
            console.log(
              "üõ†Ô∏è Manuel yerle≈ütirmeler:",
              JSON.parse(JSON.stringify(manualPlacements))
            );
          }

          console.log("üöÄ Daƒüƒ±tƒ±m ba≈ülatƒ±lƒ±yor...");

          if (isRunning) {
            showWarning("Zaten bir daƒüƒ±tƒ±m √ßalƒ±≈üƒ±yor!");
            return;
          }

          if (
            !currentProgramData ||
            !currentProgramData.lessons ||
            currentProgramData.lessons.length === 0
          ) {
            showError("Program verileri y√ºklenemedi veya bo≈ü!");
            return;
          }

          const algorithmData = currentProgramData;

          console.log("üìä Program Data:");
          console.log("   ‚Ä¢ Toplam ders:", algorithmData.lessons.length);
          console.log(
            "   ‚Ä¢ Toplam saat:",
            algorithmData.lessons.reduce(
              (sum, l) => sum + (parseInt(l.weeklyHours) || 0),
              0
            )
          );

          // AYARLARI TOPLA
          const settings = collectSettings();
          const isRandomOffDayEnabled =
            document
              .getElementById("toggle-random-offday")
              ?.classList.contains("active") || false;

          console.log(
            `‚öôÔ∏è Random Off Day: ${isRandomOffDayEnabled ? "Aktif" : "Pasif"}`
          );

          settings.constraints = teacherConstraints;
          settings.lockedLessons = Array.from(lockedLessons);
          settings.manualPlacements = manualPlacements;
          settings.preferences = teacherPreferences;
          settings.mebBeden =
            document
              .getElementById("toggle-meb-beden")
              ?.classList.contains("active") || false;
          settings.mebSanat =
            document
              .getElementById("toggle-meb-sanat")
              ?.classList.contains("active") || false;
          settings.specialTeachers = getSpecialTeachers();
          settings.generalSettings = getGeneralSettings();
          settings.teacherLimits = getAllTeacherLimits();

          // UI G√ºncellemeleri
          isRunning = true;
          solutions = [];
          document.getElementById("btnBaslat").disabled = true;
          document.getElementById("btnIptal").style.display = "flex";
          document.getElementById("btnYenidenDagit").style.display = "none";
          document.getElementById("btnTemizle").style.display = "none";
          document.getElementById("programDurum").textContent =
            "‚ö° √áalƒ±≈üƒ±yor...";
          document.getElementById("solutionsList").innerHTML =
            '<div class="empty-state"><div class="empty-icon">‚öôÔ∏è</div><div class="empty-title">AI √áalƒ±≈üƒ±yor...</div><div class="empty-text">Algoritma en iyi √ß√∂z√ºm√º arƒ±yor...</div></div>';

          previousSolution = currentSolution
            ? JSON.parse(JSON.stringify(currentSolution))
            : null;

          startTime = Date.now();
          startTimer();
          startLiveSimulation();

          console.log("üöÄ Simple Block Scheduler ba≈ülatƒ±lƒ±yor...");

          if (typeof SimpleBlockScheduler === "undefined") {
            throw new Error("SimpleBlockScheduler y√ºklenmemi≈ü!");
          }

          // =========================================================================
          // üî• AKILLI YENƒ∞DEN DENEME Sƒ∞STEMƒ∞
          // =========================================================================

          const MAX_ATTEMPTS = 15; // Maksimum deneme sayƒ±sƒ±
          let bestResult = null;
          let bestPlacedHours = 0;
          let attemptNumber = 0;

          console.log(`üîÑ Maksimum ${MAX_ATTEMPTS} deneme yapƒ±lacak...`);

          const dataWithManual = {
            ...algorithmData,
            manualPlacements: JSON.parse(JSON.stringify(manualPlacements)),
            isRandomOffDayEnabled: isRandomOffDayEnabled,
            globalDailyLimitEnabled:
              settings.generalSettings?.globalDailyLimitEnabled || false,
            globalMinDaily: settings.generalSettings?.globalMinDaily || 0,
            globalMaxDaily: settings.generalSettings?.globalMaxDaily || 8,
            globalGapLimitEnabled:
              settings.generalSettings?.globalGapLimitEnabled || false,
            globalMaxGaps: settings.generalSettings?.globalMaxGaps || 999,
          };

          for (
            attemptNumber = 1;
            attemptNumber <= MAX_ATTEMPTS;
            attemptNumber++
          ) {
            console.log(`\nüîÑ DENEME ${attemptNumber}/${MAX_ATTEMPTS}`);

            try {
              const simpleScheduler = new SimpleBlockScheduler(
                dataWithManual,
                Array.from(lockedLessons)
              );

              const result = simpleScheduler.solve();

              if (!result) {
                console.warn(`   ‚ö†Ô∏è Deneme ${attemptNumber}: Sonu√ß null`);
                continue;
              }

              const totalHours = result.stats?.totalHours || 0;
              const placedHours = result.stats?.placedHours || 0;
              const successRate =
                totalHours > 0 ? (placedHours / totalHours) * 100 : 0;

              console.log(
                `   üìä Deneme ${attemptNumber}: ${placedHours}/${totalHours} saat yerle≈ütirildi (${successRate.toFixed(
                  1
                )}%)`
              );

              // En iyi sonucu sakla
              if (placedHours > bestPlacedHours) {
                bestPlacedHours = placedHours;
                bestResult = result;
                console.log(`   ‚ú® Yeni en iyi sonu√ß: ${placedHours} saat`);
              }

              // %95'ten fazla ba≈üarƒ± varsa dur
              if (successRate >= 95) {
                console.log(
                  `   üéâ Yeterli ba≈üarƒ± oranƒ±! (%${successRate.toFixed(1)})`
                );
                bestResult = result;
                break;
              }

              // Tam ba≈üarƒ± varsa kesinlikle dur
              if (result.success) {
                console.log(`   ‚úÖ Deneme ${attemptNumber}: TAM BA≈ûARI!`);
                bestResult = result;
                break;
              }
            } catch (err) {
              console.warn(
                `   ‚ùå Deneme ${attemptNumber} hatasƒ±:`,
                err.message
              );
            }
          }

          // En iyi sonucu kontrol et
          if (!bestResult || bestPlacedHours === 0) {
            throw new Error(
              `${MAX_ATTEMPTS} denemede hi√ß ders yerle≈ütirilemedi! Kƒ±sƒ±tlarƒ± ve bo≈ü g√ºn tercihlerini kontrol edin.`
            );
          }

          const totalHours = bestResult.stats?.totalHours || 0;
          const missingHours = totalHours - bestPlacedHours;

          if (missingHours > 0) {
            const warningPercent =
              ((totalHours - missingHours) / totalHours) * 100;
            console.warn(
              `‚ö†Ô∏è UYARI: ${missingHours} saat yerle≈ütirilemedi (%${(
                100 - warningPercent
              ).toFixed(1)} eksik)`
            );
            console.warn(
              `   üí° ƒ∞pucu: Kƒ±sƒ±tlarƒ± gev≈üetin veya bo≈ü g√ºn tercihlerini azaltƒ±n.`
            );

            // %80'den az ba≈üarƒ± varsa hata ver
            if (warningPercent < 80) {
              throw new Error(
                `Daƒüƒ±tƒ±m yetersiz! Sadece %${warningPercent.toFixed(
                  1
                )} ba≈üarƒ±. ${missingHours} saat yerle≈ütirilemedi.`
              );
            }
          }

          console.log(
            `\n‚úÖ EN ƒ∞Yƒ∞ SONU√á: ${bestPlacedHours}/${totalHours} saat yerle≈ütirildi (${attemptNumber} deneme)`
          );

          // =========================================================================
          // EN ƒ∞Yƒ∞ SONUCU KULLAN
          // =========================================================================

          let bestSchedule = bestResult.schedule;
          let bestFitness = 100;
          let scheduleSource = "Simple Block Scheduler";

          // Hƒ∞BRƒ∞T OPTƒ∞Mƒ∞ZASYON (Opsiyonel)
          const useHybridOptimization =
            document
              .getElementById("toggle-hybrid-optimization")
              ?.classList.contains("active") || false;

          if (
            useHybridOptimization &&
            typeof HybridOptimizerWrapper !== "undefined"
          ) {
            console.log("\nüî• Hƒ∞BRƒ∞T OPTƒ∞Mƒ∞ZASYON AKTƒ∞F!");

            try {
              const hybridOptimizer = new HybridOptimizerWrapper({
                maxIterations: settings.maxIterations || 1000,
                populationSize: settings.populationSize || 50,
                timeLimit: 60000,
                algorithms: {
                  genetic: true,
                  sa: true,
                  aco: false,
                  tabu: false,
                },
              });

              const optimizationResult = await hybridOptimizer.optimize(
                bestSchedule,
                currentProgramData,
                {
                  onProgress: (data) => {
                    console.log(
                      `   üìä Hibrit optimizasyon: ${data.progress || 0}%`
                    );
                  },
                }
              );

              if (optimizationResult.success) {
                bestSchedule = optimizationResult.schedule;
                bestFitness = optimizationResult.fitness;
                scheduleSource =
                  "Hybrid Optimizer (SimpleBlock + Meta-Heuristics)";
                console.log("‚úÖ Hibrit optimizasyon ba≈üarƒ±lƒ±!");
              } else {
                console.warn("‚ö†Ô∏è Hibrit optimizasyon ba≈üarƒ±sƒ±z");
              }
            } catch (error) {
              console.error("‚ùå Hibrit optimizasyon hatasƒ±:", error);
            }
          }

          console.log(`‚úÖ Schedule kaynaƒüƒ±: ${scheduleSource}`);

          // TEACHER ID FIX
          if (
            bestSchedule &&
            currentProgramData &&
            currentProgramData.lessons
          ) {
            console.log("üîß Teacher ID'leri d√ºzeltiliyor...");

            let fixedCount = 0;
            let totalLessons = 0;

            for (const classId in bestSchedule) {
              if (
                isNaN(parseInt(classId)) ||
                classId.toString() !== parseInt(classId).toString()
              )
                continue;

              for (const day in bestSchedule[classId]) {
                for (const hour in bestSchedule[classId][day]) {
                  const lesson = bestSchedule[classId][day][hour];

                  if (lesson) {
                    totalLessons++;

                    const lessonTeacherId = Array.isArray(lesson.teacherId)
                      ? lesson.teacherId
                      : [lesson.teacherId];
                    const isTeacherIdMissing =
                      !lessonTeacherId ||
                      lessonTeacherId.length === 0 ||
                      lessonTeacherId.every((id) => !id);

                    if (isTeacherIdMissing) {
                      const originalLesson = currentProgramData.lessons.find(
                        (l) => l.id.toString() === lesson.id.toString()
                      );

                      if (originalLesson && originalLesson.teacherId) {
                        if (Array.isArray(originalLesson.teacherId)) {
                          lesson.teacherId = [...originalLesson.teacherId];
                        } else {
                          lesson.teacherId = [originalLesson.teacherId];
                        }
                        fixedCount++;
                      }
                    }
                  }
                }
              }
            }

            console.log(
              `‚úÖ Teacher ID d√ºzeltme: ${fixedCount}/${totalLessons} ders`
            );
          }

          // Toplam slot sayƒ±sƒ±
          let totalSlots = 0;
          for (const classId in bestSchedule) {
            if (
              isNaN(parseInt(classId)) ||
              classId.toString() !== parseInt(classId).toString()
            )
              continue;
            for (const day in bestSchedule[classId]) {
              for (const time in bestSchedule[classId][day]) {
                if (bestSchedule[classId][day][time]) totalSlots++;
              }
            }
          }
          console.log("‚úÖ Toplam yerle≈ütirilmi≈ü slot:", totalSlots);

          if (totalSlots === 0) {
            throw new Error("Hi√ß ders yerle≈ütirilemedi!");
          }

          // √á√ñZ√úM OLU≈ûTUR
          solutions = [
            {
              rank: 1,
              name: "En ƒ∞yi √á√∂z√ºm",
              fitness: Math.round(bestFitness),
              conflicts: 0,
              gaps: 0,
              balance: 1.0,
              blocks: 0,
              schedule: bestSchedule,
              timestamp: new Date().toISOString(),
              source: scheduleSource,
            },
          ];

          currentSolution = bestSchedule;

          handleComplete({
            success: true,
            schedule: currentSolution,
            stats: {
              totalLessons: totalSlots,
              fitness: bestFitness,
              source: scheduleSource,
              attempts: attemptNumber,
              placedHours: bestPlacedHours,
              totalHours: totalHours,
              dailyMinViolations: bestResult.violationReports?.dailyMinLimit
                ? Object.keys(bestResult.violationReports.dailyMinLimit).length
                : 0,
            },
            validation: {
              conflicts: 0,
              violations: 0,
              violationReports: bestResult.violationReports,
            },
          });

          console.log(`üéâ Daƒüƒ±tƒ±m tamamlandƒ±! (${attemptNumber} deneme)`);
        } catch (error) {
          console.error("‚ùå Daƒüƒ±tƒ±m hatasƒ±:", error);
          if (error.stack) {
            console.error("Stack trace:", error.stack);
          }
          showError("Daƒüƒ±tƒ±m hatasƒ±: " + error.message);
          handleError(error);
        }
      }
      // ============================================
      // CALLBACK FONKSƒ∞YONLARI
      // ============================================
      function handleProgress(progress) {
        try {
          const fitness = Math.round(progress.fitness || progress.score || 0);
          const fitnessEl = document.getElementById("fitnessValue");
          fitnessEl.textContent = fitness;
          if (fitness < 400) {
            fitnessEl.className = "fitness-value low";
          } else if (fitness < 700) {
            fitnessEl.className = "fitness-value medium";
          } else {
            fitnessEl.className = "fitness-value high";
          }
          if (progress.iteration !== undefined) {
            document.getElementById("iterationCount").textContent =
              progress.iteration;
          }
          if (progress.algorithm) {
            document.getElementById("activeAlgorithm").textContent =
              progress.algorithm;
          }
        } catch (error) {
          console.warn("‚ö†Ô∏è Progress handler hatasƒ±:", error);
        }
      }

      function handleAlgorithmStart(algorithmName) {
        console.log(`üéØ Algoritma ba≈üladƒ±: ${algorithmName}`);
        const algoMap = {
          "Genetic Algorithm": "genetic",
          "Ant Colony": "aco",
          "Simulated Annealing": "sa",
          "Tabu Search": "tabu",
          "Reinforcement Learning": "rl",
          "Fuzzy Logic": "fuzzy",
        };
        const algoKey = algoMap[algorithmName] || algorithmName.toLowerCase();
        const card = document.querySelector(`[data-algo="${algoKey}"]`);
        if (card) {
          card.classList.add("active");
          card.classList.remove("completed");
        }
      }

      function handleAlgorithmComplete(algorithmName, result) {
        console.log(`‚úÖ Algoritma tamamlandƒ±: ${algorithmName}`, result);
        const algoMap = {
          "Genetic Algorithm": "genetic",
          "Ant Colony": "aco",
          "Simulated Annealing": "sa",
          "Tabu Search": "tabu",
          "Reinforcement Learning": "rl",
          "Fuzzy Logic": "fuzzy",
        };
        const algoKey = algoMap[algorithmName] || algorithmName.toLowerCase();
        const card = document.querySelector(`[data-algo="${algoKey}"]`);
        if (card) {
          card.classList.remove("active");
          card.classList.add("completed");
          const progressBar = card.querySelector(".algorithm-progress-bar");
          if (progressBar) progressBar.style.width = "100%";
          const scoreSpan = card.querySelector(".algorithm-score span");
          if (scoreSpan && result && result.score) {
            scoreSpan.textContent = Math.round(result.score);
          }
        }
      }

      function handleSolutionFound(solution, rank) {
        console.log(`üèÜ √á√∂z√ºm bulundu - Rank: ${rank}`, solution);
        renderSolutions();
      }

      function handleConflictUpdate(conflicts) {
        try {
          document.getElementById("conflictTeacher").textContent =
            conflicts.teacher || 0;
          document.getElementById("conflictClass").textContent =
            conflicts.class || 0;
          document.getElementById("conflictGap").textContent =
            conflicts.gap || 0;
          document.getElementById("conflictBlock").textContent =
            conflicts.block || 0;
          document.getElementById("conflictConstraint").textContent =
            conflicts.constraint || 0;

          ["Teacher", "Class", "Gap", "Block", "Constraint"].forEach((type) => {
            const el = document.getElementById(`conflict${type}`);
            if (el) {
              el.className =
                conflicts[type.toLowerCase()] === 0
                  ? "conflict-count zero"
                  : "conflict-count";
            }
          });

          if (conflicts.balance !== undefined) {
            document.getElementById("balanceScore").textContent =
              Math.round(conflicts.balance * 100) + "%";
          }
        } catch (error) {
          console.warn("‚ö†Ô∏è Conflict update hatasƒ±:", error);
        }
      }
      // ============================================
      // Sƒ∞M√úLASYON
      // ============================================
      let simulationInterval = null;

      function startLiveSimulation() {
        let iteration = 0;
        let currentFitness = 0;
        let algoIndex = 0;
        const algoNames = [
          "Genetik Algoritma",
          "Karƒ±nca Kolonisi",
          "Tavlama Benzetimi",
          "Tabu Arama",
          "Peki≈ütirmeli √ñƒürenme",
          "Bulanƒ±k Mantƒ±k",
        ];
        const algorithms = ["genetic", "aco", "sa", "tabu", "rl", "fuzzy"];

        simulationInterval = setInterval(() => {
          if (!isRunning) {
            clearInterval(simulationInterval);
            return;
          }

          iteration += Math.floor(Math.random() * 50) + 10;
          currentFitness = Math.min(
            950,
            currentFitness + Math.floor(Math.random() * 20) + 5
          );

          handleProgress({
            iteration: iteration,
            fitness: currentFitness,
            algorithm: algoNames[algoIndex % algoNames.length],
          });

          if (iteration % 100 === 0 && algoIndex < algorithms.length) {
            handleAlgorithmStart(algoNames[algoIndex]);
            setTimeout(() => {
              handleAlgorithmComplete(algoNames[algoIndex], {
                score: Math.floor(Math.random() * 100) + 50,
              });
            }, 1500);
            algoIndex++;
          }

          handleConflictUpdate({
            teacher: Math.max(0, 5 - Math.floor(iteration / 200)),
            class: Math.max(0, 3 - Math.floor(iteration / 250)),
            gap: Math.max(0, 8 - Math.floor(iteration / 150)),
            block: Math.max(0, 4 - Math.floor(iteration / 200)),
            constraint: Math.max(0, 2 - Math.floor(iteration / 300)),
            balance: Math.min(1, 0.5 + iteration / 2000),
          });

          if (iteration > 1000) {
            clearInterval(simulationInterval);
          }
        }, 300);

        console.log("üîÑ Canlƒ± sim√ºlasyon ba≈ülatƒ±ldƒ±");
      }

      // ============================================
      // TAMAMLANDI + HATA HANDLER
      // ============================================
      function handleComplete(result) {
        try {
          console.log("üéâ Daƒüƒ±tƒ±m tamamlandƒ± callback:", result);

          isRunning = false;
          stopTimer();
          if (simulationInterval) clearInterval(simulationInterval);

          document.getElementById("btnBaslat").disabled = false;
          document.getElementById("btnIptal").style.display = "none";
          document.getElementById("btnYenidenDagit").style.display = "flex";
          document.getElementById("btnTemizle").style.display = "flex";
          document.getElementById("programDurum").textContent = "‚úÖ Tamamlandƒ±";

          // ‚úÖ √á√∂z√ºm sayƒ±sƒ± kontrol√º
          if (solutions.length === 0) {
            console.warn("‚ö†Ô∏è Solutions array bo≈ü!");
            showWarning("√á√∂z√ºm olu≈üturulamadƒ±!");
            return;
          }

          console.log(`üìä Toplam ${solutions.length} √ß√∂z√ºm bulundu`);

          // ‚úÖ ƒ∞lk √ß√∂z√ºm√º se√ß
          const bestSolution = solutions[0];
          console.log("üèÜ En iyi √ß√∂z√ºm:", bestSolution);

          // ‚úÖ Schedule kontrol√º
          if (!bestSolution.schedule) {
            console.error("‚ùå Best solution'da schedule yok!");
            showError("Schedule olu≈üturulamadƒ±!");
            return;
          }

          // ‚úÖ currentSolution'ƒ± g√ºncelle
          currentSolution = bestSolution.schedule;
          console.log(
            "‚úÖ currentSolution g√ºncellendi:",
            Object.keys(currentSolution).length,
            "sƒ±nƒ±f"
          );

          // ‚úÖ KRƒ∞Tƒ∞K: Ders sayƒ±sƒ±nƒ± kontrol et
          let totalLessonsInSolution = 0;
          for (const classId in currentSolution) {
            for (const day in currentSolution[classId]) {
              for (const hour in currentSolution[classId][day]) {
                if (currentSolution[classId][day][hour]) {
                  totalLessonsInSolution++;
                }
              }
            }
          }
          console.log(
            `üìö currentSolution i√ßinde ${totalLessonsInSolution} ders var`
          );

          if (totalLessonsInSolution === 0) {
            console.error("‚ùå currentSolution bo≈ü!");
            showError("Hi√ß ders yerle≈ütirilemedi!");
            return;
          }

          // ‚úÖ √á√∂z√ºm listesini render et
          renderSolutions();

          // ‚úÖ Kar≈üƒ±la≈ütƒ±rma butonu
          if (solutions.length > 1) {
            document.getElementById("btnKarsilastir").style.display = "flex";
          }

          // üî• KRƒ∞Tƒ∞K: PROGRAM G√ñR√úNT√úLE BUTONUNU AKTƒ∞F YAP VE OTOMATƒ∞K A√á
          console.log("üéØ Program modalƒ± otomatik a√ßƒ±lƒ±yor...");

          // Program g√∂r√ºnt√ºle butonunu g√∂ster
          const btnProgramGoruntule = document.getElementById(
            "btnProgramGoruntule"
          );
          if (btnProgramGoruntule) {
            btnProgramGoruntule.style.display = "flex";
            btnProgramGoruntule.disabled = false;
          }

          // 500ms sonra modalƒ± otomatik a√ß
          setTimeout(() => {
            showProgramModal();
          }, 500);

          // ‚úÖ Deƒüi≈üiklik kontrol√º (varsa)
          if (previousSolution) {
            const changes = detectChanges(previousSolution, currentSolution);
            if (changes.length > 0) {
              showChangesModal(changes);
            } else {
              showSuccessModal();
            }
          } else {
            showSuccessModal();
          }

          // Ba≈üarƒ± bildirimi
          const elapsed = Math.round((Date.now() - startTime) / 1000);
          showSuccess(
            `üéâ Daƒüƒ±tƒ±m ba≈üarƒ±yla tamamlandƒ±! ${solutions.length} √ß√∂z√ºm √ºretildi. (${elapsed}s)`
          );

          // ============================================
          // üî• BURAYA EKLE! (SATIR 8180 Cƒ∞VARI)
          // ============================================
          try {
            if (currentSolution && Object.keys(currentSolution).length > 0) {
              localStorage.setItem(
                "currentSolution",
                JSON.stringify(currentSolution)
              );
              console.log(
                "‚úÖ RAPORLAR ƒ∞√áƒ∞N: currentSolution localStorage'a kaydedildi"
              );
              console.log(
                "   ‚Ä¢ Sƒ±nƒ±f sayƒ±sƒ±:",
                Object.keys(currentSolution).length
              );
            }
          } catch (error) {
            console.error("‚ùå localStorage kayƒ±t hatasƒ±:", error);
          }
          // ============================================

          console.log("‚úÖ handleComplete tamamlandƒ±");
        } catch (error) {
          console.error("‚ùå handleComplete hatasƒ±:", error);
          showError("Tamamlama hatasƒ±: " + error.message);
        }
      }

      function handleError(error) {
        console.error("‚ùå Algoritma hatasƒ±:", error);
        isRunning = false;
        stopTimer();
        if (simulationInterval) clearInterval(simulationInterval);

        document.getElementById("btnBaslat").disabled = false;
        document.getElementById("btnIptal").style.display = "none";
        document.getElementById("programDurum").textContent = "‚ùå Hata";
        showError("Daƒüƒ±tƒ±m sƒ±rasƒ±nda hata olu≈ütu: " + (error.message || error));
      }

      function cancelDistribution() {
        if (!isRunning) return;
        console.log("‚èπÔ∏è Daƒüƒ±tƒ±m iptal ediliyor...");
        if (
          algorithmInstance &&
          typeof algorithmInstance.cancel === "function"
        ) {
          algorithmInstance.cancel();
        }
        isRunning = false;
        stopTimer();
        if (simulationInterval) clearInterval(simulationInterval);
        document.getElementById("btnBaslat").disabled = false;
        document.getElementById("btnIptal").style.display = "none";
        document.getElementById("programDurum").textContent = "‚èπÔ∏è ƒ∞ptal Edildi";
        showWarning("Daƒüƒ±tƒ±m kullanƒ±cƒ± tarafƒ±ndan iptal edildi");
      }

      async function redoDistribution() {
        if (isRunning) {
          showWarning("Zaten bir daƒüƒ±tƒ±m √ßalƒ±≈üƒ±yor!");
          return;
        }
        showInfo("üîÑ Yeniden daƒüƒ±tƒ±m ba≈ülatƒ±lƒ±yor...");
        await startDistribution();
      }

      function clearDistribution() {
        if (isRunning) {
          showWarning("Daƒüƒ±tƒ±m devam ederken temizlenemez!");
          return;
        }

        if (!confirm("‚ö†Ô∏è T√ºm daƒüƒ±tƒ±m sonu√ßlarƒ± silinecek. Emin misiniz?")) {
          return;
        }

        solutions = [];
        currentSolution = null;
        previousSolution = null;
        lockedLessons.clear();
        manualPlacements = {};

        document.getElementById("solutionsList").innerHTML =
          '<div class="empty-state"><div class="empty-icon">ü§ñ</div><div class="empty-title">AI Motoru Hazƒ±r</div><div class="empty-text">Daƒüƒ±tƒ±mƒ± ba≈ülattƒ±ƒüƒ±nƒ±zda yapay zeka 45+ algoritma ile en iyi 5 √ß√∂z√ºm√º burada listeleyecek</div></div>';
        document.getElementById("btnKarsilastir").style.display = "none";
        document.getElementById("btnYenidenDagit").style.display = "none";
        document.getElementById("btnTemizle").style.display = "none";
        document.getElementById("programDurum").textContent = "Veriler Hazƒ±r ‚úì";

        document.getElementById("fitnessValue").textContent = "0";
        document.getElementById("iterationCount").textContent = "0";
        document.getElementById("elapsedTime").textContent = "00:00";
        document.getElementById("activeAlgorithm").textContent = "-";

        document.querySelectorAll(".algorithm-card").forEach((card) => {
          card.classList.remove("active", "completed");
          card.querySelector(".algorithm-progress-bar").style.width = "0%";
          card.querySelector(".algorithm-score span").textContent = "0";
        });

        // Program g√∂r√ºnt√ºle butonunu gizle
        const btnProgramGoruntule = document.getElementById(
          "btnProgramGoruntule"
        );
        if (btnProgramGoruntule) {
          btnProgramGoruntule.style.display = "none";
        }

        showSuccess("üóëÔ∏è Daƒüƒ±tƒ±m temizlendi! Yeni daƒüƒ±tƒ±m i√ßin hazƒ±r.");
      }

      // ============================================
      // TIMER
      // ============================================
      function startTimer() {
        timerInterval = setInterval(() => {
          if (!startTime) return;
          const elapsed = Date.now() - startTime;
          const minutes = Math.floor(elapsed / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);
          document.getElementById("elapsedTime").textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }, 1000);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      // ============================================
      // √á√ñZ√úMLERI RENDER ET
      // ============================================
      function renderSolutions() {
        const container = document.getElementById("solutionsList");
        if (solutions.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><div class="empty-icon">ü§ñ</div><div class="empty-title">AI Motoru Hazƒ±r</div><div class="empty-text">Daƒüƒ±tƒ±mƒ± ba≈ülattƒ±ƒüƒ±nƒ±zda en iyi 5 √ß√∂z√ºm burada listelenecek</div></div>';
          return;
        }

        let html = "";
        solutions.forEach((sol, index) => {
          const isBest = index === 0;
          html += `
            <div class="solution-card ${isBest ? "best" : ""} fade-in">
              <div class="solution-header">
                <div class="solution-rank">${
                  isBest ? "üëë En ƒ∞yi" : "#" + sol.rank
                }</div>
                <div class="solution-score">${sol.fitness}</div>
              </div>
              <div class="solution-metrics">
                <div class="metric-item">√áakƒ±≈üma<span style="color: ${
                  sol.conflicts === 0 ? "#00f5a0" : "#ff6b6b"
                }">${sol.conflicts}</span></div>
                <div class="metric-item">Bo≈üluk<span style="color: ${
                  sol.gaps === 0 ? "#00f5a0" : "#ffbb33"
                }">${sol.gaps}</span></div>
                <div class="metric-item">Denge<span style="color: #00d9ff">${(
                  sol.balance * 100
                ).toFixed(0)}%</span></div>
                <div class="metric-item">Blok<span style="color: #7b2fff">${(
                  sol.blocks * 100
                ).toFixed(0)}%</span></div>
              </div>
              <div class="solution-actions">
                <button class="btn btn-primary btn-small" onclick="showDetailModal(${index})">üëÅÔ∏è Detay</button>
                <button class="btn btn-primary btn-small" onclick="applySolution(${index})">‚úÖ Uygula</button>
              </div>
            </div>`;
        });
        container.innerHTML = html;
        console.log(`‚úÖ ${solutions.length} √ß√∂z√ºm listelendi`);
      }

      function showDetailModal(index) {
        const sol = solutions[index];
        document.getElementById("detailModalId").textContent = sol.rank;
        const content = `
          <div style="text-align: center; margin: 40px 0;">
            <div style="font-size: 80px; font-weight: 900; background: linear-gradient(90deg, #00f5a0, #00d9ff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">${
              sol.fitness
            }</div>
            <div style="font-size: 22px; color: #888; margin-top: 12px;">Fitness Skoru</div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 40px 0;">
            <div style="background: rgba(0, 245, 160, 0.1); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #00f5a0;">
              <div style="font-size: 14px; color: #888;">‚úÖ √áakƒ±≈üma</div>
              <div style="font-size: 36px; color: #00f5a0; font-weight: 700;">${
                sol.conflicts
              }</div>
            </div>
            <div style="background: rgba(255, 187, 51, 0.1); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ffbb33;">
              <div style="font-size: 14px; color: #888;">‚è∞ Bo≈ü Pencere</div>
              <div style="font-size: 36px; color: #ffbb33; font-weight: 700;">${
                sol.gaps
              }</div>
            </div>
            <div style="background: rgba(0, 217, 255, 0.1); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #00d9ff;">
              <div style="font-size: 14px; color: #888;">‚öñÔ∏è Denge Skoru</div>
              <div style="font-size: 36px; color: #00d9ff; font-weight: 700;">${(
                sol.balance * 100
              ).toFixed(0)}%</div>
            </div>
            <div style="background: rgba(123, 47, 255, 0.1); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #7b2fff;">
              <div style="font-size: 14px; color: #888;">üß© Blok Uyumu</div>
              <div style="font-size: 36px; color: #7b2fff; font-weight: 700;">${(
                sol.blocks * 100
              ).toFixed(0)}%</div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 40px;">
            <button class="btn btn-primary" style="padding: 16px 50px; font-size: 18px;" onclick="applySolution(${index}); closeDetailModal();">‚úÖ Bu √á√∂z√ºm√º Uygula ve Programƒ± G√∂r</button>
          </div>`;
        document.getElementById("detailModalContent").innerHTML = content;
        document.getElementById("detailModal").classList.add("active");
      }

      function showCompareModal() {
        let html = `
          <h3 style="text-align: center; margin-bottom: 30px; color: #00d9ff;">üîç T√ºm √á√∂z√ºmler Kar≈üƒ±la≈ütƒ±rmasƒ± (${solutions.length} √á√∂z√ºm)</h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; border: 2px solid #00d9ff;">
              <thead>
                <tr style="background: linear-gradient(135deg, #00d9ff, #7b2fff); color: white;">
                  <th style="padding: 15px; border: 1px solid #00d9ff;">Sƒ±ra</th>
                  <th style="padding: 15px; border: 1px solid #00d9ff;">Fitness</th>
                  <th style="padding: 15px; border: 1px solid #00d9ff;">√áakƒ±≈üma</th>
                  <th style="padding: 15px; border: 1px solid #00d9ff;">Bo≈üluk</th>
                  <th style="padding: 15px; border: 1px solid #00d9ff;">Denge %</th>
                  <th style="padding: 15px; border: 1px solid #00d9ff;">Blok %</th>
                  <th style="padding: 15px; border: 1px solid #00d9ff;">ƒ∞≈ülem</th>
                </tr>
              </thead>
              <tbody>`;
        solutions.forEach((sol, i) => {
          const rowColor = i === 0 ? "rgba(0, 245, 160, 0.2)" : "";
          html += `
            <tr style="background: ${rowColor}">
              <td style="padding: 12px; text-align: center; border: 1px solid #00d9ff;">${
                i === 0 ? "üëë " : ""
              }${sol.rank}</td>
              <td style="padding: 12px; text-align: center; font-weight: bold; color: ${
                i === 0 ? "#00f5a0" : "#e0e0e0"
              }; border: 1px solid #00d9ff;">${sol.fitness}</td>
              <td style="padding: 12px; text-align: center; color: ${
                sol.conflicts === 0 ? "#00f5a0" : "#ff6b6b"
              }; border: 1px solid #00d9ff;">${sol.conflicts}</td>
              <td style="padding: 12px; text-align: center; color: ${
                sol.gaps === 0 ? "#00f5a0" : "#ffbb33"
              }; border: 1px solid #00d9ff;">${sol.gaps}</td>
              <td style="padding: 12px; text-align: center; color: #00d9ff; border: 1px solid #00d9ff;">${(
                sol.balance * 100
              ).toFixed(0)}%</td>
              <td style="padding: 12px; text-align: center; color: #7b2fff; border: 1px solid #00d9ff;">${(
                sol.blocks * 100
              ).toFixed(0)}%</td>
              <td style="padding: 12px; text-align: center; border: 1px solid #00d9ff;">
                <button class="btn btn-primary btn-small" onclick="applySolution(${i}); closeCompareModal();">Uygula</button>
              </td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById("compareModalContent").innerHTML = html;
        document.getElementById("compareModal").classList.add("active");
      }

      function applySolution(index) {
        console.log(`‚úÖ √á√∂z√ºm #${index + 1} uygulanƒ±yor...`);
        const selectedSolution = solutions[index];
        currentSolution = selectedSolution.schedule;
        closeDetailModal();
        closeCompareModal();
        showProgramModal();
        showSuccess(`√á√∂z√ºm #${index + 1} se√ßildi ve program g√∂r√ºnt√ºleniyor`);
      }

      // ============================================
      // PROGRAM G√ñR√úNT√úLEME
      // ============================================
      function showProgramModal() {
        console.log("üìÖ Program modalƒ± a√ßƒ±lƒ±yor...");

        if (!currentSolution || !currentProgramData) {
          showError("Program verisi bulunamadƒ±!");
          return;
        }

        // Sidebar'ƒ± render et
        renderProgramSidebar();

        // Modalƒ± a√ß
        document.getElementById("programModal").classList.add("active");
        document.getElementById("btnProgramKaydet").style.display = "block";

        // üî• D√úZELTME: ƒ∞lk sƒ±nƒ±fƒ± otomatik se√ß
        setTimeout(() => {
          // currentSolution'dan ilk key'i al (9_A formatƒ±nda)
          const firstScheduleKey = Object.keys(currentSolution)[0];

          if (firstScheduleKey) {
            // Class name'i bul (9_A ‚Üí 9-A)
            const firstClassName = firstScheduleKey.replace(/_/g, "-");

            console.log(
              `üéØ ƒ∞lk sƒ±nƒ±f otomatik se√ßiliyor: ${firstClassName} (key: ${firstScheduleKey})`
            );

            // Programƒ± g√∂ster
            showClassSchedule(firstScheduleKey, firstClassName);

            // Sidebar'da aktif yap
            const firstItem = document.querySelector(
              `#sinifList .sidebar-item`
            );
            if (firstItem) {
              firstItem.classList.add("active");
            }
          } else {
            console.warn("‚ö†Ô∏è currentSolution bo≈ü!");
          }
        }, 100);
      }

      function renderProgramSidebar() {
        const sinifList = document.getElementById("sinifList");
        const classes = currentProgramData.classes || [];

        if (classes.length === 0) {
          sinifList.innerHTML =
            '<div style="text-align: center; color: #888; padding: 20px; font-size: 12px;">Sƒ±nƒ±f bulunamadƒ±</div>';
        } else {
          let html = "";
          classes.forEach((cls) => {
            // üî• D√úZELTME: cls.name'i schedule key formatƒ±na √ßevir (9-A ‚Üí 9_A)
            const scheduleKey = cls.name.replace(/-/g, "_");

            // Schedule'da bu key var mƒ± kontrol et
            const hasSchedule = currentSolution && currentSolution[scheduleKey];

            if (hasSchedule) {
              html += `<div class="sidebar-item" onclick="showClassSchedule('${scheduleKey}', '${cls.name}')">${cls.name}</div>`;
            } else {
              console.warn(
                `‚ö†Ô∏è ${cls.name} i√ßin schedule bulunamadƒ± (key: ${scheduleKey})`
              );
            }
          });

          if (html === "") {
            sinifList.innerHTML =
              '<div style="text-align: center; color: #888; padding: 20px; font-size: 12px;">Programƒ± olan sƒ±nƒ±f bulunamadƒ±</div>';
          } else {
            sinifList.innerHTML = html;
          }
        }

        const ogretmenList = document.getElementById("ogretmenList");
        const teachers = currentProgramData.teachers || [];

        if (teachers.length === 0) {
          ogretmenList.innerHTML =
            '<div style="text-align: center; color: #888; padding: 20px; font-size: 12px;">√ñƒüretmen bulunamadƒ±</div>';
        } else {
          let html = "";
          teachers.forEach((teacher) => {
            html += `<div class="sidebar-item" onclick="showTeacherSchedule(${
              teacher.id
            }, '${teacher.name}')">${
              teacher.name
            }<div style="font-size: 10px; color: #888; margin-top: 4px;">${
              teacher.brans || "Bran≈ü"
            }</div></div>`;
          });
          ogretmenList.innerHTML = html;
        }
      }

      function showClassSchedule(classId, className) {
        console.log(
          "üè´ Sƒ±nƒ±f programƒ± g√∂steriliyor:",
          className,
          "Key:",
          classId
        );

        // Sidebar aktif/pasif
        document
          .querySelectorAll("#sinifList .sidebar-item")
          .forEach((item) => item.classList.remove("active"));

        // üî• D√úZELTME: event kontrol√º
        if (typeof event !== "undefined" && event.target) {
          event.target.classList.add("active");
        }

        document
          .querySelectorAll("#ogretmenList .sidebar-item")
          .forEach((item) => item.classList.remove("active"));

        // Ba≈ülƒ±k
        document.getElementById(
          "programTitle"
        ).textContent = `${className} - Haftalƒ±k Ders Programƒ±`;

        // üî• D√úZELTME: classId direkt kullan (9_A formatƒ±nda gelecek)
        console.log(
          `üìä renderScheduleTable('${classId}', 'class') √ßaƒürƒ±lƒ±yor...`
        );
        renderScheduleTable(classId, "class");
      }

      function showTeacherSchedule(teacherId, teacherName) {
        console.log(
          "üë®‚Äçüè´ √ñƒüretmen programƒ± g√∂steriliyor:",
          teacherName,
          "ID:",
          teacherId
        );

        // Sidebar aktif/pasif
        document
          .querySelectorAll("#ogretmenList .sidebar-item")
          .forEach((item) => item.classList.remove("active"));

        // üî• D√úZELTME: event kontrol√º
        if (typeof event !== "undefined" && event.target) {
          event.target.classList.add("active");
        }

        document
          .querySelectorAll("#sinifList .sidebar-item")
          .forEach((item) => item.classList.remove("active"));

        // Ba≈ülƒ±k
        document.getElementById(
          "programTitle"
        ).textContent = `${teacherName} - Haftalƒ±k Ders Programƒ±`;

        // Tablo render
        renderScheduleTable(teacherId, "teacher");
      }

      function renderScheduleTable(id, type) {
        console.log(`üìä renderScheduleTable() - ID: ${id}, Type: ${type}`);

        const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];
        const hours = 8;
        let html = `
    <thead>
      <tr>
        <th class="hour-header" style="width: 80px;">Saat</th>
        ${days.map((day) => `<th>${day}</th>`).join("")}
      </tr>
    </thead>
    <tbody>`;

        let totalRendered = 0;

        for (let hour = 1; hour <= hours; hour++) {
          html += `<tr><td class="hour-header">${hour}. Saat</td>`;
          for (let day = 1; day <= 5; day++) {
            const lesson = getLessonFromSchedule(id, type, day, hour);
            const cellKey = `${id}_${day}_${hour}`;
            const isLocked = lockedLessons.has(cellKey);

            if (lesson) {
              totalRendered++;
              const bgColor = getRandomLightColor();
              html += `
          <td class="lesson-cell ${
            isLocked ? "locked" : ""
          }" style="background: ${bgColor};" data-cell="${cellKey}">
            <button class="lock-btn ${
              isLocked ? "locked" : ""
            }" onclick="toggleLock('${id}', ${day}, ${hour}); event.stopPropagation();">${
                isLocked ? "üîí" : "üîì"
              }</button>
            <div class="lesson-name">${lesson.subjectName || "Ders"}</div>
            <div class="lesson-teacher">${
              type === "class"
                ? lesson.teacherName || "√ñƒüretmen"
                : lesson.className || "Sƒ±nƒ±f"
            }</div>
            ${
              lesson.blockIndex !== undefined
                ? `<div class="lesson-block">üì¶ Blok ${lesson.blockIndex + 1}/${
                    lesson.blockTotal
                  }</div>`
                : ""
            }
          </td>`;
            } else {
              html += `<td class="empty-cell" data-cell="${cellKey}">---</td>`;
            }
          }
          html += `</tr>`;
        }
        html += `</tbody>`;

        document.getElementById("programTable").innerHTML = html;
        console.log(`‚úÖ Tablo render edildi: ${totalRendered} ders g√∂sterildi`);
      }

      function getLessonFromSchedule(id, type, day, hour) {
        if (!currentSolution) return null;

        try {
          if (type === "class") {
            // üî• D√úZELTME: id direkt schedule key (9_A formatƒ±nda)
            const classSchedule = currentSolution[id];

            if (!classSchedule) {
              console.warn(`‚ö†Ô∏è Sƒ±nƒ±f schedule bulunamadƒ±: ${id}`);
              return null;
            }

            if (
              classSchedule &&
              classSchedule[day] &&
              classSchedule[day][hour]
            ) {
              const lesson = classSchedule[day][hour];

              let teacherName = "√ñƒüretmen";
              if (currentProgramData && currentProgramData.teachers) {
                if (Array.isArray(lesson.teacherId)) {
                  const teacherNames = lesson.teacherId
                    .map((tId) => {
                      const teacher = currentProgramData.teachers.find(
                        (t) => t.id == tId
                      );
                      return teacher ? teacher.name : `√ñƒüretmen ${tId}`;
                    })
                    .filter((name) => name);
                  teacherName =
                    teacherNames.length > 0
                      ? teacherNames.join(", ")
                      : "√ñƒüretmen";
                } else {
                  const teacher = currentProgramData.teachers.find(
                    (t) => t.id == lesson.teacherId
                  );
                  if (teacher) teacherName = teacher.name;
                }
              }

              return { ...lesson, teacherName: teacherName };
            }
          } else {
            // √ñƒüretmen programƒ±
            for (const classId in currentSolution) {
              const classSchedule = currentSolution[classId];
              if (
                classSchedule &&
                classSchedule[day] &&
                classSchedule[day][hour]
              ) {
                const lesson = classSchedule[day][hour];

                let isThisTeacher = false;
                if (Array.isArray(lesson.teacherId)) {
                  isThisTeacher = lesson.teacherId.includes(parseInt(id));
                } else {
                  isThisTeacher = lesson.teacherId == id;
                }

                if (isThisTeacher) {
                  // ‚úÖ SINIF ADINI AL - lesson.className kullan
                  let className =
                    lesson.className || classId.replace(/_/g, "-") || "Sƒ±nƒ±f";

                  return { ...lesson, className: className };
                }
              }
            }
          }
        } catch (error) {
          console.error("‚ùå Ders bilgisi alma hatasƒ±:", error);
        }
        return null;
      }

      function toggleLock(classId, day, hour) {
        const key = `${classId}_${day}_${hour}`;
        if (lockedLessons.has(key)) {
          lockedLessons.delete(key);
          showInfo(`üîì Ders kilidi kaldƒ±rƒ±ldƒ±`);
        } else {
          lockedLessons.add(key);
          showSuccess(`üîí Ders kilitlendi`);
        }
        const cell = document.querySelector(`[data-cell="${key}"]`);
        if (cell) {
          cell.classList.toggle("locked");
          const lockBtn = cell.querySelector(".lock-btn");
          if (lockBtn) {
            lockBtn.classList.toggle("locked");
            lockBtn.textContent = lockedLessons.has(key) ? "üîí" : "üîì";
          }
        }
        console.log(`üîí Locked lessons:`, Array.from(lockedLessons));
      }

      console.log(
        "‚úÖ B√ñL√úM 5 Y√úKLENDƒ∞ - Daƒüƒ±tƒ±m algoritmasƒ±, 45+ mod√ºl aktif, program g√∂r√ºnt√ºleme!"
      );
      // ============================================
      // KAYDEDƒ∞LMƒ∞≈û PROGRAMLARI Y√úKLE
      // ============================================
      async function loadSavedPrograms() {
        try {
          const programId = localStorage.getItem("currentProgramId");
          if (!programId) {
            console.log("‚ö†Ô∏è Program ID bulunamadƒ±");
            return;
          }

          const saved = localStorage.getItem(`savedPrograms_${programId}`);
          savedPrograms = saved ? JSON.parse(saved) : [];

          if (
            typeof window.electronAPI !== "undefined" &&
            window.electronAPI.getAllProgramSolutions
          ) {
            try {
              const result = await window.electronAPI.getAllProgramSolutions(
                parseInt(programId)
              );
              if (result.success && result.solutions) {
                savedPrograms = result.solutions;
                localStorage.setItem(
                  `savedPrograms_${programId}`,
                  JSON.stringify(savedPrograms)
                );
              }
            } catch (apiError) {
              console.warn(
                "‚ö†Ô∏è Backend'den y√ºklenemedi, localStorage kullanƒ±lƒ±yor:",
                apiError.message
              );
            }
          }

          renderSavedPrograms();
          console.log(
            `‚úÖ ${savedPrograms.length} kaydedilmi≈ü program y√ºklendi`
          );
        } catch (error) {
          console.error("‚ùå Kaydedilmi≈ü programlarƒ± y√ºkleme hatasƒ±:", error);
          savedPrograms = [];
          renderSavedPrograms();
        }
      }

      function renderSavedPrograms() {
        const container = document.getElementById("savedProgramsList");
        if (savedPrograms.length === 0) {
          container.innerHTML =
            '<div class="empty-state" style="padding: 20px;"><div class="empty-icon" style="font-size: 48px;">üìÇ</div><div class="empty-title" style="font-size: 14px;">Kayƒ±tlƒ± Program Yok</div><div class="empty-text" style="font-size: 11px;">Daƒüƒ±tƒ±m sonrasƒ± "Yeni Kaydet" ile kaydedin</div></div>';
          return;
        }

        let html = "";
        savedPrograms.forEach((prog, index) => {
          const isActive = prog.aktif || prog.id === activeProgram;
          const date = prog.olusturma_tarihi
            ? new Date(prog.olusturma_tarihi).toLocaleDateString("tr-TR")
            : new Date().toLocaleDateString("tr-TR");
          const metadata = prog.metadata || {};

          html += `
            <div class="saved-program-card ${
              isActive ? "active" : ""
            }" onclick="loadProgram(${index})">
              <div class="saved-program-header">
                <div class="saved-program-name">
                  ${isActive ? '<span class="active-badge">‚úÖ</span>' : ""}
                  ${prog.cozum_adi || prog.name || "Program " + (index + 1)}
                </div>
                <div class="saved-program-date">${date}</div>
              </div>
              <div class="saved-program-stats">
                <div class="saved-program-stat">Fitness<span>${
                  metadata.fitness || "-"
                }</span></div>
                <div class="saved-program-stat">√áakƒ±≈üma<span style="color: ${
                  (metadata.conflicts || 0) === 0 ? "#00f5a0" : "#ff6b6b"
                }">${metadata.conflicts || 0}</span></div>
                <div class="saved-program-stat">Bo≈üluk<span>${
                  metadata.gaps || 0
                }</span></div>
                <div class="saved-program-stat">Denge<span>${
                  metadata.dolulukOrani || "-"
                }%</span></div>
              </div>
              <div class="saved-program-actions" onclick="event.stopPropagation();">
                <button class="btn btn-primary btn-small" onclick="loadProgram(${index})">üìÇ Y√ºkle</button>
                <button class="btn btn-secondary btn-small" onclick="deleteProgram(${index})">üóëÔ∏è Sil</button>
              </div>
            </div>`;
        });
        container.innerHTML = html;
      }

      async function loadProgram(index) {
        try {
          const prog = savedPrograms[index];
          if (!prog) return;

          currentSolution = prog.cozum_data || prog.solution;
          activeProgram = prog.id;

          showSuccess(
            `üìÇ "${prog.cozum_adi || "Program " + (index + 1)}" y√ºklendi!`
          );
          renderSavedPrograms();
        } catch (error) {
          console.error("‚ùå Program y√ºkleme hatasƒ±:", error);
          showError("Program y√ºklenemedi!");
        }
      }

      async function deleteProgram(index) {
        if (!confirm("‚ö†Ô∏è Bu programƒ± silmek istediƒüinizden emin misiniz?")) {
          return;
        }

        try {
          const prog = savedPrograms[index];

          if (typeof window.electronAPI !== "undefined" && prog.id) {
            const result = await window.electronAPI.deleteProgramSolution(
              prog.id
            );
            if (!result.success) {
              throw new Error(result.message);
            }
          }

          savedPrograms.splice(index, 1);

          const programId = localStorage.getItem("currentProgramId");
          localStorage.setItem(
            `savedPrograms_${programId}`,
            JSON.stringify(savedPrograms)
          );

          renderSavedPrograms();
          showSuccess("üóëÔ∏è Program silindi!");
        } catch (error) {
          console.error("‚ùå Program silme hatasƒ±:", error);
          showError("Program silinemedi!");
        }
      }

      async function kaydetProgrami() {
        try {
          const programAdi = document
            .getElementById("programAdiInput")
            .value.trim();
          if (!programAdi) {
            showWarning("Program adƒ± bo≈ü olamaz!");
            return;
          }

          if (!currentSolution) {
            showError("Kaydedilecek program bulunamadƒ±!");
            return;
          }

          const programId = localStorage.getItem("currentProgramId");
          const bestSolution = solutions[0] || {};

          const metadata = {
            fitness: bestSolution.fitness || 0,
            conflicts: bestSolution.conflicts || 0,
            gaps: bestSolution.gaps || 0,
            balance: bestSolution.balance || 0,
            dolulukOrani: Math.round((bestSolution.balance || 0) * 100),
            yerlesenDers: Object.keys(currentSolution).length,
            timestamp: new Date().toISOString(),
          };

          if (typeof window.electronAPI !== "undefined") {
            const result = await window.electronAPI.saveProgramSolution(
              parseInt(programId),
              programAdi,
              currentSolution,
              metadata
            );

            if (result.success) {
              showSuccess("üíæ Program ba≈üarƒ±yla kaydedildi!");
              closeSaveModal();
              await loadSavedPrograms();
            } else {
              throw new Error(result.message);
            }
          } else {
            const newProgram = {
              id: Date.now(),
              name: programAdi,
              cozum_adi: programAdi,
              solution: currentSolution,
              cozum_data: currentSolution,
              metadata: metadata,
              olusturma_tarihi: new Date().toISOString(),
              aktif: false,
            };

            savedPrograms.push(newProgram);
            localStorage.setItem(
              `savedPrograms_${programId}`,
              JSON.stringify(savedPrograms)
            );

            showSuccess("üíæ Program ba≈üarƒ±yla kaydedildi!");
            closeSaveModal();
            renderSavedPrograms();
          }
        } catch (error) {
          console.error("‚ùå Program kaydetme hatasƒ±:", error);
          showError("Program kaydedilemedi: " + error.message);
        }
      }

      async function saveProgramToDatabase() {
        await kaydetProgrami();
      }

      // ============================================
      // DEƒûƒ∞≈ûƒ∞KLƒ∞K TESPƒ∞Tƒ∞ VE MODAL
      // ============================================
      function detectChanges(oldSolution, newSolution) {
        const changes = [];
        const affectedTeachers = new Set();

        for (const classId in newSolution) {
          for (const day in newSolution[classId]) {
            for (const hour in newSolution[classId][day]) {
              const newLesson = newSolution[classId][day][hour];
              const oldLesson = oldSolution?.[classId]?.[day]?.[hour];
              if (JSON.stringify(newLesson) !== JSON.stringify(oldLesson)) {
                const teacherId = Array.isArray(newLesson?.teacherId)
                  ? newLesson.teacherId[0]
                  : newLesson?.teacherId;
                if (teacherId) affectedTeachers.add(teacherId);
              }
            }
          }
        }

        affectedTeachers.forEach((teacherId) => {
          const teacher = currentProgramData.teachers.find(
            (t) => t.id == teacherId
          );
          if (teacher) {
            const beforeSchedule = getTeacherScheduleSummary(
              teacherId,
              oldSolution
            );
            const afterSchedule = getTeacherScheduleSummary(
              teacherId,
              newSolution
            );
            changes.push({
              teacherId,
              teacherName: teacher.name,
              before: beforeSchedule,
              after: afterSchedule,
            });
          }
        });

        return changes;
      }

      function getTeacherScheduleSummary(teacherId, solution) {
        const summary = [];
        const days = ["Pzt", "Salƒ±", "√ár≈ü", "Pr≈ü", "Cuma"];
        for (const classId in solution) {
          for (let day = 1; day <= 5; day++) {
            for (let hour = 1; hour <= 8; hour++) {
              const lesson = solution[classId][day][hour];
              if (
                lesson &&
                (lesson.teacherId == teacherId ||
                  (Array.isArray(lesson.teacherId) &&
                    lesson.teacherId.includes(teacherId)))
              ) {
                const cls = currentProgramData.classes.find(
                  (c) => c.id == classId
                );
                summary.push(
                  `${days[day - 1]} ${hour}.saat - ${cls?.name || "Sƒ±nƒ±f"}`
                );
              }
            }
          }
        }
        return summary;
      }

      function showChangesModal(changes) {
        let html = `
          <h3 style="text-align: center; color: #00d9ff; margin-bottom: 20px;">üìä ${changes.length} √ñƒüretmenin Programƒ± Deƒüi≈üti</h3>
          <div class="changes-list">`;

        changes.forEach((change) => {
          html += `
            <div class="change-item">
              <div class="change-teacher">üë®‚Äçüè´ ${change.teacherName}</div>
              <div class="change-details">
                <div class="change-before">
                  <strong>√ñnceki Program:</strong><br>
                  ${change.before.join("<br>")}
                </div>
                <div class="change-arrow">‚Üí</div>
                <div class="change-after">
                  <strong>Yeni Program:</strong><br>
                  ${change.after.join("<br>")}
                </div>
              </div>
            </div>`;
        });

        html += `
          </div>
          <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-primary btn-large" onclick="acceptChanges(); closeChangesModal();">‚úÖ Yeni Programƒ± Kabul Et ve Kaydet</button>
            <button class="btn btn-secondary btn-large" onclick="rejectChanges(); closeChangesModal();" style="margin-left: 10px;">‚ùå ƒ∞ptal Et ve Eski Programa D√∂n</button>
          </div>`;

        document.getElementById("changesModalContent").innerHTML = html;
        document.getElementById("changesModal").classList.add("active");
      }

      function acceptChanges() {
        showSuccess("‚úÖ Yeni program kabul edildi!");
      }

      function rejectChanges() {
        currentSolution = previousSolution;
        showWarning("‚èÆÔ∏è Eski programa geri d√∂n√ºld√º");
      }

      // ============================================
      // BA≈ûARI MODALI
      // ============================================
      function showSuccessModal() {
        const overlay = document.createElement("div");
        overlay.className = "success-modal-overlay";
        overlay.innerHTML = `
          <div class="success-modal">
            <div class="success-icon">üéâ</div>
            <div class="success-title">Daƒüƒ±tƒ±m Tamamlandƒ±!</div>
            <div class="success-text">
              AI motoru ${solutions.length} farklƒ± √ß√∂z√ºm √ºretti.<br>
              En iyi √ß√∂z√ºm fitness skoru: <strong style="color: #00f5a0;">${
                solutions[0]?.fitness || 0
              }</strong>
            </div>
            <div class="success-stats">
              <div class="success-stat">
                <div class="success-stat-label">√áakƒ±≈üma</div>
                <div class="success-stat-value" style="color: #00f5a0;">${
                  solutions[0]?.conflicts || 0
                }</div>
              </div>
              <div class="success-stat">
                <div class="success-stat-label">Bo≈ü Pencere</div>
                <div class="success-stat-value" style="color: #ffbb33;">${
                  solutions[0]?.gaps || 0
                }</div>
              </div>
              <div class="success-stat">
                <div class="success-stat-label">Denge</div>
                <div class="success-stat-value" style="color: #00d9ff;">${(
                  (solutions[0]?.balance || 0) * 100
                ).toFixed(0)}%</div>
              </div>
            </div>
            <button class="btn btn-primary btn-large" onclick="this.parentElement.parentElement.remove()">‚úÖ Tamam</button>
          </div>`;

        document.body.appendChild(overlay);
        setTimeout(() => overlay.remove(), 8000);
      }

      // ============================================
      // AYAR Y√ñNETƒ∞Mƒ∞
      // ============================================
      function saveSettings() {
        try {
          const settings = collectSettings();
          localStorage.setItem(
            "otomatikDagitimAyarlari",
            JSON.stringify(settings)
          );
          localStorage.setItem(
            "lockedLessons",
            JSON.stringify(Array.from(lockedLessons))
          );
          showSuccess("üíæ Ayarlar ba≈üarƒ±yla kaydedildi!");
        } catch (error) {
          console.error("‚ùå Kaydetme hatasƒ±:", error);
          showError("Ayarlar kaydedilirken hata olu≈ütu!");
        }
      }

      function loadSettings() {
        try {
          const saved = localStorage.getItem("otomatikDagitimAyarlari");
          if (!saved) {
            showInfo("Kaydedilmi≈ü ayar bulunamadƒ±");
            return;
          }
          const settings = JSON.parse(saved);
          applySettings(settings);

          const savedLocks = localStorage.getItem("lockedLessons");
          if (savedLocks) {
            lockedLessons = new Set(JSON.parse(savedLocks));
          }

          showSuccess("üìÇ Ayarlar ba≈üarƒ±yla y√ºklendi!");
        } catch (error) {
          console.error("‚ùå Y√ºkleme hatasƒ±:", error);
          showError("Ayarlar y√ºklenirken hata olu≈ütu!");
        }
      }

      function applySettings(settings) {
        const toggles = {
          "toggle-kisit": "useConstraints",
          "toggle-tercih": "usePreferences",
          "toggle-blok": "separateBlocks",
          "toggle-bospencere": "minimizeGaps",
          "toggle-denge": "balanceLoad",
          "toggle-lock": "preserveLocked",
          "toggle-fairness": "useFairness",
          "toggle-variants": "generateVariants",
        };

        for (const [toggleId, settingKey] of Object.entries(toggles)) {
          const toggle = document.getElementById(toggleId);
          if (toggle && settings[settingKey] !== undefined) {
            if (settings[settingKey]) {
              toggle.classList.add("active");
            } else {
              toggle.classList.remove("active");
            }
          }
        }

        if (settings.algorithms) {
          const algos = {
            "algo-ga": "genetic",
            "algo-aco": "aco",
            "algo-sa": "sa",
            "algo-tabu": "tabu",
            "algo-rl": "rl",
            "algo-fuzzy": "fuzzy",
          };
          for (const [algoId, algoKey] of Object.entries(algos)) {
            const checkbox = document.getElementById(algoId);
            if (checkbox && settings.algorithms[algoKey] !== undefined) {
              checkbox.checked = settings.algorithms[algoKey];
            }
          }
        }
      }

      // ============================================
      // EXCEL/PDF EXPORT
      // ============================================
      async function exportToExcel() {
        if (!currentSolution || !currentProgramData) {
          showWarning("√ñnce bir daƒüƒ±tƒ±m yapmalƒ±sƒ±nƒ±z!");
          return;
        }

        try {
          showInfo("üìÑ Excel dosyasƒ± olu≈üturuluyor...");

          const wb = XLSX.utils.book_new();
          const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];

          currentProgramData.classes.forEach((cls) => {
            const wsData = [["Saat", ...days]];

            for (let hour = 1; hour <= 8; hour++) {
              const row = [`${hour}. Saat`];

              for (let day = 1; day <= 5; day++) {
                const lesson = getLessonFromSchedule(
                  cls.id,
                  "class",
                  day,
                  hour
                );
                row.push(
                  lesson ? `${lesson.subjectName}\n${lesson.teacherName}` : "-"
                );
              }

              wsData.push(row);
            }

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, cls.name);
          });

          XLSX.writeFile(
            wb,
            `Ders_Programi_${new Date().toLocaleDateString("tr-TR")}.xlsx`
          );
          showSuccess("‚úÖ Excel dosyasƒ± indirildi!");
        } catch (error) {
          console.error("‚ùå Excel export hatasƒ±:", error);
          showError("Excel dosyasƒ± olu≈üturulamadƒ±!");
        }
      }

      async function exportToPDF() {
        if (!currentSolution || !currentProgramData) {
          showWarning("√ñnce bir daƒüƒ±tƒ±m yapmalƒ±sƒ±nƒ±z!");
          return;
        }

        try {
          showInfo("üìï PDF dosyasƒ± olu≈üturuluyor...");

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("landscape");
          const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];

          currentProgramData.classes.forEach((cls, index) => {
            if (index > 0) doc.addPage();

            doc.setFontSize(16);
            doc.text(`${cls.name} - Haftalƒ±k Ders Programƒ±`, 148, 15, {
              align: "center",
            });

            const tableData = [];
            for (let hour = 1; hour <= 8; hour++) {
              const row = [`${hour}. Saat`];

              for (let day = 1; day <= 5; day++) {
                const lesson = getLessonFromSchedule(
                  cls.id,
                  "class",
                  day,
                  hour
                );
                row.push(
                  lesson ? `${lesson.subjectName}\n${lesson.teacherName}` : "-"
                );
              }

              tableData.push(row);
            }

            doc.autoTable({
              head: [["Saat", ...days]],
              body: tableData,
              startY: 25,
              theme: "grid",
              styles: { fontSize: 9, cellPadding: 3 },
              headStyles: { fillColor: [0, 217, 255] },
            });
          });

          doc.save(
            `Ders_Programi_${new Date().toLocaleDateString("tr-TR")}.pdf`
          );
          showSuccess("‚úÖ PDF dosyasƒ± indirildi!");
        } catch (error) {
          console.error("‚ùå PDF export hatasƒ±:", error);
          showError("PDF dosyasƒ± olu≈üturulamadƒ±!");
        }
      }

      // ============================================
      // EXCEL EXPORT BUTONLARI
      // ============================================
      document
        .getElementById("btnExportConstraintsExcel")
        ?.addEventListener("click", () => {
          if (Object.keys(teacherConstraints).length === 0) {
            showWarning("Hi√ß kƒ±sƒ±t eklenmemi≈ü!");
            return;
          }

          try {
            const wb = XLSX.utils.book_new();
            const wsData = [
              ["√ñƒüretmen", "Bran≈ü", "Kƒ±sƒ±t T√ºr√º", "G√ºn", "Saat", "A√ßƒ±klama"],
            ];

            const days = [
              "",
              "Pazartesi",
              "Salƒ±",
              "√áar≈üamba",
              "Per≈üembe",
              "Cuma",
            ];

            for (const teacherId in teacherConstraints) {
              const teacher = currentProgramData.teachers.find(
                (t) => t.id == teacherId
              );
              const constraints = teacherConstraints[teacherId];

              constraints.forEach((constraint) => {
                wsData.push([
                  teacher?.name || `√ñƒüretmen ${teacherId}`,
                  teacher?.brans || "-",
                  constraint.type,
                  days[constraint.day] || "T√ºm G√ºnler",
                  constraint.hour || "T√ºm Saatler",
                  constraint.description,
                ]);
              });
            }

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Kƒ±sƒ±tlar");
            XLSX.writeFile(
              wb,
              `Ogretmen_Kisitlari_${new Date().toLocaleDateString(
                "tr-TR"
              )}.xlsx`
            );
            showSuccess("‚úÖ Kƒ±sƒ±tlar Excel'e aktarƒ±ldƒ±!");
          } catch (error) {
            console.error("‚ùå Excel export hatasƒ±:", error);
            showError("Excel dosyasƒ± olu≈üturulamadƒ±!");
          }
        });

      document
        .getElementById("btnExportPreferencesExcel")
        ?.addEventListener("click", () => {
          if (Object.keys(teacherPreferences).length === 0) {
            showWarning("Hi√ß tercih eklenmemi≈ü!");
            return;
          }

          try {
            const wb = XLSX.utils.book_new();
            const wsData = [
              ["√ñƒüretmen", "Bran≈ü", "Tercih T√ºr√º", "Deƒüer", "Durum"],
            ];

            const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];
            const prefLabels = {
              like: "Seviyor",
              neutral: "N√∂tr",
              dislike: "Sevmiyor",
            };

            for (const teacherId in teacherPreferences) {
              const teacher = currentProgramData.teachers.find(
                (t) => t.id == teacherId
              );
              const prefs = teacherPreferences[teacherId];

              for (const day in prefs.dayPrefs) {
                wsData.push([
                  teacher?.name || `√ñƒüretmen ${teacherId}`,
                  teacher?.brans || "-",
                  "G√ºn Tercihi",
                  days[day - 1],
                  prefLabels[prefs.dayPrefs[day]],
                ]);
              }

              for (const hour in prefs.hourPrefs) {
                wsData.push([
                  teacher?.name || `√ñƒüretmen ${teacherId}`,
                  teacher?.brans || "-",
                  "Saat Tercihi",
                  `${hour}. Saat`,
                  prefLabels[prefs.hourPrefs[hour]],
                ]);
              }
            }

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Tercihler");
            XLSX.writeFile(
              wb,
              `Ogretmen_Tercihleri_${new Date().toLocaleDateString(
                "tr-TR"
              )}.xlsx`
            );
            showSuccess("‚úÖ Tercihler Excel'e aktarƒ±ldƒ±!");
          } catch (error) {
            console.error("‚ùå Excel export hatasƒ±:", error);
            showError("Excel dosyasƒ± olu≈üturulamadƒ±!");
          }
        });

      console.log(
        "‚úÖ B√ñL√úM 6 Y√úKLENDƒ∞ - Kaydedilmi≈ü programlar, deƒüi≈üiklik modali, ba≈üarƒ± modali, ayar y√∂netimi, Excel/PDF export!"
      );
      // ============================================
      // UNDO/REDO Y√ñNETƒ∞Mƒ∞
      // ============================================
      const undoStack = [];
      const redoStack = [];
      const MAX_UNDO_STACK = 50;

      function saveToUndoStack(solution) {
        if (!solution) return;

        undoStack.push(JSON.parse(JSON.stringify(solution)));

        if (undoStack.length > MAX_UNDO_STACK) {
          undoStack.shift();
        }

        redoStack.length = 0;

        updateUndoRedoButtons();
      }

      function undo() {
        if (undoStack.length === 0) {
          showWarning("Geri alƒ±nacak i≈ülem yok!");
          return;
        }

        redoStack.push(JSON.parse(JSON.stringify(currentSolution)));
        currentSolution = undoStack.pop();

        updateUndoRedoButtons();
        showSuccess("‚èÆÔ∏è Geri alƒ±ndƒ±!");

        if (
          document.getElementById("programModal").classList.contains("active")
        ) {
          const activeType = document.querySelector(".sidebar-item.active")
            ?.dataset.type;
          const activeId = document.querySelector(".sidebar-item.active")
            ?.dataset.id;
          if (activeType && activeId) {
            if (activeType === "class") {
              const cls = currentProgramData.classes.find(
                (c) => c.id == activeId
              );
              if (cls) showClassSchedule(activeId, cls.name);
            } else {
              const teacher = currentProgramData.teachers.find(
                (t) => t.id == activeId
              );
              if (teacher) showTeacherSchedule(activeId, teacher.name);
            }
          }
        }
      }

      function redo() {
        if (redoStack.length === 0) {
          showWarning("ƒ∞leri alƒ±nacak i≈ülem yok!");
          return;
        }

        undoStack.push(JSON.parse(JSON.stringify(currentSolution)));
        currentSolution = redoStack.pop();

        updateUndoRedoButtons();
        showSuccess("‚è≠Ô∏è ƒ∞leri alƒ±ndƒ±!");

        if (
          document.getElementById("programModal").classList.contains("active")
        ) {
          const activeType = document.querySelector(".sidebar-item.active")
            ?.dataset.type;
          const activeId = document.querySelector(".sidebar-item.active")
            ?.dataset.id;
          if (activeType && activeId) {
            if (activeType === "class") {
              const cls = currentProgramData.classes.find(
                (c) => c.id == activeId
              );
              if (cls) showClassSchedule(activeId, cls.name);
            } else {
              const teacher = currentProgramData.teachers.find(
                (t) => t.id == activeId
              );
              if (teacher) showTeacherSchedule(activeId, teacher.name);
            }
          }
        }
      }

      function updateUndoRedoButtons() {
        const undoBtn = document.querySelector('[onclick="undo()"]');
        const redoBtn = document.querySelector('[onclick="redo()"]');

        if (undoBtn) {
          undoBtn.disabled = undoStack.length === 0;
          undoBtn.style.opacity = undoStack.length === 0 ? "0.5" : "1";
        }

        if (redoBtn) {
          redoBtn.disabled = redoStack.length === 0;
          redoBtn.style.opacity = redoStack.length === 0 ? "0.5" : "1";
        }
      }

      // ============================================
      // ƒ∞STATƒ∞STƒ∞K VE ANALƒ∞Z Sƒ∞STEMƒ∞
      // ============================================
      function calculateDetailedStatistics() {
        if (!currentSolution || !currentProgramData) {
          return null;
        }

        const stats = {
          totalLessons: 0,
          placedLessons: 0,
          emptySlots: 0,
          conflicts: {
            teacher: 0,
            class: 0,
            constraint: 0,
          },
          teacherStats: {},
          classStats: {},
          dayDistribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
          hourDistribution: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0 },
          blockDistribution: {
            single: 0,
            double: 0,
            triple: 0,
          },
        };

        // Sƒ±nƒ±f istatistikleri
        currentProgramData.classes.forEach((cls) => {
          stats.classStats[cls.id] = {
            name: cls.name,
            totalSlots: 40,
            filledSlots: 0,
            emptySlots: 0,
            teachers: new Set(),
            subjects: new Set(),
          };
        });

        // √ñƒüretmen istatistikleri
        currentProgramData.teachers.forEach((teacher) => {
          if (teacher.brans === "Rehberlik") return;

          stats.teacherStats[teacher.id] = {
            name: teacher.name,
            brans: teacher.brans,
            totalHours: 0,
            classes: new Set(),
            dayLoad: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
            gaps: 0,
          };
        });

        // √á√∂z√ºm√º analiz et
        for (const classId in currentSolution) {
          for (const day in currentSolution[classId]) {
            for (const hour in currentSolution[classId][day]) {
              const lesson = currentSolution[classId][day][hour];

              if (lesson && lesson.subjectId) {
                stats.placedLessons++;
                stats.dayDistribution[day]++;
                stats.hourDistribution[hour]++;

                // Sƒ±nƒ±f istatistikleri
                if (stats.classStats[classId]) {
                  stats.classStats[classId].filledSlots++;
                  stats.classStats[classId].subjects.add(lesson.subjectId);

                  const teacherIds = Array.isArray(lesson.teacherId)
                    ? lesson.teacherId
                    : [lesson.teacherId];
                  teacherIds.forEach((tid) => {
                    if (tid) stats.classStats[classId].teachers.add(tid);
                  });
                }

                // √ñƒüretmen istatistikleri
                const teacherIds = Array.isArray(lesson.teacherId)
                  ? lesson.teacherId
                  : [lesson.teacherId];
                teacherIds.forEach((teacherId) => {
                  if (stats.teacherStats[teacherId]) {
                    stats.teacherStats[teacherId].totalHours++;
                    stats.teacherStats[teacherId].classes.add(classId);
                    stats.teacherStats[teacherId].dayLoad[day]++;
                  }
                });
              } else {
                stats.emptySlots++;
                if (stats.classStats[classId]) {
                  stats.classStats[classId].emptySlots++;
                }
              }
            }
          }
        }

        // Toplam ders sayƒ±sƒ±
        stats.totalLessons = currentProgramData.classes.length * 40;

        return stats;
      }

      function showStatisticsModal() {
        const stats = calculateDetailedStatistics();
        if (!stats) {
          showWarning("ƒ∞statistik hesaplanamadƒ±!");
          return;
        }

        const fillRate = (
          (stats.placedLessons / stats.totalLessons) *
          100
        ).toFixed(1);

        let html = `
          <div class="statistics-container">
            <h2 style="text-align: center; color: #00d9ff; margin-bottom: 30px;">üìä Detaylƒ± ƒ∞statistikler</h2>
            
            <!-- Genel √ñzet -->
            <div class="stats-section">
              <h3>üìà Genel √ñzet</h3>
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-label">Yerle≈ütirilen Ders</div>
                  <div class="stat-value" style="color: #00f5a0;">${
                    stats.placedLessons
                  }</div>
                  <div class="stat-sublabel">${stats.totalLessons} dersten</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Doluluk Oranƒ±</div>
                  <div class="stat-value" style="color: #00d9ff;">${fillRate}%</div>
                  <div class="stat-sublabel">${stats.emptySlots} bo≈ü slot</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">√áakƒ±≈üma</div>
                  <div class="stat-value" style="color: ${
                    stats.conflicts.teacher + stats.conflicts.class === 0
                      ? "#00f5a0"
                      : "#ff6b6b"
                  };">
                    ${stats.conflicts.teacher + stats.conflicts.class}
                  </div>
                  <div class="stat-sublabel">Toplam ihlal</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Aktif √ñƒüretmen</div>
                  <div class="stat-value" style="color: #7b2fff;">${
                    Object.keys(stats.teacherStats).length
                  }</div>
                  <div class="stat-sublabel">${
                    currentProgramData.teachers.length
                  } √∂ƒüretmenden</div>
                </div>
              </div>
            </div>

            <!-- G√ºnl√ºk Daƒüƒ±lƒ±m -->
            <div class="stats-section">
              <h3>üìÖ G√ºnl√ºk Daƒüƒ±lƒ±m</h3>
              <canvas id="dayDistChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- Saatlik Daƒüƒ±lƒ±m -->
            <div class="stats-section">
              <h3>‚è∞ Saatlik Daƒüƒ±lƒ±m</h3>
              <canvas id="hourDistChart" style="max-height: 200px;"></canvas>
            </div>

            <!-- En Y√ºkl√º √ñƒüretmenler -->
            <div class="stats-section">
              <h3>üë®‚Äçüè´ En Y√ºkl√º √ñƒüretmenler (Top 10)</h3>
              <div class="teacher-load-list">`;

        const sortedTeachers = Object.values(stats.teacherStats)
          .sort((a, b) => b.totalHours - a.totalHours)
          .slice(0, 10);

        sortedTeachers.forEach((teacher, index) => {
          html += `
            <div class="teacher-load-item">
              <span class="teacher-rank">#${index + 1}</span>
              <span class="teacher-name">${teacher.name}</span>
              <span class="teacher-brans">${teacher.brans}</span>
              <span class="teacher-hours">${teacher.totalHours} saat</span>
              <span class="teacher-classes">${teacher.classes.size} sƒ±nƒ±f</span>
            </div>`;
        });

        html += `
              </div>
            </div>

            <!-- En Dolu Sƒ±nƒ±flar -->
            <div class="stats-section">
              <h3>üè´ En Dolu Sƒ±nƒ±flar (Top 10)</h3>
              <div class="class-fill-list">`;

        const sortedClasses = Object.values(stats.classStats)
          .sort((a, b) => b.filledSlots - a.filledSlots)
          .slice(0, 10);

        sortedClasses.forEach((cls, index) => {
          const fillPercent = (
            (cls.filledSlots / cls.totalSlots) *
            100
          ).toFixed(0);
          html += `
            <div class="class-fill-item">
              <span class="class-rank">#${index + 1}</span>
              <span class="class-name">${cls.name}</span>
              <div class="class-fill-bar">
                <div class="class-fill-progress" style="width: ${fillPercent}%; background: linear-gradient(90deg, #00f5a0, #00d9ff);"></div>
                <span class="class-fill-text">${cls.filledSlots}/${
            cls.totalSlots
          } (${fillPercent}%)</span>
              </div>
            </div>`;
        });

        html += `
              </div>
            </div>
          </div>

          <style>
            .statistics-container { padding: 20px; max-height: 70vh; overflow-y: auto; }
            .stats-section { margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; }
            .stats-section h3 { color: #00d9ff; margin-bottom: 15px; font-size: 16px; }
            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .stat-card { background: rgba(0,217,255,0.1); padding: 15px; border-radius: 8px; text-align: center; }
            .stat-label { font-size: 12px; color: #888; margin-bottom: 5px; }
            .stat-value { font-size: 32px; font-weight: bold; margin: 5px 0; }
            .stat-sublabel { font-size: 11px; color: #666; }
            .teacher-load-list, .class-fill-list { display: flex; flex-direction: column; gap: 8px; }
            .teacher-load-item, .class-fill-item { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; gap: 10px; }
            .teacher-rank, .class-rank { font-weight: bold; color: #ffbb33; width: 30px; }
            .teacher-name, .class-name { flex: 1; color: #fff; }
            .teacher-brans { color: #888; font-size: 12px; width: 100px; }
            .teacher-hours { color: #00f5a0; font-weight: bold; width: 60px; }
            .teacher-classes { color: #00d9ff; font-size: 12px; width: 60px; }
            .class-fill-bar { position: relative; flex: 1; height: 24px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
            .class-fill-progress { position: absolute; top: 0; left: 0; height: 100%; transition: width 0.3s; }
            .class-fill-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; color: #fff; font-weight: bold; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
          </style>`;

        const modal = document.createElement("div");
        modal.className = "modal active";
        modal.innerHTML = `
          <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
          <div class="modal-content" style="max-width: 900px;">
            ${html}
            <div style="text-align: center; margin-top: 20px;">
              <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Kapat</button>
            </div>
          </div>`;

        document.body.appendChild(modal);

        // Grafikleri √ßiz
        setTimeout(() => {
          drawDayDistributionChart(stats.dayDistribution);
          drawHourDistributionChart(stats.hourDistribution);
        }, 100);
      }

      function drawDayDistributionChart(data) {
        const ctx = document.getElementById("dayDistChart");
        if (!ctx) return;

        const days = ["Pazartesi", "Salƒ±", "√áar≈üamba", "Per≈üembe", "Cuma"];
        const values = [data[1], data[2], data[3], data[4], data[5]];

        new Chart(ctx, {
          type: "bar",
          data: {
            labels: days,
            datasets: [
              {
                label: "Ders Sayƒ±sƒ±",
                data: values,
                backgroundColor: [
                  "rgba(0, 217, 255, 0.7)",
                  "rgba(123, 47, 255, 0.7)",
                  "rgba(0, 245, 160, 0.7)",
                  "rgba(255, 187, 51, 0.7)",
                  "rgba(255, 107, 107, 0.7)",
                ],
                borderColor: [
                  "rgba(0, 217, 255, 1)",
                  "rgba(123, 47, 255, 1)",
                  "rgba(0, 245, 160, 1)",
                  "rgba(255, 187, 51, 1)",
                  "rgba(255, 107, 107, 1)",
                ],
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "rgba(255,255,255,0.1)" },
                ticks: { color: "#fff" },
              },
              x: {
                grid: { display: false },
                ticks: { color: "#fff" },
              },
            },
          },
        });
      }

      function drawHourDistributionChart(data) {
        const ctx = document.getElementById("hourDistChart");
        if (!ctx) return;

        const hours = [
          "1.Saat",
          "2.Saat",
          "3.Saat",
          "4.Saat",
          "5.Saat",
          "6.Saat",
          "7.Saat",
          "8.Saat",
        ];
        const values = [
          data[1],
          data[2],
          data[3],
          data[4],
          data[5],
          data[6],
          data[7],
          data[8],
        ];

        new Chart(ctx, {
          type: "line",
          data: {
            labels: hours,
            datasets: [
              {
                label: "Ders Sayƒ±sƒ±",
                data: values,
                borderColor: "rgba(0, 217, 255, 1)",
                backgroundColor: "rgba(0, 217, 255, 0.2)",
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "rgba(255,255,255,0.1)" },
                ticks: { color: "#fff" },
              },
              x: {
                grid: { color: "rgba(255,255,255,0.1)" },
                ticks: { color: "#fff" },
              },
            },
          },
        });
      }

      // ============================================
      // VALƒ∞DASYON Sƒ∞STEMƒ∞
      // ============================================
      function validateSolution(solution) {
        const errors = [];
        const warnings = [];

        if (!solution) {
          errors.push("√á√∂z√ºm bulunamadƒ±");
          return { valid: false, errors, warnings };
        }

        // √ñƒüretmen √ßakƒ±≈üma kontrol√º
        const teacherSchedule = {};
        for (const classId in solution) {
          for (const day in solution[classId]) {
            for (const hour in solution[classId][day]) {
              const lesson = solution[classId][day][hour];
              if (lesson && lesson.teacherId) {
                const teacherIds = Array.isArray(lesson.teacherId)
                  ? lesson.teacherId
                  : [lesson.teacherId];

                teacherIds.forEach((teacherId) => {
                  const key = `${teacherId}-${day}-${hour}`;
                  if (teacherSchedule[key]) {
                    errors.push(
                      `√ñƒüretmen √ßakƒ±≈ümasƒ±: ${teacherId} - ${day}. g√ºn ${hour}. saat`
                    );
                  }
                  teacherSchedule[key] = true;
                });
              }
            }
          }
        }

        // Kƒ±sƒ±t ihlali kontrol√º
        for (const classId in solution) {
          for (const day in solution[classId]) {
            for (const hour in solution[classId][day]) {
              const lesson = solution[classId][day][hour];
              if (lesson && lesson.teacherId) {
                const teacherIds = Array.isArray(lesson.teacherId)
                  ? lesson.teacherId
                  : [lesson.teacherId];

                teacherIds.forEach((teacherId) => {
                  const constraints = teacherConstraints[teacherId] || [];
                  constraints.forEach((constraint) => {
                    if (constraint.type === "HARD") {
                      const matchDay = !constraint.day || constraint.day == day;
                      const matchHour =
                        !constraint.hour || constraint.hour == hour;
                      if (matchDay && matchHour) {
                        errors.push(
                          `HARD kƒ±sƒ±t ihlali: ${teacherId} - ${constraint.description}`
                        );
                      }
                    }
                  });
                });
              }
            }
          }
        }

        // Ders atama kontrol√º
        currentProgramData.classes.forEach((cls) => {
          const lessons = currentProgramData.lessons.filter(
            (l) => l.classId == cls.id
          );
          lessons.forEach((lesson) => {
            let placed = 0;
            for (const day in solution[cls.id]) {
              for (const hour in solution[cls.id][day]) {
                const l = solution[cls.id][day][hour];
                if (l && l.subjectId == lesson.subjectId) {
                  placed++;
                }
              }
            }

            if (placed < lesson.weeklyHours) {
              warnings.push(
                `${cls.name} - ${lesson.subjectName}: ${placed}/${lesson.weeklyHours} saat yerle≈ütirildi`
              );
            }
          });
        });

        const valid = errors.length === 0;
        return { valid, errors, warnings };
      }

      function showValidationModal() {
        if (!currentSolution) {
          showWarning("√ñnce bir daƒüƒ±tƒ±m yapmalƒ±sƒ±nƒ±z!");
          return;
        }

        const validation = validateSolution(currentSolution);

        let html = `
          <div style="padding: 20px;">
            <h2 style="text-align: center; color: ${
              validation.valid ? "#00f5a0" : "#ff6b6b"
            }; margin-bottom: 20px;">
              ${
                validation.valid
                  ? "‚úÖ Validasyon Ba≈üarƒ±lƒ±"
                  : "‚ùå Validasyon Hatalarƒ± Bulundu"
              }
            </h2>`;

        if (validation.errors.length > 0) {
          html += `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #ff6b6b; margin-bottom: 10px;">üö´ Hatalar (${validation.errors.length})</h3>
              <div style="background: rgba(255,107,107,0.1); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">`;
          validation.errors.forEach((err) => {
            html += `<div style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">${err}</div>`;
          });
          html += `</div></div>`;
        }

        if (validation.warnings.length > 0) {
          html += `
            <div>
              <h3 style="color: #ffbb33; margin-bottom: 10px;">‚ö†Ô∏è Uyarƒ±lar (${validation.warnings.length})</h3>
              <div style="background: rgba(255,187,51,0.1); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">`;
          validation.warnings.forEach((warn) => {
            html += `<div style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">${warn}</div>`;
          });
          html += `</div></div>`;
        }

        if (validation.valid && validation.warnings.length === 0) {
          html += `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>
              <div style="font-size: 18px; color: #00f5a0;">T√ºm kontroller ba≈üarƒ±lƒ±!</div>
              <div style="font-size: 14px; color: #888; margin-top: 10px;">Program hatasƒ±z ≈üekilde olu≈üturuldu.</div>
            </div>`;
        }

        html += `
            <div style="text-align: center; margin-top: 20px;">
              <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Kapat</button>
            </div>
          </div>`;

        const modal = document.createElement("div");
        modal.className = "modal active";
        modal.innerHTML = `
          <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
          <div class="modal-content" style="max-width: 700px;">${html}</div>`;

        document.body.appendChild(modal);
      }

      // ============================================
      // KEYBOARD SHORTCUTS
      // ============================================
      document.addEventListener("keydown", (e) => {
        // Ctrl+Z: Undo
        if (e.ctrlKey && e.key === "z") {
          e.preventDefault();
          undo();
        }

        // Ctrl+Y: Redo
        if (e.ctrlKey && e.key === "y") {
          e.preventDefault();
          redo();
        }

        // Ctrl+S: Ayarlarƒ± kaydet
        if (e.ctrlKey && e.key === "s") {
          e.preventDefault();
          saveSettings();
        }

        // Ctrl+L: Ayarlarƒ± y√ºkle
        if (e.ctrlKey && e.key === "l") {
          e.preventDefault();
          loadSettings();
        }

        // Ctrl+E: Excel export
        if (e.ctrlKey && e.key === "e") {
          e.preventDefault();
          exportToExcel();
        }

        // Ctrl+P: PDF export
        if (e.ctrlKey && e.key === "p") {
          e.preventDefault();
          exportToPDF();
        }
      });

      // ============================================
      // HEADER BUTON EVENT LISTENERS
      // ============================================
      document
        .getElementById("btnIstatistikler")
        ?.addEventListener("click", showStatisticsModal);
      document
        .getElementById("btnValidasyon")
        ?.addEventListener("click", showValidationModal);
      document.getElementById("btnUndo")?.addEventListener("click", undo);
      document.getElementById("btnRedo")?.addEventListener("click", redo);
      document
        .getElementById("btnExportExcel")
        ?.addEventListener("click", exportToExcel);
      document
        .getElementById("btnExportPDF")
        ?.addEventListener("click", exportToPDF);

      // ============================================
      // OTOMATIK KAYDETME
      // ============================================
      let autoSaveInterval;

      function startAutoSave() {
        stopAutoSave();
        autoSaveInterval = setInterval(() => {
          if (currentSolution) {
            localStorage.setItem(
              "autoSave_solution",
              JSON.stringify(currentSolution)
            );
            localStorage.setItem(
              "autoSave_timestamp",
              new Date().toISOString()
            );
            console.log("üíæ Otomatik kaydetme yapƒ±ldƒ±");
          }
        }, 60000); // Her 1 dakikada bir
      }

      function stopAutoSave() {
        if (autoSaveInterval) {
          clearInterval(autoSaveInterval);
          autoSaveInterval = null;
        }
      }

      function loadAutoSave() {
        try {
          const saved = localStorage.getItem("autoSave_solution");
          const timestamp = localStorage.getItem("autoSave_timestamp");

          if (saved && timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / 60000);

            if (diffMinutes < 60) {
              // Son 1 saat i√ßinde
              if (
                confirm(
                  `‚è∞ ${diffMinutes} dakika √∂nce otomatik kaydedilmi≈ü bir program bulundu. Y√ºklemek ister misiniz?`
                )
              ) {
                currentSolution = JSON.parse(saved);
                showSuccess("üìÇ Otomatik kayƒ±t y√ºklendi!");
                return true;
              }
            }
          }
        } catch (error) {
          console.error("‚ùå Otomatik kayƒ±t y√ºkleme hatasƒ±:", error);
        }
        return false;
      }

      // ============================================
      // SAYFA Y√úKLEME VE ƒ∞LK BA≈ûLATMA
      // ============================================
      async function initializePage() {
        try {
          showInfo("üîÑ Sistem ba≈ülatƒ±lƒ±yor...");

          // Veri y√ºkleme
          await loadProgramData();

          // Kaydedilmi≈ü ayarlarƒ± y√ºkle
          const savedSettings = localStorage.getItem("otomatikDagitimAyarlari");
          if (savedSettings) {
            applySettings(JSON.parse(savedSettings));
          }

          // Kƒ±sƒ±t ve tercihleri y√ºkle
          await loadConstraints();
          await loadPreferences();

          // Kaydedilmi≈ü programlarƒ± y√ºkle
          await loadSavedPrograms();

          // Otomatik kayƒ±t kontrol√º
          loadAutoSave();

          // Otomatik kaydetmeyi ba≈ülat
          startAutoSave();

          // Undo/Redo butonlarƒ±nƒ± g√ºncelle
          updateUndoRedoButtons();

          showSuccess("‚úÖ Sistem hazƒ±r!");
          console.log(
            "üöÄ T√úRKƒ∞YE'Nƒ∞N ƒ∞LK YAPAY ZEKA DESTEKLƒ∞ DERS DAƒûITIM Sƒ∞STEMƒ∞ v4.0 BA≈ûLATILDI!"
          );
        } catch (error) {
          console.error("‚ùå Ba≈ülatma hatasƒ±:", error);
          showError("Sistem ba≈ülatƒ±lamadƒ±: " + error.message);
        }
      }

      // ============================================
      // SAYFA KAPANMA KONTROL√ú
      // ============================================
      window.addEventListener("beforeunload", (e) => {
        if (isRunning) {
          e.preventDefault();
          e.returnValue =
            "Daƒüƒ±tƒ±m devam ediyor. √áƒ±kmak istediƒüinizden emin misiniz?";
          return e.returnValue;
        }

        // Son durumu kaydet
        if (currentSolution) {
          localStorage.setItem("lastSolution", JSON.stringify(currentSolution));
        }
      });

      // ============================================
      // PERFORMANS ƒ∞ZLEME
      // ============================================
      function logPerformance() {
        if (window.performance) {
          const perfData = window.performance.timing;
          const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
          console.log(`‚ö° Sayfa y√ºkleme s√ºresi: ${pageLoadTime}ms`);
        }
      }

      window.addEventListener("load", logPerformance);

      // ============================================
      // GENEL AYARLAR - KAYDET BUTONU EVENT
      // ============================================
      function initGeneralSettingsEvents() {
        const saveBtn = document.getElementById("btnSaveGeneralSettings");
        if (saveBtn) {
          saveBtn.removeEventListener("click", saveGeneralSettings); // √áift event √∂nleme
          saveBtn.addEventListener("click", saveGeneralSettings);
          console.log("‚úÖ Genel ayarlar kaydet butonu baƒülandƒ±");
        }
      }

      // Modal a√ßƒ±lƒ±nca event'leri ba≈ülat
      setTimeout(() => {
        initGeneralSettingsEvents();
      }, 1000);

      // ============================================
      // Fƒ∞NAL ƒ∞Nƒ∞Tƒ∞ALƒ∞ZATƒ∞ON
      // ============================================
      document.addEventListener("DOMContentLoaded", () => {
        initializePage();

        // Header butonlarƒ±nƒ± ba≈ülat
        setTimeout(() => {
          initializeHeaderButtons();
        }, 500);
      });

      console.log(
        "‚úÖ B√ñL√úM 7 Y√úKLENDƒ∞ - ƒ∞statistikler, grafikler, undo/redo, validasyon, keyboard shortcuts, otomatik kaydetme!"
      );
      console.log("üéâ T√úM B√ñL√úMLER TAMAMLANDI! Sƒ∞STEM HAZIR!");
      // ==========================================
      // üß™ TEST VE DEBUG Sƒ∞STEMƒ∞
      // ==========================================

      function runCompleteSystemTest() {
        console.log("\n" + "=".repeat(80));
        console.log("üß™ KOMPLE Sƒ∞STEM TESTƒ∞ BA≈ûLIYOR");
        console.log("=".repeat(80));

        const results = {
          classes: { pass: 0, fail: 0, tests: [] },
          functions: { pass: 0, fail: 0, tests: [] },
          data: { pass: 0, fail: 0, tests: [] },
          algorithms: { pass: 0, fail: 0, tests: [] },
        };

        // 1. CLASS KONTROL√ú
        console.log("\nüì¶ 1. CLASS KONTROL√ú:");

        try {
          if (typeof ScheduleAlgorithmV2 !== "undefined") {
            console.log("   ‚úÖ ScheduleAlgorithmV2 class tanƒ±mlƒ±");
            results.classes.pass++;
            results.classes.tests.push({
              name: "ScheduleAlgorithmV2",
              status: "PASS",
            });
          } else {
            console.log("   ‚ùå ScheduleAlgorithmV2 class tanƒ±mlƒ± DEƒûƒ∞L!");
            results.classes.fail++;
            results.classes.tests.push({
              name: "ScheduleAlgorithmV2",
              status: "FAIL",
            });
          }
        } catch (error) {
          console.log(
            "   ‚ùå ScheduleAlgorithmV2 kontrol hatasƒ±:",
            error.message
          );
          results.classes.fail++;
        }

        // 2. FONKSƒ∞YON KONTROL√ú
        console.log("\nüîß 2. FONKSƒ∞YON KONTROL√ú:");

        const requiredFunctions = [
          "collectSettings",
          "createManualSolutions",
          "getSpecialTeachers",
          "getGeneralSettings",
          "getAllTeacherLimits",
          "getTeacherLimits",
          "handleProgress",
          "handleAlgorithmStart",
          "handleAlgorithmComplete",
          "handleSolutionFound",
          "handleConflictUpdate",
          "handleComplete",
          "handleError",
          "startDistribution",
          "loadProgramData",
          "renderSolutions",
        ];

        requiredFunctions.forEach((funcName) => {
          try {
            if (typeof window[funcName] === "function") {
              console.log(`   ‚úÖ ${funcName}()`);
              results.functions.pass++;
              results.functions.tests.push({ name: funcName, status: "PASS" });
            } else {
              console.log(`   ‚ùå ${funcName}() EKSƒ∞K!`);
              results.functions.fail++;
              results.functions.tests.push({ name: funcName, status: "FAIL" });
            }
          } catch (error) {
            console.log(`   ‚ùå ${funcName}() kontrol hatasƒ±`);
            results.functions.fail++;
          }
        });

        // 3. DATA KONTROL√ú
        console.log("\nüìä 3. DATA KONTROL√ú:");

        const dataChecks = [
          { name: "currentProgramData", value: currentProgramData },
          { name: "teachers", value: currentProgramData?.teachers },
          { name: "classes", value: currentProgramData?.classes },
          { name: "lessons", value: currentProgramData?.lessons },
          { name: "teacherConstraints", value: teacherConstraints },
          { name: "teacherPreferences", value: teacherPreferences },
          { name: "manualPlacements", value: manualPlacements },
          { name: "lockedLessons", value: lockedLessons },
        ];

        dataChecks.forEach((check) => {
          const hasData =
            check.value &&
            (Array.isArray(check.value)
              ? check.value.length > 0
              : check.value instanceof Set
              ? check.value.size > 0
              : Object.keys(check.value).length > 0);

          if (hasData) {
            console.log(`   ‚úÖ ${check.name}: Mevcut`);
            results.data.pass++;
            results.data.tests.push({ name: check.name, status: "PASS" });
          } else {
            console.log(`   ‚ö†Ô∏è ${check.name}: Bo≈ü veya undefined`);
            results.data.fail++;
            results.data.tests.push({ name: check.name, status: "WARN" });
          }
        });

        // 4. ALGORƒ∞TMA KONTROL√ú
        console.log("\nü§ñ 4. ALGORƒ∞TMA KONTROL√ú:");

        if (typeof ScheduleAlgorithmV2 !== "undefined" && currentProgramData) {
          try {
            const testSettings = {
              maxIterations: 100,
              populationSize: 10,
              algorithms: {
                genetic: true,
                aco: true,
                sa: true,
                tabu: true,
                rl: true,
                fuzzy: true,
              },
            };

            const testInstance = new ScheduleAlgorithmV2(
              currentProgramData,
              testSettings,
              {}
            );

            const algorithmMethods = [
              "initialize",
              "solve",
              "runGeneticAlgorithm",
              "runAntColony",
              "runSimulatedAnnealing",
              "runTabuSearch",
              "runReinforcementLearning",
              "runFuzzyLogic",
              "calculateFitness",
              "isSlotAvailable",
              "generateInitialSolution",
              "prepareForSolve",
            ];

            algorithmMethods.forEach((method) => {
              if (typeof testInstance[method] === "function") {
                console.log(`   ‚úÖ ${method}()`);
                results.algorithms.pass++;
                results.algorithms.tests.push({ name: method, status: "PASS" });
              } else {
                console.log(`   ‚ùå ${method}() EKSƒ∞K!`);
                results.algorithms.fail++;
                results.algorithms.tests.push({ name: method, status: "FAIL" });
              }
            });

            // Mod√ºl durumunu kontrol et
            if (testInstance.debug && testInstance.debug.moduleStatus) {
              const moduleCount = Object.keys(
                testInstance.debug.moduleStatus
              ).length;
              console.log(`   üì¶ Y√ºkl√º mod√ºl sayƒ±sƒ±: ${moduleCount}`);
            }

            // Algoritma durumunu kontrol et
            if (testInstance.debug && testInstance.debug.algorithmStatus) {
              const algoCount = Object.keys(
                testInstance.debug.algorithmStatus
              ).length;
              console.log(`   ü§ñ Y√ºkl√º algoritma sayƒ±sƒ±: ${algoCount}`);
            }
          } catch (error) {
            console.log("   ‚ùå Instance olu≈üturma hatasƒ±:", error.message);
            results.algorithms.fail++;
          }
        } else {
          console.log("   ‚ö†Ô∏è Test i√ßin gerekli veriler eksik");
        }

        // √ñZET RAPOR
        console.log("\n" + "=".repeat(80));
        console.log("üìä TEST SONU√áLARI");
        console.log("=".repeat(80));

        const total = {
          pass:
            results.classes.pass +
            results.functions.pass +
            results.data.pass +
            results.algorithms.pass,
          fail:
            results.classes.fail +
            results.functions.fail +
            results.data.fail +
            results.algorithms.fail,
        };

        console.log(`\n‚úÖ BA≈ûARILI: ${total.pass}`);
        console.log(`‚ùå BA≈ûARISIZ: ${total.fail}`);
        console.log(`üìä TOPLAM: ${total.pass + total.fail}`);
        console.log(
          `‚≠ê BA≈ûARI ORANI: ${(
            (total.pass / (total.pass + total.fail)) *
            100
          ).toFixed(1)}%`
        );

        console.log("\nüìã DETAYLAR:");
        console.log(
          `   Classes: ‚úÖ${results.classes.pass} ‚ùå${results.classes.fail}`
        );
        console.log(
          `   Functions: ‚úÖ${results.functions.pass} ‚ùå${results.functions.fail}`
        );
        console.log(`   Data: ‚úÖ${results.data.pass} ‚ùå${results.data.fail}`);
        console.log(
          `   Algorithms: ‚úÖ${results.algorithms.pass} ‚ùå${results.algorithms.fail}`
        );

        // BA≈ûARISIZ TESTLER
        if (total.fail > 0) {
          console.log("\n‚ùå BA≈ûARISIZ TESTLER:");
          Object.values(results).forEach((category) => {
            category.tests
              .filter((t) => t.status === "FAIL")
              .forEach((test) => {
                console.log(`   ‚ùå ${test.name}`);
              });
          });
        }

        console.log("=".repeat(80) + "\n");

        return results;
      }

      function quickTest() {
        console.log("\nüß™ HIZLI TEST:");
        console.log(
          "   Class:",
          typeof ScheduleAlgorithmV2 !== "undefined" ? "‚úÖ" : "‚ùå"
        );
        console.log(
          "   collectSettings:",
          typeof collectSettings === "function" ? "‚úÖ" : "‚ùå"
        );
        console.log(
          "   createManualSolutions:",
          typeof createManualSolutions === "function" ? "‚úÖ" : "‚ùå"
        );
        console.log("   Data:", currentProgramData ? "‚úÖ" : "‚ùå");
        console.log("   Teachers:", currentProgramData?.teachers?.length || 0);
        console.log("   Classes:", currentProgramData?.classes?.length || 0);
        console.log("   Lessons:", currentProgramData?.lessons?.length || 0);
      }

      // Console'a ekle
      window.runCompleteSystemTest = runCompleteSystemTest;
      window.quickTest = quickTest;

      console.log("\n‚úÖ TEST FONKSƒ∞YONLARI HAZIR!");
      console.log("üí° Console'da √ßalƒ±≈ütƒ±r:");
      console.log("   ‚Ä¢ quickTest() - Hƒ±zlƒ± test");
      console.log("   ‚Ä¢ runCompleteSystemTest() - Komple test\n");
    </script>
  </body>
</html>
